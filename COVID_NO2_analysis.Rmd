---
title: "NO2 and COVID-19"
author: "Alana Schreibman"
date: "5/27/2021"
output: 
  html_document:
    toc: true
    toc_float: 
        collapsed: true
        smooth_scroll: true
    depth: 3 
    theme: cosmo
    highlight: pygments
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r, eval = TRUE}
#Load libraries needed. 
library(raster)
library(maptools)
library(ggplot2)
library(dplyr)
library(sp)
library(sf)
library(rgdal)
library(beanplot)
```

###Merging NO2 values for US with COVID data to make final data frame. 
```{r, eval = TRUE}
#Reading in US data from Earth Engine. 
continental.US.NO2 <- raster('continental_us.tif') %>%
  flip(direction='y')
plot(continental.US.NO2)

#Getting rectangle into data frame form for later use (will use inner_join to match coordinates from rectangle with NO2 concentrations from below).
rectangle <- rasterToPoints(continental.US.NO2) %>%
  as.data.frame() 
names(rectangle)[3] <- "NO2_Concentration"
rectangle

#Reading in shapefile and filtering for US only.
data(wrld_simpl)
plot(wrld_simpl) 
us.shp <- wrld_simpl[wrld_simpl$NAME=="United States", ]
plot(us.shp)

#More exploration on raster NO2 file. 
head(continental.US.NO2 )
dim(continental.US.NO2 )
plot(continental.US.NO2 )
plot(wrld_simpl[wrld_simpl$NAME=="United States", ], add = TRUE)
str(continental.US.NO2 )

#Extracting mean NO2 values for US and adding to coordinates data to make final data frame.
r.vals <- raster::extract(continental.US.NO2 , us.shp)
r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
final.df <- data.frame(us.shp@data, r.mean) 
names(final.df)[12] <- "NO2_Concentration"
names(final.df)[5] <- "location"
head(final.df)

#Merged geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
covid.NO2 <- merge(owid.filtered, final.df, by = "location")
```
###Reading in world satellite data. 
```{r, eval = TRUE}
#Reading in US data from Earth Engine: attempt at world file unsuccessful (too large?). 
world.NO2 <- raster('NO2_world.tif')
world.NO2 <- raster('NO2_world_earthengine_2021_06_17_14_15_02.tif')
str(world.NO2)
world.NO2.df <- rasterToPoints(world.NO2) %>%
  as.data.frame()
world.NO2.df
class(world.NO2)
head(world.NO2)
tail(world.NO2)
dim(world.NO2)
plot(world.NO2) #not showing all data points expected
plot(wrld_simpl, add = TRUE)
```

###Correlation analysis: United States, satellite vs. ground EPA. 
####Formatting sattelite and ground data. 
```{r, eval = TRUE}
#Getting satellite data specifically for this time frame. 
July_Oct2018.sat.r <- raster('US_NO2_2018-07-01_start.tif') %>%
  flip(direction='y')
July_Oct2018.sat.r <- crop(July_Oct2018.sat.r, extent(us.shp))
July_Oct2018.sat.r <- mask(July_Oct2018.sat.r, us.shp)
plot(July_Oct2018.sat.r)
plot(us.shp, add = TRUE)

#Getting rectangle into data frame for later comparison (will use inner_join to match coordinates from rectangle with NO2 concentrations from below). 
rectangle.sat <- rasterToPoints(July_Oct2018.sat.r) %>%
  as.data.frame()  
rectangle.sat <- rectangle.sat %>% 
  rename(c("longitude" = "x", "latitude" = "y")) 
names(rectangle.sat)[3] <- "NO2_Concentration"
rectangle.sat <- select(rectangle.sat, latitude, longitude, NO2_Concentration)
rectangle.sat

#Extracting NO2 values that overlap with US shapefile and using rectangle.sat to restore the coordinate data.  
sat.r.vals <- raster::extract(July_Oct2018.sat.r, us.shp)
NO2.sat.df <- as.data.frame(sat.r.vals, col.names = "NO2_Concentration")
July_Oct2018.sat<- inner_join(rectangle.sat, NO2.sat.df, by = "NO2_Concentration") %>%
  arrange(latitude) #Used later to compare satellite data to ground data. 
July_Oct2018.sat #Final satellite data to use for comparison to EPA data. 

#Selecting just latitude and longitude from data frame just made to use with Pargasite retrieval. 
US.lat.lon <- July_Oct2018.sat %>% select(c(latitude, longitude))
write.csv(US.lat.lon, file.path("US_ground_NO2", "US_lat_lon.csv"), row.names = FALSE) #Used to gather EPA data from Pargasite. 

#Reading in EPA data
#Problem w Pargasite: only overlapping time frame is July 2018 - October 2018 (Pargasite stops working in November 2018)
July_Oct2018.ground <- read.csv(file = './US_ground_NO2/July_Oct2018NO2.csv') %>% select(c("Latitude", "Longitude", "no2_estimate"))
July_Oct2018.ground #Final EPA data to use in comparison to satellite data. 

#EPA data frame changed to raster format.
library(sp)
library(rgdal)
coordinates(July_Oct2018.ground)=~Longitude+Latitude
proj4string(July_Oct2018.ground)=CRS("+init=epsg:4326") # set it to lat-long
July_Oct2018.ground.r = spTransform(July_Oct2018.ground,CRS("+init=epsg:4326"))
gridded(July_Oct2018.ground.r) = TRUE
July_Oct2018.ground.r = raster(July_Oct2018.ground.r)
projection(July_Oct2018.ground.r) = CRS("+init=epsg:4326")
plot(July_Oct2018.ground.r)
writeRaster(July_Oct2018.ground.r,"July_Oct2018.ground.r.tif") #Saves as geoTIFF file. 
```
####Checking for satellite data correlation to ground data.
```{r, eval = TRUE}
#Resampling raster data to be same size for comparisons. 
July_Oct2018.sat.r.re <- July_Oct2018.sat.r %>% resample(July_Oct2018.ground.r)
plot(July_Oct2018.sat.r.re)

#Perform correlation test between satellite and ground rasters. 
cor(values(July_Oct2018.sat.r.re),
    values(July_Oct2018.ground.r),
    use = "na.or.complete")

#Linear model estimation. 
lm1 <- lm(values(July_Oct2018.sat.r.re) ~ values(July_Oct2018.ground.r))
summary(lm1)

#Local correlation estimates--shows where locally on map specific regions are positively or negatively correlated. (Getting an error: code from this website https://statnmap.com/2018-01-27-spatial-correlation-between-rasters/)
values(July_Oct2018.sat.r.re) <- 1:ncell(July_Oct2018.sat.r.re)

matrix_ground <- values(July_Oct2018.ground.r)

focal_cor <- focal(
  x = July_Oct2018.sat.r.re,
  w = matrix(1, 5, 5),
  # fun = function(x, y = temp_chl_s){ # Original
    # cor(values(y)[x, 1], values(y)[x, 2], # Original
        # use = "na.or.complete")
  # },
  fun = function(x, y = matrix_ground){ # [MW]
    cor(y[x, 1], y[x, 2], # [MW]
        use = "na.or.complete")
  },
  filename = file.path("focal_cor.tif"),
  overwrite = TRUE
)
```

####Plotting satellite vs ground data. 
```{r, eval = TRUE}
ggplot() +
    geom_raster(data = July_Oct2018.sat , aes(x = longitude, y = latitude, fill = NO2_Concentration)) +
    scale_fill_viridis_c() +
    coord_quickmap()

ggplot() +
    geom_raster(data = July_Oct2018.ground , aes(x = Longitude, y =Latitude, fill = no2_estimate)) +
    scale_fill_viridis_c() +
    coord_quickmap()
```

###Correlation analysis: China, satellite vs. ground data. 
####Formatting sattelite and ground data to be used for correlation analysis (China only). 
```{r, eval = TRUE}
#No success in retrieving data so far. 

#Getting satellite data specifically for this time frame. 
July_Oct2018.sat.r <- raster('July2018-Oct2018.tif') %>%
  flip(direction='y')
July_Oct2018.sat.r <- crop(July_Oct2018.sat.r, extent(us.shp))
July_Oct2018.sat.r <- mask(July_Oct2018.sat.r, us.shp)
plot(July_Oct2018.sat.r)
plot(us.shp, add = TRUE)
```

###Time-analysis: NO2 changes during the COVID-19 pandemic.
####US time analysis. 
```{r, eval = TRUE}
#read in tif files
#get averages for all 6 date ranges
#get confidence intervals and use box and whiskers plot 

#Function for finding averages over each time period. 
US_NO2_average <- function(x) {
  r <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, us.shp)
  lapply(r.vals, FUN=median, na.rm = TRUE)
}
US_NO2_average("US_NO2_2019-03-19_start.tif")

#Boxplots: not sure why post-COVID is higher median in each case. Need to adjust for degrees of urbanization? 
US_2019_change <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(us.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(us.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  names(s) <- c('2019Jan-Mar', '2019Mar-May')
  boxplot(s, col=c('red', 'blue'), 
          main='NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('2020 Jan-Mar', '2020 Mar-May'))
}
US_2019_change("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif")

US_2020_change <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(us.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(us.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('2020 Jan-Mar', '2020 Mar-May'))
}
US_2020_change("US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif")

US_2021_change <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(us.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(us.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  names(s) <- c('2021Jan-Mar', '2021Mar-May')
  boxplot(s, col=c('red', 'blue'), 
          main='NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('2020 Jan-Mar', '2020 Mar-May'))
}
US_2021_change("US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")
```
