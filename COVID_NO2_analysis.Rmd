---
title: "NO2 and COVID-19"
author: "Alana Schreibman"
date: "5/27/2021"
output: 
  html_document:
    toc: true
    toc_float: 
        collapsed: true
        smooth_scroll: true
    depth: 3 
    theme: cosmo
    highlight: pygments
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r, eval = TRUE}
#Load libraries needed. 
library(easypackages)
libraries("rgdal", "gdalUtils", "raster", "maptools", "tigris", "ggplot2", "cowplot", "dplyr", "sp", "sf", "rgdal", "stringr", "RColorBrewer", "ggcorrplot", "pander", "forcats", "ggsn", "mapproj", "rlist")
```

###Merging NO2 data with COVID data for analysis.  
####United States data. (delete later, code generalized below)
```{r, eval = TRUE}
#Reading in US data from Earth Engine. 
continental.US.NO2.r <- raster('continental_us.tif') %>%
  flip(direction='y')
plot(continental.US.NO2.r)

#Reading in shapefile and filtering for US only.
data(wrld_simpl)
wrld_simpl@data[["NAME"]]
plot(wrld_simpl) 
us.shp <- wrld_simpl[wrld_simpl$NAME=="United States", ]
plot(us.shp)

#More exploration on raster NO2 file. 
head(continental.US.NO2.r)
dim(continental.US.NO2.r)
plot(continental.US.NO2.r)
plot(wrld_simpl[wrld_simpl$NAME=="United States", ], add = TRUE)
str(continental.US.NO2.r)

#Extracting mean NO2 values for US and adding to coordinates data to make final data frame.
r.vals <- raster::extract(continental.US.NO2.r, us.shp)
r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
final.df <- data.frame(us.shp@data, r.mean)  
rm(r.mean, r.vals)
names(final.df)[12] <- "NO2_Concentration"
names(final.df)[5] <- "location"
head(final.df)

#Merged geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
covid.NO2 <- merge(owid.filtered, final.df, by = "location")
```

####Formatting data for selected 10 countries. (delete later, code generalized below)
```{r, eval = TRUE}
#Reading in US data from Earth Engine. 
UnitedStates.NO2.r <- raster('./COVID_comparison/United States_NO2.tif') %>%
  flip(direction='y')
China.NO2.r <- raster('./COVID_comparison/China_NO2.tif') %>%
  flip(direction='y')
India.NO2.r <- raster('./COVID_comparison/India_NO2.tif') %>%
  flip(direction='y')
Italy.NO2.r <- raster('./COVID_comparison/Italy_NO2.tif') %>%
  flip(direction='y')
Brazil.NO2.r <- raster('./COVID_comparison/Brazil_NO2.tif') %>%
  flip(direction='y')
Peru.NO2.r <- raster('./COVID_comparison/Peru_NO2.tif') %>%
  flip(direction='y')
Israel.NO2.r <- raster('./COVID_comparison/Israel_NO2.tif') %>%
  flip(direction='y')
Argentina.NO2.r <- raster('./COVID_comparison/Argentina_NO2.tif') %>%
  flip(direction='y')
Russia.NO2.r <- raster('./COVID_comparison/Russia_NO2.tif') %>%
  flip(direction='y')
UnitedKingdom.NO2.r <- raster('./COVID_comparison/United Kingdom_NO2.tif') %>%
  flip(direction='y')
plot(Russia.NO2.r)
plot(Russia.shp, add = TRUE)
head(Russia.NO2.r)

#Shapefiles for 10 countries with high COVID cases. 
countries.shp.fxn <- function(x) {
  wrld_simpl[wrld_simpl$NAME==x, ]
}
for(i in c("United States", "China", "India", "Italy", "Brazil", "Peru", "Israel", "Argentina", "Russia", "United Kingdom")) {  
  assign(paste0(i, ".shp"), countries.shp.fxn(i)) 
}

#Extracting mean NO2 values and adding to coordinates data to make final data frame. Then, merge geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
mean.NO2.fxn <- function(raster, shp, country) {
  r.vals <- raster::extract(raster, shp)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(shp@data, r.mean)  
  names(final.df)[12] <- "NO2_Concentration" #Average NO2 concentration in mol/m^2 from July 10 2018 to July 10 2019. 
  names(final.df)[5] <- "location"
  final.df <- merge(owid.filtered, final.df, by = "location")
  assign(paste0(country, ".df"), final.df, .GlobalEnv)
}
mean.NO2.fxn(UnitedStates.NO2.r, `United States.shp`, "UnitedStates")
mean.NO2.fxn(China.NO2.r, `China.shp`, "China")
mean.NO2.fxn(India.NO2.r, `India.shp`, "India")
mean.NO2.fxn(Italy.NO2.r, `Italy.shp`, "Italy")
mean.NO2.fxn(Brazil.NO2.r, `Brazil.shp`, "Brazil")
mean.NO2.fxn(Peru.NO2.r, `Peru.shp`, "Peru")
mean.NO2.fxn(Israel.NO2.r, `Israel.shp`, "Israel")
mean.NO2.fxn(Argentina.NO2.r, `Argentina.shp`, "Argentina")
mean.NO2.fxn(Russia.NO2.r, `Russia.shp`, "Russia")
mean.NO2.fxn(UnitedKingdom.NO2.r, `United Kingdom.shp`, "UnitedKingdom")

COVID_NO2.df <- Reduce(function(...) merge(..., all=TRUE), list(UnitedStates.df, China.df, India.df, Italy.df, Brazil.df, Peru.df, Israel.df, Argentina.df, Russia.df, UnitedKingdom.df)) #Joins rows into one data frame. 

#Fix for loop later. 
for(i in c("UnitedStates.NO2.r", "China.NO2.r", "India.NO2.r", "Italy.NO2.r", "Brazil.NO2.r", "Peru.NO2.r", "Israel.NO2.r", "Argentina.NO2.r", "Russia.NO2.r", "UnitedKingdom.NO2.r")) { 
  for(j in c("United States.shp", "China.shp", "India.shp", "Italy.shp", "Brazil.shp", "Peru.shp", "Israel.shp", "Argentina.shp", "Russia.shp", "United Kingdom.shp")) {
    for (k in c("UnitedStates", "China", "India", "Italy", "Brazil", "Peru", "Israel", "Argentina", "Russia", "UnitedKingdom")) {
    print(mean.NO2.fxn(i, j, k))
    }
  }
}
```

####Analysis for selected 10 countries. (delete later, code generalized below)
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = COVID_NO2.df, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. NO2 Concentration") 
cor(COVID_NO2.df$totcases.mil, COVID_NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age, data = COVID_NO2.df)
summary.lm(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = COVID_NO2.df, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. NO2 Concentration") 
cor(COVID_NO2.df$totdeaths.mil, COVID_NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age, data = COVID_NO2.df)
summary.lm(NO2.lm.cases) #Summary statistics for linear fit. 

#look at correlations w other country characteristics 
```

###Creating mosaic of half-world raster files and reading in world satellite data. 
```{r, eval = TRUE}
setwd("./World_Rasters")
left <- raster('Left_Half_World_NO2.tif') %>%
  flip(direction='y') 
right <- raster('Right_Half_World_NO2.tif') %>%
  flip(direction='y') 
x <- list(left, right)
names(x)[1:2] <- c('x', 'y')
x$fun <- mean
x$na.rm <- TRUE

world.NO2.r <- do.call(mosaic, x)
rm(left, right, x)

#Converting to data frame for plotting. 
r.crop <- crop(world.NO2.r, extent(wrld_simpl))
r.crop <- mask(r.crop, wrld_simpl)
r.pts <- rasterToPoints(r.crop, spatial = TRUE)
world.NO2.df <- data.frame(r.pts)
rm(r.pts, r.crop)

myPalette <- colorRampPalette(brewer.pal(9, "YlOrRd")) 

my_theme <- function() {
  theme_minimal() +                                  # shorthand for white background color
  theme(axis.line = element_blank(),                 # further customization of theme components
        axis.text = element_blank(),                 # remove x and y axis text and labels
        axis.title = element_blank(),
        panel.grid = element_line(color = "white"),  # make grid lines invisible
        legend.key.size = unit(0.5, "cm"),           # increase size of legend
        legend.text = element_text(size = 7),       # increase legend text size
        legend.title = element_text(size = 7))      # increase legend title size
}

ggplot() +
 geom_raster(data = world.NO2.df, aes(x = x, y = y, fill = layer)) + 
 geom_polygon(data = wrld_simpl, aes(x = long, y = lat, group = group), colour = "black", size = 0.5, fill = NA) +
  my_theme() + 
  ggtitle("World NO2 Concentrations 07-10-2018 to 07-10-2019") +
  #scale_fill_manual(breaks = c(0, 0.0000025, 0.000005, 0.0000075, 0.00001, 0.00002)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(mol/m^2)", colours = myPalette(100))  +
    north(x.min = -180, y.min = -90, x.max = 180, y.max = 90, anchor = c(x=-140, y=-35), symbol=12) +
    scalebar(x.min = -180, y.min = -90, x.max = 180, y.max = 90, dist = 1000, dist_unit = 'km', transform = TRUE, anchor = c(x=-140, y=-60), st.size = 2, model = 'WGS84') +
  coord_equal()

#R base plots.
plot(world.NO2.r)
plot(wrld_simpl, add = TRUE)
```

####Preparing data for world analysis. 
```{r, eval = TRUE}
wrld_simpl@data$NAME <- as.character(wrld_simpl@data$NAME)

#Changing shapefile country names to match COVID dataset:
wrld_simpl@data$NAME[wrld_simpl$NAME=="Brunei Darussalam"] <- "Brunei"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Czech Republic"] <- "Czechia"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Democratic Republic of the Congo"] <- "Democratic Republic of Congo"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Faroe Islands"] <- "Faeroe Islands"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Iran (Islamic Republic of)"] <- "Iran"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Lao People's Democratic Republic"] <- "Laos"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Libyan Arab Jamahiriya"] <- "Libya"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Republic of Moldova"] <- "Moldova"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Burma"] <- "Myanmar"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Korea, Republic of"] <- "South Korea"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Korea, Democratic People's Republic of"] <- "North Korea"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Syrian Arab Republic"] <- "Syria"
wrld_simpl@data$NAME[wrld_simpl$NAME=="The former Yugoslav Republic of Macedonia"] <- "North Macedonia"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Macau"] <- "Macao"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Micronesia, Federated States of"] <- "Micronesia (country)"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Timor-Leste"] <- "Timor"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Holy See (Vatican City)"] <- "Vatican"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Viet Nam"] <- "Vietnam"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Wallis and Futuna Islands"] <- "Wallis and Futuna"

#Missing from shapefiles but in OWID data: Kosovo, Tanzania, Eswatini
owid.countries$location[!(owid.countries$location %in% wrld_simpl@data$NAME)]
#Missing from OWID data but in shapefiles: 
wrld_simpl@data$NAME[!(wrld_simpl@data$NAME%in% owid.countries$location)]

#Function to extract mean NO2 values by country shapefile. 
extraction.fxn <- function(x) {
  r.vals <- raster::extract(world.NO2.r, wrld_simpl[wrld_simpl$NAME==as.character(x), ])
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(wrld_simpl@data[wrld_simpl$NAME==as.character(x), ], r.mean)  
  rm(r.mean, r.vals)
  names(final.df)[5] <- "location" 
  names(final.df)[6] <- "Area" 
  names(final.df)[10] <- "Longitude" 
  names(final.df)[11] <- "Latitude" 
  names(final.df)[12] <- "NO2_Concentration"
  final.df <- final.df %>% dplyr::select(location, Area, Longitude, Latitude, NO2_Concentration)
}

#Extracting mean NO2 values and adding to coordinates data to make final data frame.
country.shp.list <- wrld_simpl@data$NAME
x <- country.shp.list
total.df <- purrr::map_dfr(x, extraction.fxn)

#Read in IHME regions data. 
IHME.regions.df <- read.csv(file = 'IHME_regions.csv', header = TRUE) 
IHME.regions.df <- IHME.regions.df %>% rename(location = Countries) %>% dplyr::select("Super.region", "Regions", "location")

#Merged geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
covid.NO2.df <- right_join(IHME.regions.df, total.df, by = "location")
covid.NO2.df <- full_join(covid.NO2.df, owid.countries, by = "location")
covid.NO2.df$Regions <- as.factor(covid.NO2.df$Regions)
covid.NO2.df$Super.region <- as.factor(covid.NO2.df$Super.region)
```

####Weighting by population by country for data frame. 
```{r, eval = TRUE}
#isolate country using extract and crop for both pop and NO2
#calculate product of population and pollution for each cell using overlay function 
#sum all of these products 
#divide this sum by tot pop for country from df

pop.den.r <- raster("gpw_v4_population_density/pop.density.tif") #Read in GPW v4 population raster data.  

pop.weighting.fxn <- function(x) {
  pop.cropped <- crop(pop.den.r, extent(wrld_simpl[wrld_simpl$NAME==as.character(x), ]))
  pop.cropped <- mask(pop.cropped, wrld_simpl[wrld_simpl$NAME==as.character(x), ])
  NO2.cropped <- crop(world.NO2.r, extent(wrld_simpl[wrld_simpl$NAME==as.character(x), ]))
  NO2.cropped <- mask(NO2.cropped, wrld_simpl[wrld_simpl$NAME==as.character(x), ])
  overlay.cropped <- overlay(pop.cropped, NO2.cropped, fun=function(x,y){(x*y)} )
  sum <- cellStats(overlay.cropped, stat='sum')
  mod.covid.df <- filter(covid.NO2.df, location == as.character(x))
  weighted.NO2 <- sum / mod.covid.df$population %>% data.frame()
  df <- wrld_simpl@data[wrld_simpl$NAME==as.character(x), ]
  weighted.NO2.df <- merge(df, weighted.NO2)
  names(weighted.NO2.df)[5] <- "location" 
  names(weighted.NO2.df)[12] <- "Population weighted NO2"
  weighted.NO2.df <- weighted.NO2.df %>% dplyr::select(location, `Population weighted NO2`)
} #Function to weight NO2 by population for each country. 
x <- country.shp.list[country.shp.list!="Antarctica"]

weighted.NO2.df <- purrr::map_dfr(x, pop.weighting.fxn)
weighted.covid.NO2.df <- full_join(covid.NO2.df, weighted.NO2.df, by = "location") #Join all data frames. 
```

####Plotting weighted data.
```{r, eval = TRUE}
wrld.df <- as.data.frame(wrld_simpl)
wrld.fort <- fortify(wrld_simpl, region = "NAME")
names(wrld.fort)[6] <- "location" #Getting world shapefile into data frame for ggplot. 

covid.NO2.plot.df <- full_join(wrld.fort, weighted.covid.NO2.df, by ="location")
arrange(covid.NO2.plot.df, order) #Joined full weighted COVID data set with shapefile data set. 

map <- ggplot(data = covid.NO2.plot.df, aes(x = long, y = lat, group = group))

map + 
  geom_polygon(aes(fill = NO2_Concentration), color = 'black', size = 0.1) +
  my_theme() + 
  ggtitle("World Raw NO2 Concentrations 07-10-2018 to 07-10-2019") +
  scale_fill_gradientn(name = "NO2 Concentration \n(mol/m^2)", colours = myPalette(100))  +
    north(x.min = -180, y.min = -90, x.max = 180, y.max = 90, anchor = c(x=-140, y=-35), symbol=12) +
    scalebar(covid.NO2.plot.df, dist = 1000, dist_unit = 'km', transform = TRUE, anchor = c(x=-140, y=-60), st.size = 4, model = 'WGS84') +
  coord_equal()
  #Plot of raw NO2 concentrations. 

map + 
  geom_polygon(aes(fill = `Population weighted NO2`), color = 'black', size = 0.1) +
  my_theme() + 
  ggtitle("World Weighted NO2 Concentrations 07-10-2018 to 07-10-2019") +
  scale_fill_gradientn(name = "Weighted NO2 \nConcentration", colours = myPalette(100))  +
    north(x.min = -180, y.min = -90, x.max = 180, y.max = 90, anchor = c(x=-140, y=-35), symbol=12) +
    scalebar(covid.NO2.plot.df, dist = 1000, dist_unit = 'km', transform = TRUE, anchor = c(x=-140, y=-60), st.size = 4, model = 'WGS84') +
  coord_equal() #Plot of population weighted NO2. 
```

####Urban areas only: preparing data. 
```{r, eval = TRUE}
world.sf <- st_read("world_maps/country_gen_trim.shp")  # Read shapefile as an sf object
class(world.sf)
head(world.sf)
world.geo <- st_geometry(world.sf)
urban.shp <- st_read("urban_shapefile/ne_10m_urban_areas_landscan.shp") # Read shapefile as an sf object
urban.shp <- st_geometry(urban.shp)
plot(urban.shp)
str(urban.shp)
```

####Univariate analysis of world NO2 concentrations. 
```{r, eval = TRUE}
#Statistics on world NO2 concentrations. 
covid.NO2.df %>%
    summarize(variable = "NO2_Concentration", mean_NO2 = mean(NO2_Concentration), st_dev_cty = sd(NO2_Concentration)) %>%
    pander

covid.NO2.df %>%
    summarize(variable = "NO2_Concentration",
              q0.2 = quantile(NO2_Concentration, 0.2),
              q0.4 = quantile(NO2_Concentration, 0.4),
              q0.6 = quantile(NO2_Concentration, 0.6),
              q0.8 = quantile(NO2_Concentration, 0.8)) %>%
    pander

#Histogram of NO2 concentrations.
covid.NO2.df %>%
    ggplot(aes(NO2_Concentration)) +
    geom_histogram(color = "black",fill = "grey") +
    geom_vline(xintercept = mean(covid.NO2.df$NO2_Concentration), lwd = 2) +
    labs(title = "Distribution of Tropospheric NO2",
         x = "NO2 Concentration (mol/m^2)",
         y = "Number of Countries") +
    theme_minimal() +
    scale_x_continuous(breaks = seq(0,8E-5,0.5E-5)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1))
```

####Univariate analysis of world COVID statistics. 
```{r, eval = TRUE}
#Statistics on world COVID case statistics. 
covid.NO2.df %>%
    summarize(variable = "totcases.mil", mean_cases = mean(totcases.mil), st_dev_cty = sd(totcases)) %>%
    pander

covid.NO2.df %>%
    summarize(variable = "totcases.mil",
              q0.2 = quantile(totcases.mil, 0.2, na.rm = TRUE),
              q0.4 = quantile(totcases.mil, 0.4, na.rm = TRUE),
              q0.6 = quantile(totcases.mil, 0.6, na.rm = TRUE),
              q0.8 = quantile(totcases.mil, 0.8, na.rm = TRUE)) %>%
    pander

#Histogram of COVID case statistics.
max(covid.NO2.df$totcases.mil, na.rm = TRUE)
covid.NO2.df %>%
    ggplot(aes(totcases.mil)) +
    geom_histogram(color = "black",fill = "grey") +
    geom_vline(xintercept = mean(covid.NO2.df$totcases.mil), lwd = 2) +
    labs(title = "Distribution of World COVID-19 Cases per Million",
         x = "Total COVID-19 Cases per Million",
         y = "Number of Countries") +
    theme_minimal() +
    scale_x_continuous(breaks = seq(0, 179667.4,10000)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1))

#Statistics on world COVID death statistics. 
covid.NO2.df %>%
    summarize(variable = "totdeaths.mil", mean_cases = mean(totcases.mil), st_dev_cty = sd(totcases)) %>%
    pander

covid.NO2.df %>%
    summarize(variable = "totdeaths.mil",
              q0.2 = quantile(totdeaths.mil, 0.2, na.rm = TRUE),
              q0.4 = quantile(totdeaths.mil, 0.4, na.rm = TRUE),
              q0.6 = quantile(totdeaths.mil, 0.6, na.rm = TRUE),
              q0.8 = quantile(totdeaths.mil, 0.8, na.rm = TRUE)) %>%
    pander

#Histogram of COVID statistics.
max(covid.NO2.df$totdeaths.mil, na.rm = TRUE)
covid.NO2.df %>%
    ggplot(aes(totdeaths.mil)) +
    geom_histogram(color = "black",fill = "grey") +
    geom_vline(xintercept = mean(covid.NO2.df$totdeaths.mil, na.rm = TRUE), lwd = 2) +
    labs(title = "Distribution of World COVID-19 Deaths per Million",
         x = "Total COVID-19 Deaths per Million",
         y = "Number of Countries") +
    theme_minimal() +
    scale_x_continuous(breaks = seq(0,5820.087,500)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1))
```

####Bivariate analysis of NO2 concentrations, COVID data, and categorical variables (continent divisions)
```{r, fig.width=5, fig.height=5,eval = TRUE}
#Summary statistics, NO2, grouping by Super.region
covid.NO2.df %>% 
  group_by(Super.region) %>%
  summarize(mean_NO2 = mean(NO2_Concentration, na.rm = TRUE), sd_NO2 = sd(NO2_Concentration, na.rm = TRUE)) %>%
  pander

#Summary statistics, COVID cases, grouping by Super.region
covid.NO2.df %>% 
  group_by(Super.region) %>%
  summarize(mean_cases.mil = mean(totcases.mil, na.rm = TRUE), sd_cases.mil = sd(totcases.mil, na.rm = TRUE)) %>%
  pander

#Summary statistics, COVID deaths, grouping by Super.region
covid.NO2.df %>% 
  group_by(Super.region) %>%
  summarize(mean_deaths.mil = mean(totdeaths.mil, na.rm = TRUE), sd_deaths.mil = sd(totdeaths.mil, na.rm = TRUE)) %>%
  pander

#Histogram, NO2, grouping by Super.region
covid.NO2.df %>%
    ggplot(aes(NO2_Concentration)) +
    geom_histogram(color = "black",fill = "grey") +
    labs(title = "Distribution of NO2 Concentrations Relative to Super Region",
         x = "NO2 Concentration (mol/m^2)",
         y = "Number of Countries") +
    theme_minimal() +
     scale_x_continuous(breaks = seq(0,8E-5,0.5E-5)) +
     scale_y_continuous(breaks = seq(0,12,2)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    facet_grid(Super.region~.)

#Histogram, COVID cases, grouping by Super.region
covid.NO2.df %>%
    ggplot(aes(totcases.mil)) +
    geom_histogram(color = "black",fill = "grey") +
    labs(title = "Distribution of COVID Cases Relative to Super Region",
         x = "COVID-19 Cases per Million",
         y = "Number of Countries") +
    theme_minimal() +
     scale_x_continuous(breaks = seq(0, 179667.4,10000)) +
     scale_y_continuous(breaks = seq(0,32,8)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    facet_grid(Super.region~.)

#Histogram, COVID deaths, grouping by Super.region
covid.NO2.df %>%
    ggplot(aes(totdeaths.mil)) +
    geom_histogram(color = "black",fill = "grey") +
    labs(title = "Distribution of COVID Deaths Relative to Super Region",
         x = "COVID-19 Deaths per Million",
         y = "Number of Countries") +
    theme_minimal() +
     scale_x_continuous(breaks = seq(0,5820.087,500)) +
     scale_y_continuous(breaks = seq(0,32,8)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    facet_grid(Super.region~.)

#Boxplot, NO2, grouping by Super.region 
covid.NO2.df %>%
    ggplot(aes(Super.region,NO2_Concentration)) +
    geom_boxplot() +
    geom_jitter(color="red", size=0.4, alpha=0.9) +
    labs(title = "Distribution of NO2 relative to Super Region",
         x = "Super Region",
         y = "NO2 Concentration (mol/m^2)") +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    scale_y_continuous(breaks = seq(0,8E-5,0.5E-5)) 

#Boxplot, COVID cases, grouping by Super.region 
covid.NO2.df %>%
    ggplot(aes(Super.region,totcases.mil)) +
    geom_boxplot() +
    geom_jitter(color="red", size=0.4, alpha=0.9) +
    labs(title = "Distribution of COVID Cases Relative to Super Region",
         x = "Super Region",
         y = "COVID-19 Cases per Million") +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    scale_y_continuous(breaks = seq(0, 179667.4,10000))

#Boxplot, COVID deaths, grouping by Super.region 
covid.NO2.df %>%
    ggplot(aes(Super.region,totdeaths.mil)) +
    geom_boxplot() +
    geom_jitter(color="red", size=0.4, alpha=0.9) +
    labs(title = "Distribution of COVID Deaths Relative to Super Region",
         x = "Super Region",
         y = "COVID-19 Deaths per Million") +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    scale_y_continuous(breaks = seq(0,5820.087,500))
```

####Bivariate analysis of NO2 concentrations and all continuous variables
```{r, eval = TRUE}
covid.NO2.df %>%
    select(NO2_Concentration, totcases.mil, totdeaths.mil, pop.density, med.age, card.death, diab.prev, fem.smokers, male.smokers) %>% 
    cor(use="pairwise.complete.obs") %>% 
    pander

#Visual representation of correlations.
covid.NO2.df %>%
    select(NO2_Concentration, totcases.mil, totdeaths.mil, pop.density, med.age, card.death, diab.prev, fem.smokers, male.smokers)  %>%
    cor(use="pairwise.complete.obs") %>%
    ggcorrplot(type = "lower", ggtheme = theme_minimal, colors = c("#6D9EC1","white","#E46726"),
               show.diag = T,
               lab = T, lab_size = 2, #shows correlation values and sets size of text
               title = "Correlation Matrix for the covid.NO2 dataset",
               legend.title = "Correlation Value",
               outline.color = "white",
               hc.order = T) #orders by variables most related
               
```

####Bivariate graphs of NO2 concentrations and COVID-19 outcomes.
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1, size = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totcases.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration, data = covid.NO2.df)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1, size = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totdeaths.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

regions.list <- c("High-income", "Latin America and Caribbean", "Sub-Saharan Africa", "North Africa and the Middle East", "South Asia", "Southeast Asia, East Asia, and Oceania", "Central Europe, Eastern Europe, and Central Asia")
sub.regions.list <- c("High-income Asia Pacific", "High-income Australasia", "High-income North America", "High-income Southern Latin America", "High-income Western Europe", "Caribbean", "Central Latin America", "Tropical Latin America", "Andean Latin America", "Central sub-Saharan Africa", "Eastern sub-Saharan Africa", "Southern sub-Saharan Africa", "Western sub-Saharan Africa", "North Africa and the Middle East", "South Asia", "East Asia", "Oceania", "Southeast Asia", "Central Asia", "Central Europe", "Eastern Europe")

#Function for bivariate analysis by region. 
cases.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    filter(!is.na(totdeaths.mil)) %>%
                    filter(!is.na(NO2_Concentration)) %>%
                    ggplot(aes(x = NO2_Concentration, y = totcases.mil)) +
                        geom_point(color = "#333aff", size = 1) +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (Regions = x), " vs. NO2 Concentration"))
} 
NO2.lm.cases <- function(x) {
                        covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        filter(!is.na(totdeaths.mil)) %>%
                        filter(!is.na(NO2_Concentration)) %>%
                        lm(totcases.mil ~ NO2_Concentration,.) %>%
                        summary.lm()  
} #Function for linear regression statistics to be included in for loop below. 

for (i in regions.list) {
   print(cases.NO2(i)) 
   print(NO2.lm.cases(i)) 
} #Loops function for continents of interest. 


deaths.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(Super.region == x) %>% 
                    filter(!is.na(totdeaths.mil)) %>%
                    filter(!is.na(NO2_Concentration)) %>%
                    ggplot(aes(x = NO2_Concentration, y = totdeaths.mil)) +
                        geom_point(color = "#333aff", size = 1) +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (Regions = x), " vs. NO2 Concentration"))
} 
NO2.lm.deaths <- function(x) {
                        covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        filter(!is.na(totdeaths.mil)) %>%
                        filter(!is.na(NO2_Concentration)) %>%
                        lm(totdeaths.mil ~ NO2_Concentration,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
for (i in regions.list) {
   print(deaths.NO2(i)) 
   print(NO2.lm.deaths(i)) 
} #Loops function for continents of interest.
```

####Bivariate graphs of population weighted NO2 concentrations and COVID-19 outcomes.
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = weighted.covid.NO2.df, aes(x = `Population weighted NO2`, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1, size = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "Weighted NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. Weighted NO2 Concentration") 
cor(weighted.covid.NO2.df$totcases.mil, weighted.covid.NO2.df$`Population weighted NO2`, use = "complete.obs")
NO2.lm.cases <- lm(totcases.mil ~ `Population weighted NO2`, data = weighted.covid.NO2.df)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = weighted.covid.NO2.df, aes(x = `Population weighted NO2`, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1, size = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "Weighted NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. Weighted NO2 Concentration") 
cor(weighted.covid.NO2.df$totdeaths.mil, weighted.covid.NO2.df$`Population weighted NO2`, use = "complete.obs")
NO2.lm.deaths <- lm(totdeaths.mil ~ `Population weighted NO2`, data = weighted.covid.NO2.df,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

regions.list <- c("High-income", "Latin America and Caribbean", "Sub-Saharan Africa", "North Africa and the Middle East", "South Asia", "Southeast Asia, East Asia, and Oceania", "Central Europe, Eastern Europe, and Central Asia")
sub.regions.list <- c("High-income Asia Pacific", "High-income Australasia", "High-income North America", "High-income Southern Latin America", "High-income Western Europe", "Caribbean", "Central Latin America", "Tropical Latin America", "Andean Latin America", "Central sub-Saharan Africa", "Eastern sub-Saharan Africa", "Southern sub-Saharan Africa", "Western sub-Saharan Africa", "North Africa and the Middle East", "South Asia", "East Asia", "Oceania", "Southeast Asia", "Central Asia", "Central Europe", "Eastern Europe")

#Function for bivariate analysis by region. 
cases.NO2.w <- function(x) { 
                    weighted.covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    filter(!is.na(totdeaths.mil)) %>%
                    filter(!is.na(`Population weighted NO2`)) %>%
                    ggplot(aes(x = `Population weighted NO2`, y = totcases.mil)) +
                        geom_point(color = "#333aff", size = 1) +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Weighted NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (Regions = x), " vs. Weighted NO2 Concentration"))
} 
NO2.lm.cases.w <- function(x) {
                        weighted.covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        filter(!is.na(totdeaths.mil)) %>%
                        filter(!is.na(`Population weighted NO2`)) %>%
                        lm(totcases.mil ~ `Population weighted NO2`,.) %>%
                        summary.lm()  
} #Function for linear regression statistics to be included in for loop below. 

for (i in regions.list) {
   print(cases.NO2.w(i)) 
   print(NO2.lm.cases.w(i)) 
} #Loops function for continents of interest. 


deaths.NO2.w <- function(x) { 
                    weighted.covid.NO2.df %>% 
                    filter(Super.region == x) %>% 
                    filter(!is.na(totdeaths.mil)) %>%
                    filter(!is.na(`Population weighted NO2`)) %>%
                    ggplot(aes(x = `Population weighted NO2`, y = totdeaths.mil)) +
                        geom_point(color = "#333aff", size = 1) +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Weighted NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (Regions = x), " vs. Weighted NO2 Concentration"))
} 
NO2.lm.deaths.w <- function(x) {
                        weighted.covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        filter(!is.na(totdeaths.mil)) %>%
                        filter(!is.na(`Population weighted NO2`)) %>%
                        lm(totdeaths.mil ~ `Population weighted NO2`,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
for (i in regions.list) {
   print(deaths.NO2.w(i)) 
   print(NO2.lm.deaths.w(i)) 
} #Loops function for continents of interest.
```


####Bivariate graphs of NO2 concentrations and other continuous variables.
```{r, eval = TRUE}
 #NO2 concentration vs population density. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = pop.density)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Population Density") +
  labs(title = "World Population Density vs. NO2 Concentration") 
cor(covid.NO2.df$pop.density, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.pop <- lm(pop.density ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.pop)
confint(NO2.lm.pop) #Summary statistics for linear fit. 

#NO2 concentration vs median age. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = med.age)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Median Age") +
  labs(title = "World Median Age by Country vs. NO2 Concentration") 
cor(covid.NO2.df$med.age, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.age <- lm(med.age ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.age)
confint(NO2.lm.age) #Summary statistics for linear fit.

#NO2 concentration vs GDP per capita. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = gdp.cap)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "GDP per Capita") +
  labs(title = "World GDP per Capita vs. NO2 Concentration") 
cor(covid.NO2.df$gdp.cap, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.gdp <- lm(gdp.cap ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.gdp)
confint(NO2.lm.gdp) #Summary statistics for linear fit.

#NO2 concentration vs cardiovascular death. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = card.death)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Cardiovascular Death Rates") +
  labs(title = "World Cardiovascular Death Rates vs. NO2 Concentration") 
cor(covid.NO2.df$card.death, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.card.death <- lm(card.death ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.card.death)
confint(NO2.lm.card.death) #Summary statistics for linear fit.

#NO2 concentration vs diabetes prevalence. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = diab.prev)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Diabetes Prevalence Rates") +
  labs(title = "World Diabetes Prevalence Rates vs. NO2 Concentration") 
cor(covid.NO2.df$diab.prev, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.diab <- lm(diab.prev ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.diab)
confint(NO2.lm.diab) #Summary statistics for linear fit.
```

####Multivariate graphs of COVID outcomes vs NO2 concentrations. 
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totcases.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age, data = covid.NO2.df)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totdeaths.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age, data = covid.NO2.df,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

#Function for multivariate analysis by Super.region. 
cases.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    ggplot(aes(x = NO2_Concentration, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (Super.region = x), " vs. NO2 Concentration"))
} 
NO2.lm.cases.reg <- function(x) {
                        covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        lm(totcases.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age,.) %>%
                        summary.lm()  
} #Function for linear regression statistics to be included in for loop below. 

for (i in regions.list) {
   print(cases.NO2(i)) 
   print(NO2.lm.cases.reg(i)) 
} #Loops function for continents of interest. 

deaths.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    ggplot(aes(x = NO2_Concentration, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (Super.region = x), " vs. NO2 Concentration"))
} 
NO2.lm.deaths.reg <- function(x) {
                        covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
for (i in regions.list) {
   print(deaths.NO2(i)) 
   print(NO2.lm.deaths.reg(i)) 
} #Loops function for continents of interest.
```

###Correlation analysis: United States, satellite vs. ground EPA. 
####Formatting sattelite and ground data. 
```{r, eval = TRUE}
#Getting satellite data specifically for this time frame. 
July_Oct2018.sat.r <- raster('US_ground_NO2/US_NO2_2018-07-01_start.tif') %>%
  flip(direction='y')
July_Oct2018.sat.r <- crop(July_Oct2018.sat.r, extent(`United States.shp`))
July_Oct2018.sat.r <- mask(July_Oct2018.sat.r, `United States.shp`)

#Direct conversion from NO2 raster to data frame while filtering by shapefile. 
continental.US.fxn <- function(x) {
  r1 <- raster(x) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  r1 <- mask(r1, `United States.shp`)
  r1 <- rasterToPoints(r1, spatial = TRUE) 
  July_Oct2018.sat <- data.frame(r1) %>% 
      select(!("optional")) %>%
      select( "y", "x", "US_NO2_2018.07.01_start")
  July_Oct2018.sat <- rename(July_Oct2018.sat, Latitude = y, Longitude = x, NO2_concentration = US_NO2_2018.07.01_start)
  assign("July_Oct2018.sat", July_Oct2018.sat, .GlobalEnv)
  July_Oct2018.sat
}  #Final satellite data to use for comparison to EPA data. 
continental.US.fxn("US_ground_NO2/US_NO2_2018-07-01_start.tif")

#Selecting just latitude and longitude from data frame just made to use with Pargasite retrieval. 
US.lat.lon <- July_Oct2018.sat %>% select(c(Latitude, Longitude))
# write.csv(US.lat.lon, file.path("US_ground_NO2", "US_lat_lon.csv"), row.names = FALSE) #Used to gather EPA data from Pargasite. 

#Reading in EPA data
#Problem w Pargasite: only overlapping time frame is July 2018 - October 2018 (Pargasite stops working in November 2018)
July_Oct2018.ground <- read.csv(file = './US_ground_NO2/July_Oct2018NO2.csv') %>% select(c("Latitude", "Longitude", "no2_estimate")) %>% rename(NO2_concentration = no2_estimate)
July_Oct2018.ground <- data.frame(July_Oct2018.ground)
July_Oct2018.ground #Final EPA data to use in comparison to satellite data. 

#EPA data frame changed to raster format.
July_Oct2018.ground.r <- July_Oct2018.ground %>% select(c("Longitude", "Latitude", "NO2_concentration")) %>% rasterFromXYZ() 
```

####Checking for satellite data correlation to ground data.
```{r, eval = TRUE}
#Resampling raster data to be same size for comparisons. 
July_Oct2018.sat.r.re <- July_Oct2018.sat.r %>% resample(July_Oct2018.ground.r)
plot(July_Oct2018.sat.r.re)

#Perform correlation test between satellite and ground rasters. 
cor(values(July_Oct2018.sat.r.re),
    values(July_Oct2018.ground.r),
    use = "na.or.complete")

#Linear model estimation. 
lm1 <- lm(values(July_Oct2018.sat.r.re) ~ values(July_Oct2018.ground.r))
summary(lm1)

#Local correlation estimates--shows where locally on map specific regions are positively or negatively correlated. (Getting an error: code from this website https://statnmap.com/2018-01-27-spatial-correlation-between-rasters/)
values(July_Oct2018.sat.r.re) <- 1:ncell(July_Oct2018.sat.r.re)

matrix_ground <- values(July_Oct2018.ground.r)

focal_cor <- focal(
  x = July_Oct2018.sat.r.re,
  w = matrix(1, 5, 5),
  # fun = function(x, y = temp_chl_s){ # Original
    # cor(values(y)[x, 1], values(y)[x, 2], # Original
        # use = "na.or.complete")
  # },
  fun = function(x, y = matrix_ground){ # [MW]
    cor(y[x, 1], y[x, 2], # [MW]
        use = "na.or.complete")
  },
  filename = file.path("focal_cor.tif"),
  overwrite = TRUE
)
```

####Plotting satellite vs ground data. 
```{r, eval = TRUE}
ggplot() +
 geom_raster(data = July_Oct2018.sat, aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
 geom_polygon(data = `United States.shp`, aes(x = long, y = lat, group = group), colour = "black", size = 0.5, fill = NA) +
  my_theme() + 
  ggtitle("NO2 US Satellite Data, July-Oct 2018") +
  #scale_fill_manual(breaks = c(0, 0.0000025, 0.000005, 0.0000075, 0.00001, 0.00002)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(mol/m^2)", colours = myPalette(100)) +
    north(x.min = -130, y.min = 23, x.max = -65, y.max = 49, anchor = c(x=-119, y=32), symbol=12) +
    scalebar(x.min = -130, y.min = 23, x.max = -65, y.max = 49, dist = 200, dist_unit = 'km', transform = TRUE, anchor = c(x=-120, y=27.5), st.size = 1.5, model = 'WGS84') +
  xlim(-130,-65) +
  ylim(23,49) +
  coord_quickmap()

ggplot() +
 geom_raster(data = July_Oct2018.ground, aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
 geom_polygon(data = `United States.shp`, aes(x = long, y = lat, group = group), colour = "black", size = 0.5, fill = NA) +
  my_theme() + 
  ggtitle("NO2 US EPA Ground Data, July-Oct 2018") +
  #scale_fill_manual(breaks = c(0, 0.0000025, 0.000005, 0.0000075, 0.00001, 0.00002)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(ppb)", colours = myPalette(100)) +
    north(x.min = -130, y.min = 23, x.max = -65, y.max = 49, anchor = c(x=-119, y=32), symbol=12) +
    scalebar(x.min = -130, y.min = 23, x.max = -65, y.max = 49, dist = 200, dist_unit = 'km', transform = TRUE, anchor = c(x=-120, y=27.5), st.size = 1.5, model = 'WGS84') +
  xlim(-130,-65) +
  ylim(23,49) +
  coord_quickmap()
```

###Correlation analysis: China, satellite vs. ground data. 
####Formatting sattelite and ground data to be used for correlation analysis (China only). 
```{r, eval = TRUE}
#No success in retrieving data so far. 

#Getting satellite data specifically for this time frame. 
July_Oct2018.sat.r <- raster('July2018-Oct2018.tif') %>%
  flip(direction='y')
July_Oct2018.sat.r <- crop(July_Oct2018.sat.r, extent(`United States.shp`))
July_Oct2018.sat.r <- mask(July_Oct2018.sat.r, `United States.shp`)
plot(July_Oct2018.sat.r)
plot(us.shp, add = TRUE)
```

####World Air Quality Data City Analysis: data preparation. 
```{r, eval = TRUE}
#Unsuccessful: cannot find shapefiles for the selected cities without ArcGIS access.
#Read in world AQI data for 6 cities. Dates range 12/30/19 to 4/5/20. 
waqi.main <- read.csv(file = 'waqi_NO2.csv', header = TRUE) 
seattle.df <- filter(waqi.main, City == "Seattle") 
  seattle.df$Date <- as.Date(seattle.df$Date, format = "%m/%d/%y")
  seattle.df <- arrange(seattle.df, Date)
wuhan.df <- filter(waqi.main, City == "Wuhan")
  wuhan.df$Date <- as.Date(wuhan.df$Date, format = "%m/%d/%y")
  wuhan.df <- arrange(wuhan.df, Date)
milan.df <- filter(waqi.main, City == "Milan")
  milan.df$Date <- as.Date(milan.df$Date, format = "%m/%d/%y")
  milan.df <- arrange(milan.df, Date)
london.df <- filter(waqi.main, City == "London")
  london.df$Date <- as.Date(london.df$Date, format = "%m/%d/%y")
  london.df <- arrange(london.df, Date)
saopaulo.df <- filter(waqi.main, City == "Sao Paulo") 
  saopaulo.df$Date <- as.Date(saopaulo.df$Date, format = "%m/%d/%y")
  saopaulo.df <- arrange(saopaulo.df, Date)
johannesburg.df <- filter(waqi.main, City == "Johannesburg") 
  johannesburg.df$Date <- as.Date(johannesburg.df$Date, format = "%m/%d/%y")
  johannesburg.df <- arrange(johannesburg.df, Date)

dates.2020.Q1 <- seq(as.Date("2019-12-30"), as.Date("2020-04-05"), by=7) #List of dates starting Dec 30th 2019. 
#Averaging NO2 data by the week. 
#Seattle
seattle.ground.fxn <- function(x) {
  date.filter <- subset(seattle.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  seattle.avg.df <- data.frame(mean)
  names(seattle.avg.df)[1] <- "Mean_NO2_Concentration"
  Week_start_date <- as.Date(dates.2020.Q1[[x]])
  Type <- rep("satellite", length.out = nrow(seattle.avg.df)) 
  seattle.ground.weekly <- cbind(Week_start_date, Type, seattle.avg.df) 
  seattle.ground.weekly <- seattle.ground.weekly %>% dplyr::select(Type, Week_start_date, Mean_NO2_Concentration)
}
x <- seq_along(dates.2020.Q1)
seattle.ground.weekly.df <- purrr::map_dfr(x, seattle.ground.fxn) 

#Wuhan
wuhan.ground.NO2.fxn <- function(x) {
  date.filter <- subset(wuhan.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  date.start <- as.Date(dates.2020.Q1[[x]])
  wuhan.avg.df <- data.frame(date.start, wuhan.df[1,3], mean)
  names(wuhan.avg.df)[1] <- "Week_start_date"
  names(wuhan.avg.df)[2] <- "City"
  names(wuhan.avg.df)[3] <- "Mean_of_Median_NO2"
  output <- wuhan.avg.df 
  return(output)
}
wuhan.ground.df <- purrr::map_dfr(x, wuhan.ground.NO2.fxn) 

#Milan
milan.ground.NO2.fxn <- function(x) {
  date.filter <- subset(milan.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  date.start <- as.Date(dates.2020.Q1[[x]])
  milan.avg.df <- data.frame(date.start, milan.df[1,3], mean)
  names(milan.avg.df)[1] <- "Week_start_date"
  names(milan.avg.df)[2] <- "City"
  names(milan.avg.df)[3] <- "Mean_of_Median_NO2"
  output <- milan.avg.df 
  return(output)
}
milan.ground.df <- purrr::map_dfr(x, milan.ground.NO2.fxn) 

#London
london.ground.fxn <- function(x) {
  date.filter <- subset(london.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  london.avg.df <- data.frame(mean)
  names(london.avg.df)[1] <- "Mean_NO2_Concentration"
  Week_start_date <- as.Date(dates.2020.Q1[[x]])
  Type <- rep("satellite", length.out = nrow(london.avg.df)) 
  london.ground.weekly <- cbind(Week_start_date, Type, london.avg.df) 
  london.ground.weekly <- london.ground.weekly %>% dplyr::select(Type, Week_start_date, Mean_NO2_Concentration)
}
x <- seq_along(dates.2020.Q1)
london.ground.weekly <- purrr::map_dfr(x, london.ground.fxn)

#Sao Paulo
saopaulo.ground.NO2.fxn <- function(x) {
  date.filter <- subset(saopaulo.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  date.start <- as.Date(dates.2020.Q1[[x]])
  saopaulo.avg.df <- data.frame(date.start, saopaulo.df[1,3], mean)
  names(saopaulo.avg.df)[1] <- "Week_start_date"
  names(saopaulo.avg.df)[2] <- "City"
  names(saopaulo.avg.df)[3] <- "Mean_of_Median_NO2"
  output <- saopaulo.avg.df 
  return(output)
}
saopaulo.ground.df <- purrr::map_dfr(x, saopaulo.ground.NO2.fxn) 

#Jonannesburg
jonannesburg.ground.NO2.fxn <- function(x) {
  date.filter <- subset(johannesburg.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  date.start <- as.Date(dates.2020.Q1[[x]])
  johannesburg.avg.df <- data.frame(date.start, johannesburg.df[1,3], mean)
  names(johannesburg.avg.df)[1] <- "Week_start_date"
  names(johannesburg.avg.df)[2] <- "City"
  names(johannesburg.avg.df)[3] <- "Mean_of_Median_NO2"
  output <- johannesburg.avg.df 
  return(output)
}
jonannesburg.ground.df <- purrr::map_dfr(x, jonannesburg.ground.NO2.fxn) 

#Retrieving satellite data:
#Used code:
#gsutil -m cp \
# >   "file names" \
# >   COVID-19_NO2/six_cities_ground_NO2

# in terminal to copy all files from google cloud storage into folders in working directory.

#Plan:
#get shapefiles for each city
#use shapefiles to filter satellite data for each city and make data frame equivalent to ground data per week
#make graphs for each comparing the two data sets

#Creates list of raster files from folder to call in function. 
seattle.rastlist <- list.files(path = "six_cities_ground_NO2/seattle", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Function to make data frame for weekly average NO2 concentration. 
seattle.sat.fxn <- function(x, y) {
  r <- raster(paste0("six_cities_ground_NO2/seattle/", x))  %>% flip(direction='y')  
  r.vals <- raster::extract(r, `seattle.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(`seattle.shp`@data, r.mean)  
  Week_start_date <- as.Date(dates.2020.Q1[[y]])
  Type <- rep(satellite, length.out = nrow(final.df)) 
  seattle.sat.weekly <- cbind(final.df, Date, Week, Type) 
  seattle.sat.weekly <- seattle.sat.weekly %>% dplyr::mutate(Date = as.factor(strftime(as.Date(Date, format="%Y-%m-%d"), format="%m-%d")))
  names(seattle.sat.weekly)[11] <- "Mean_NO2_Concentration"
  seattle.sat.weekly <- seattle.sat.weekly %>% select(Type, Date, Mean_NO2_Concentration)
}

x <- seattle.rastlist
y <- 1:length(dates.2020.Q1)
seattle.sat.weekly.df <- purrr::map2_dfr(x, y, seattle.sat.fxn) 
seattle.weekly.df <- rbind(seattle.sat.weekly.df, seattle.ground.weekly.df) 


london.rastlist <- list.files(path = "six_cities_ground_NO2/london", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

london.sat.fxn <- function(x, y) {
  r <- raster(paste0("six_cities_ground_NO2/london/", x))  %>% flip(direction='y')  
  r.vals <- raster::extract(r, `london.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(r.mean)  
  Week_start_date <- as.Date(dates.2020.Q1[[y]])
  Type <- rep("satellite", length.out = nrow(final.df)) 
  london.sat.weekly <- cbind(final.df, Week_start_date, Type) 
  names(london.sat.weekly)[1] <- "Mean_NO2_Concentration"
  london.sat.weekly <- london.sat.weekly %>% dplyr::select(Type, Week_start_date, Mean_NO2_Concentration)
}

x <- london.rastlist
y <- 1:length(dates.2020.Q1)
london.sat.weekly <- purrr::map2_dfr(x, y, london.sat.fxn) 
london.weekly.df <- rbind(london.sat.weekly,london.ground.weekly.df) 
```

####Reading in shapefiles for six cities analysis. 
```{r, eval = TRUE}
#Unsuccessful without ArcGIS access.
london.shp <- st_read("six_cities_shapefiles/london/ESRI/London_Borough_Excluding_MHW.shp")  # Read shapefile as an sf object
class(london.shp)
london.shp <- st_geometry(london.shp)
plot(london.shp)

seattle.shp <- st_read("six_cities_shapefiles/seattle/WA.shp")  # Read shapefile as an sf object
class(seattle.shp)
seattle.shp <- st_geometry(seattle.shp)
plot(seattle.shp)
```

###Time-analysis: NO2 changes during the COVID-19 pandemic.
####US time analysis: interrupted series time analysis data preparation. 
```{r, eval = TRUE}
#US first to create code; others later. 
#Use function in other NO2_Exploratory Analysis file to filter out each week from Jan-Dec 2019 and Jan-Dec 2020 for comparison.

#Used code:
# gsutil -m cp \
# >   "file names" \
# >   COVID-19_NO2/US_time_analysis_2020

# in terminal to copy all files from google cloud storage into folders in working directory. 

#2019 data. 
#Creates list of raster files from folder to call in function. 
rastlist.2019 <- list.files(path = "US_time_analysis_2019", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2019 <- seq(as.Date("2018-12-31"), as.Date("2019-12-29"), by=7) #List of dates starting Dec 31 2018. 

#Function to make data frame for weekly average NO2 concentration. 
read.fxn <- function(x, y) {
  r <- raster(paste0("US_time_analysis_2019/", x)) %>% flip(direction='y')  
  r.vals <- raster::extract(r, `United States.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(`United States.shp`@data, r.mean)  
  Date <- as.Date(dates.2019[[y]])
  Week <- paste0(as.character(as.Date(dates.2019[[y]])), " to ", as.character(as.Date(dates.2019[[y]]) + 6)) 
  Period <- rep(2019, length.out = nrow(final.df)) 
  US.2019.weekly <- cbind(final.df, Date, Week, Period) 
  US.2019.weekly <- US.2019.weekly %>% dplyr::mutate(Date = as.factor(strftime(as.Date(Date, format="%Y-%m-%d"), format="%m-%d")))
  rm(r.mean, r.vals)
  names(US.2019.weekly)[12] <- "NO2_Concentration"
  US.2019.weekly <- US.2019.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- rastlist.2019
y <- 1:length(dates.2019)
US.2019.weekly.df <- purrr::map2_dfr(x, y, read.fxn) 
US.2019.weekly.df$Date <- paste0("2020-", US.2019.weekly.df$Date)

#2020 data.  
#Creates list of raster files from folder to call in function. 
rastlist.2020 <- list.files(path = "US_time_analysis_2020", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2020 <- seq(as.Date("2019-12-30"), as.Date("2021-01-03"), by=7) #List of dates starting Dec 30th 2019. 

#Function to make data frame for weekly average NO2 concentration. 
read.fxn <- function(x, y) {
  r <- raster(paste0("US_time_analysis_2020/", x)) %>% flip(direction='y')  
  r.vals <- raster::extract(r, `United States.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(`United States.shp`@data, r.mean)   
  Date <- as.factor(as.Date(dates.2020[[y]]))
  Week <- paste0(as.character(as.Date(dates.2020[[y]])), " to ", as.character(as.Date(dates.2020[[y]]) + 6)) 
  Period <- rep(2020, length.out = nrow(final.df)) 
  US.2020.weekly <- cbind(final.df, Date, Week, Period)     # Add new column to data
  rm(r.mean, r.vals)
  names(US.2020.weekly)[12] <- "NO2_Concentration"
  US.2020.weekly <- US.2020.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- rastlist.2020
y <- 1:length(dates.2020)
US.2020.weekly.df <- purrr::map2_dfr(x, y, read.fxn) 
US.weekly.df <- rbind(US.2019.weekly.df, US.2020.weekly.df) 
US.weekly.df$Date <- as.Date(US.weekly.df$Date)
US.weekly.df$Period <- as.factor(US.weekly.df$Period)
```

####US time analysis: interrupted series time analysis plots.
```{r, fig.width=20, fig.height=4, eval = TRUE}
ggplot(US.weekly.df, aes(x = Date, y = NO2_Concentration, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme(legend.key.size = unit(1, 'cm'),
        legend.title = element_text(size=14),
        legend.text = element_text(size=10),
        axis.title=element_text(size = 20),
        axis.text.y=element_text(size=24),
        axis.text.x=element_text(size=30,angle=90, hjust=1)) +
  labs(fill = "Year of Measured Pollution") +
  ggtitle("US NO2 in 2019 vs 2020") +
  ylab("NO2 Concentration (mol/m^2)") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-25",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 3E-5) +
  
  #Pre-lockdown
  geom_rect(data=US.weekly.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-03-19",format="%Y-%m-%d"),ymin=2.9E-5,ymax=3E-5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=US.weekly.df,aes(x=as.Date("2020-02-07"),y=2.95E-5),label="Pre-Lockdown",color = "black", size = 2) +
  geom_vline(data=US.weekly.df,xintercept = as.Date("2020-03-19",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=US.weekly.df,aes(xmin=as.Date("2020-03-19",format="%Y-%m-%d"),xmax=as.Date("2020-06-05",format="%Y-%m-%d"),ymin=2.9E-5,ymax=3E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=US.weekly.df,aes(x=as.Date("2020-05-01"),y=2.95E-5),label="Lockdown 1", color = "black", size = 2) +
  geom_vline(data=US.weekly.df,xintercept=as.Date("2020-06-05",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=US.weekly.df,aes(xmin=as.Date("2020-06-05",format="%Y-%m-%d"),xmax=as.Date("2020-11-16",format="%Y-%m-%d"), ymin=2.9E-5,ymax=3E-5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=US.weekly.df,aes(x=as.Date("2020-08-15"),y=2.95E-5),label="Re-Opening", color = "black", size = 2) +
  geom_vline(data=US.weekly.df,xintercept=as.Date("2020-11-16",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 2
  geom_rect(data=US.weekly.df,aes(xmin=as.Date("2020-11-16",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"), ymin=2.9E-5,ymax=3E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=US.weekly.df,aes(x=as.Date("2020-12-10"),y=2.95E-5),label="Lockdown 2", color = "black", size = 2) +
  theme_bw() + 
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("US_time_series.pdf")
`United States.shp`
```

####China time analysis: interrupted series time analysis data preparation. 
```{r, eval = TRUE}
#Use function in other NO2_Exploratory Analysis file to filter out each week from Jan-Dec 2019 and Jan-Dec 2020 for comparison.

#Used code:
# gsutil -m cp \
# >   "file names" \
# >   COVID-19_NO2/China_time_analysis_2020

# in terminal to copy all files from google cloud storage into folders in working directory. 

#2019 data. 
#Creates list of raster files from folder to call in function. 
rastlist.2019 <- list.files(path = "China_time_analysis_2019", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2019 <- seq(as.Date("2018-11-05"), as.Date("2019-11-10"), by=7) #List of dates starting Dec 31 2018. 

#Function to make data frame for weekly average NO2 concentration. 
read.fxn <- function(x, y) {
  r <- raster(paste0("China_time_analysis_2019/", x)) %>% flip(direction='y')  
  r.vals <- raster::extract(r, `China.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(`China.shp`@data, r.mean)  
  Date <- as.factor(as.Date(dates.2019[[y]] %m+% years(1))) #Adds 1 year to date to match x axis of 2020 dates.
  Week <- paste0(as.character(as.Date(dates.2019[[y]])), " to ", as.character(as.Date(dates.2019[[y]]) + 6)) 
  Period <- rep("2018-2019", length.out = nrow(final.df)) 
  China.2019.weekly <- cbind(final.df, Date, Week, Period) 
  rm(r.mean, r.vals)
  names(China.2019.weekly)[12] <- "NO2_Concentration"
  China.2019.weekly <- China.2019.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- rastlist.2019
y <- 1:length(dates.2019)
China.2019.weekly.df <- purrr::map2_dfr(x, y, read.fxn) 
China.2019.weekly.df$Date <- paste0("2020-", China.2019.weekly.df$Date)

#2020 data.  
#Creates list of raster files from folder to call in function. 
rastlist.2020 <- list.files(path = "China_time_analysis_2020", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2020 <- seq(as.Date("2019-11-04"), as.Date("2020-11-08"), by=7) #List of dates starting Dec 30th 2019. 

#Function to make data frame for weekly average NO2 concentration. 
read.fxn <- function(x, y) {
  r <- raster(paste0("China_time_analysis_2020/", x)) %>% flip(direction='y')  
  r.vals <- raster::extract(r, `China.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(`China.shp`@data, r.mean)   
  Date <- as.factor(as.Date(dates.2020[[y]]))
  Week <- paste0(as.character(as.Date(dates.2020[[y]])), " to ", as.character(as.Date(dates.2020[[y]]) + 6)) 
  Period <- rep("2019-2020", length.out = nrow(final.df)) 
  China.2020.weekly <- cbind(final.df, Date, Week, Period)     # Add new column to data
  rm(r.mean, r.vals)
  names(China.2020.weekly)[12] <- "NO2_Concentration"
  China.2020.weekly <- China.2020.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- rastlist.2020
y <- 1:length(dates.2020)
China.2020.weekly.df <- purrr::map2_dfr(x, y, read.fxn) 
China.weekly.df <- rbind(China.2019.weekly.df, China.2020.weekly.df) 
China.weekly.df$Date <- as.Date(China.weekly.df$Date)
China.weekly.df$Period <- as.factor(China.weekly.df$Period)
max(China.weekly.df$NO2_Concentration)
```

####China time analysis: interrupted series time analysis plots.
```{r, fig.width=20, fig.height=4, eval = TRUE}
ggplot(China.weekly.df, aes(x = Date, y = NO2_Concentration, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  labs(fill = "Year of Measured Pollution") +
  ggtitle("China NO2 in 2019 vs 2020") +
  ylab("NO2 Concentration (mol/m^2)") +
  scale_x_date(date_labels = "%b-%Y",date_breaks = "1 month",limits=c(as.Date("2019-11-01",format="%Y-%m-%d"),as.Date("2020-11-10",format="%Y-%m-%d"))) +
ylim(0,4.7E-5) +
  theme_bw() +
  theme(legend.key.size = unit(1, 'cm'),
        legend.title = element_text(size=12),
        legend.text = element_text(size=10),
        axis.title = element_text(size = 10),
        axis.text.x = element_text(size=10, angle=45, hjust=1),
        axis.text.y = element_text(size=10)) +
  
  #Pre-lockdown
  geom_rect(data=China.weekly.df,aes(xmin=as.Date("2019-11-01",format="%Y-%m-%d"),xmax=as.Date("2020-01-23",format="%Y-%m-%d"),ymin=4.6E-5,ymax=4.7E-5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=China.weekly.df,aes(x=as.Date("2019-12-15"),y=4.65E-5),label="Pre-Lockdown",color = "black", size = 2) +
  geom_vline(data=China.weekly.df,xintercept = as.Date("2020-01-23",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=China.weekly.df,aes(xmin=as.Date("2020-01-23",format="%Y-%m-%d"),xmax=as.Date("2020-04-08",format="%Y-%m-%d"),ymin=4.6E-5,ymax=4.7E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=China.weekly.df,aes(x=as.Date("2020-03-01"),y=4.65E-5),label="Lockdown 1", color = "black", size = 2) +
  geom_vline(data=China.weekly.df,xintercept=as.Date("2020-04-08",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=China.weekly.df,aes(xmin=as.Date("2020-04-08",format="%Y-%m-%d"),xmax=as.Date("2020-11-08",format="%Y-%m-%d"), ymin=4.6E-5,ymax=4.7E-5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=China.weekly.df,aes(x=as.Date("2020-08-01"),y=4.65E-5),label="Re-Opening", color = "black", size = 2) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("China_time_series.pdf")
```

####Attempt to do interrupted time series analysis with all world data. 
```{r, eval = TRUE}
#Use function in other NO2_Exploratory Analysis file to filter out each week from Jan-Dec 2019 and Jan-Dec 2020 for comparison. Unsuccessful so far: need to remove country boundaries from shapefile. 

#Used code:
#gsutil -m cp \
# >   "file names" \
# >   COVID-19_NO2/time_analysis_2020

# in terminal to copy all files from google cloud storage into folders in working directory. 

#2019 data. 
#Creates list of raster files from folder to call in function. 
rastlist.2019.left <- list.files(path = "time_analysis_2019_left", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)
rastlist.2019.right <- list.files(path = "time_analysis_2019_right", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2019 <- seq(as.Date("2018-12-31"), as.Date("2019-12-29"), by=7) #List of dates starting Dec 31 2018. 

#Function to make data frame for weekly average NO2 concentration. 
read.fxn <- function(x1, x2, y) {
  left <- raster(paste0("time_analysis_2019_left/", x1)) %>%
    flip(direction='y') 
  right <- raster(paste0("time_analysis_2019_right/", x2)) %>%
    flip(direction='y') 
  x <- list(left, right)
  names(x)[1:2] <- c('x', 'y')
  x$fun <- mean
  x$na.rm <- TRUE
  world.NO2.r <- do.call(mosaic, x) %>% flip(direction='y')   #Combines left and right halves of world raster. 
  r.vals <- raster::extract(world.NO2.r, wrld_simpl) 
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(wrld_simpl@data, r.mean)  
  Date <- as.Date(dates.2019[[y]])
  Week <- paste0(as.character(as.Date(dates.2019[[y]])), " to ", as.character(as.Date(dates.2019[[y]]) + 6)) 
  Period <- rep(2019, length.out = nrow(final.df)) 
  world.2019.weekly <- cbind(final.df, Date, Week, Period) 
  world.2019.weekly <- world.2019.weekly %>% dplyr::mutate(Date = as.factor(strftime(as.Date(Date, format="%Y-%m-%d"), format="%m-%d")))
  rm(r.mean, r.vals)
  names(world.2019.weekly)[12] <- "NO2_Concentration"
  world.2019.weekly <- world.2019.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x1 <- rastlist.2019.left
x2 <- rastlist.2019.right
y <- 1:length(dates.2019)
world.2019.weekly.df <- purrr::map2_dfr(x1, x2, y, read.fxn) 
world.2019.weekly.df$Date <- paste0("2020-", world.2019.weekly.df$Date)

#2020 data.  
#Creates list of raster files from folder to call in function. 
rastlist.2020.left <- list.files(path = "time_analysis_2020_left", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)
rastlist.2020.right <- list.files(path = "time_analysis_2020_right", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2020 <- seq(as.Date("2019-12-30"), as.Date("2021-01-03"), by=7) #List of dates starting Dec 30th 2019. 

#Function to make data frame for weekly average NO2 concentration. 
read.fxn <- function(x1, x2, y) {
  left <- raster(paste0("time_analysis_2020_left/", x1)) %>%
    flip(direction='y') 
  right <- raster(paste0("time_analysis_2020_right/", x2)) %>%
    flip(direction='y') 
  x <- list(left, right)
  names(x)[1:2] <- c('x', 'y')
  x$fun <- mean
  x$na.rm <- TRUE
  world.NO2.r <- do.call(mosaic, x) %>% flip(direction='y')  #Combines left and right halves of world raster. 
  r.vals <- raster::extract(r, wlrd_simpl)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(wrld_simpl@data, r.mean)   
  Date <- as.factor(as.Date(dates.2020[[y]]))
  Week <- paste0(as.character(as.Date(dates.2020[[y]])), " to ", as.character(as.Date(dates.2020[[y]]) + 6)) 
  Period <- rep(2020, length.out = nrow(final.df)) 
  world.2020.weekly <- cbind(final.df, Date, Week, Period)     # Add new column to data
  rm(r.mean, r.vals)
  names(world.2020.weekly)[12] <- "NO2_Concentration"
  world.2020.weekly <- world.2020.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x1 <- rastlist.2020.left
x2 <- rastlist.2020.right
y <- 1:length(dates.2020)
world.2020.weekly.df <- purrr::map2_dfr(x1, x2, y, read.fxn) 
world.weekly.df <- rbind(world.2019.weekly.df, world.2020.weekly.df) 
world.weekly.df$Date <- as.Date(world.weekly.df$Date)
world.weekly.df$Period <- as.factor(world.weekly.df$Period)
```

####Attempt to do interrupted time series analysis plots with all world data. 
```{r, fig.width=20, fig.height=4, eval = TRUE}
ggplot(world.weekly.df, aes(x = Date, y = NO2_Concentration, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme(legend.key.size = unit(1, 'cm'),
        legend.title = element_text(size=14),
        legend.text = element_text(size=10),
        axis.title=element_text(size = 20),
        axis.text.y=element_text(size=24),
        axis.text.x=element_text(size=30,angle=90, hjust=1)) +
  labs(fill = "Year of Measured Pollution") +
  ggtitle("World NO2 in 2019 vs 2020") +
  ylab("NO2 Concentration (mol/m^2)") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-25",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 3E-5) +
  
  #Pre-lockdown
  geom_rect(data=world.weekly.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-03-19",format="%Y-%m-%d"),ymin=2.9E-5,ymax=3E-5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=world.weekly.df,aes(x=as.Date("2020-02-07"),y=2.95E-5),label="Pre-Lockdown",color = "black", size = 2) +
  geom_vline(data=world.weekly.df,xintercept = as.Date("2020-03-19",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=world.weekly.df,aes(xmin=as.Date("2020-03-19",format="%Y-%m-%d"),xmax=as.Date("2020-06-05",format="%Y-%m-%d"),ymin=2.9E-5,ymax=3E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=world.weekly.df,aes(x=as.Date("2020-05-01"),y=2.95E-5),label="Lockdown 1", color = "black", size = 2) +
  geom_vline(data=world.weekly.df,xintercept=as.Date("2020-06-05",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=world.weekly.df,aes(xmin=as.Date("2020-06-05",format="%Y-%m-%d"),xmax=as.Date("2020-11-16",format="%Y-%m-%d"), ymin=2.9E-5,ymax=3E-5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=world.weekly.df,aes(x=as.Date("2020-08-15"),y=2.95E-5),label="Re-Opening", color = "black", size = 2) +
  geom_vline(data=world.weekly.df,xintercept=as.Date("2020-11-16",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 2
  geom_rect(data=world.weekly.df,aes(xmin=as.Date("2020-11-16",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"), ymin=2.9E-5,ymax=3E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=world.weekly.df,aes(x=as.Date("2020-12-10"),y=2.95E-5),label="Lockdown 2", color = "black", size = 2) +
  theme_bw() + 
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("time_series.pdf")
```

####US time analysis plots. 
```{r, eval = TRUE}
#Converting before lockdown and after lockdown rasters for US to data frames.  
before.lockdown <- raster('./US_NO2_comparison/US_NO2_2020-01-19_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
before.lockdown <- before.lockdown %>%
  rename(c(NO2_concentration = US_NO2_2020.01.19_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

after.lockdown <- raster('./US_NO2_comparison/US_NO2_2020-03-19_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
after.lockdown <- after.lockdown %>%
  rename(c(NO2_concentration = US_NO2_2020.03.19_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

#Plotting before and after maps. 
p1 <- ggplot() +
  geom_raster(data = before.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = `United States.shp`, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap(
    xlim = c(-123, -65),
    ylim = c(23, 49)
  ) + 
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.00015)) +
  ggtitle("US NO2 Concentrations (Sentinel Satellite) Before COVID-19 Lockdown")
  
p2 <- ggplot() +
  geom_raster(data = after.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = `United States.shp`, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap(
    xlim = c(-123, -65),
    ylim = c(23, 49)
  ) + 
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.00015)) +
  ggtitle("US NO2 Concentrations (Sentinel Satellite) After COVID-19 Lockdown")

plot_grid(p1, p2, labels = "AUTO", ncol = 1)
rm(p1, p2)
```

####US time analysis (violin plots).
```{r, eval = TRUE}
#Function for finding medians over each time period. 
US_NO2_median <- function(x) {
  r <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, `United States.shp`)
  lapply(r.vals, FUN=median, na.rm = TRUE)
}
US_NO2_median("US_NO2_2020-01-19_start.tif")
US_NO2_median("US_NO2_2020-03-19_start.tif")

#Function for finding averages over each time period. 
US_NO2_average <- function(x) {
  r <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, `United States.shp`)
  lapply(r.vals, FUN=mean, na.rm = TRUE)
}
US_NO2_average("US_NO2_2020-01-19_start.tif")
US_NO2_average("US_NO2_2020-03-19_start.tif")

#2019 violin plot
US_2019_violin <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_2019_violin("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif")

#2020 violin plot
US_2020_violin <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2020", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2 Before and After COVID-19') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_2020_violin("US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif")

#2021 violin plot
US_2021_violin <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(us.shp))
  mask(r2, us.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2021", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2: 2021 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_2021_violin("US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")

#All violin plots in 1 graph:
US_violin <- function(a, b, c, d, e, f) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (a))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (b))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  r3 <- raster(paste0("./US_NO2_Comparison/", (c))) %>% flip(direction='y')
  r3 <- crop(r3, extent(`United States.shp`))
  mask(r3, `United States.shp`)
  r3 <- r3 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r3)) %>% as.data.frame()
  r3 <- cbind(vec, r3)
  names(r3)[1] <- "Timeframe"
  names(r3)[4] <- "NO2_Concentration"
  r4 <- raster(paste0("./US_NO2_Comparison/", (d))) %>% flip(direction='y')
  r4 <- crop(r4, extent(`United States.shp`))
  mask(r4, `United States.shp`)
  r4 <- r4 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2020", length.out = nrow(r4)) %>% as.data.frame()
  r4 <- cbind(vec, r4)
  names(r4)[1] <- "Timeframe"
  names(r4)[4] <- "NO2_Concentration"
  r5 <- raster(paste0("./US_NO2_Comparison/", (e))) %>% flip(direction='y')
  r5 <- crop(r5, extent(`United States.shp`))
  mask(r5, `United States.shp`)
  r5 <- r5 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r5)) %>% as.data.frame()
  r5 <- cbind(vec, r5)
  names(r5)[1] <- "Timeframe"
  names(r5)[4] <- "NO2_Concentration"
  r6 <- raster(paste0("./US_NO2_Comparison/", (f))) %>% flip(direction='y')
  r6 <- crop(r6, extent(`United States.shp`))
  mask(r6, `United States.shp`)
  r6 <- r6 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2021", length.out = nrow(r6)) %>% as.data.frame()
  r6 <- cbind(vec, r6)
  names(r6)[1] <- "Timeframe"
  names(r6)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2, r3, r4, r5, r6)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    theme(axis.text.x = element_text(angle = 45)) +
    scale_x_discrete(limits=c("Jan-March 2019", "March-May 2019", "Jan-March 2020", "March-May 2020", "Jan-March 2021", "March-May 2021")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_violin("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif", "US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif", "US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")
```

####US time analysis (box plots).
```{r, eval = TRUE}
US_2019_boxplot <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2: 2019 Seasonal Change', 
          ylab='Date',
          names = c('2019 Jan-Mar', '2019 Mar-May'))
}
US_2019_boxplot("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif")

US_2020_boxplot <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('2020 Jan-Mar', '2020 Mar-May'))
}
US_2020_boxplot("US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif")

US_2021_boxplot <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2: 2021 Seasonal Change', 
          ylab='Date',
          names = c('2021 Jan-Mar', '2021 Mar-May'))
}
US_2021_boxplot("US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")
```

####China time analysis plots. 
```{r, eval = TRUE}
China.shp <- wrld_simpl[wrld_simpl$NAME=="China", ]

#Converting before lockdown and after lockdown rasters for US to data frames.  
before.lockdown <- raster('./China_NO2_comparison/China_NO2_2019-11-23_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
before.lockdown <- before.lockdown %>%
  rename(c(NO2_concentration = China_NO2_2019.11.23_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

after.lockdown <- raster('./China_NO2_comparison/China_NO2_2020-01-23_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
after.lockdown <- after.lockdown %>%
  rename(c(NO2_concentration = China_NO2_2020.01.23_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

#Plotting before and after maps. 
p1 <- ggplot() +
  geom_raster(data = before.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = China.shp, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap() +
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.0005)) +
  ggtitle("China NO2 Concentrations (Sentinel Satellite) Before COVID-19 Lockdown")
  
p2 <- ggplot() +
  geom_raster(data = after.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = China.shp, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap() +
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.0005)) +
  ggtitle("China NO2 Concentrations (Sentinel Satellite) After COVID-19 Lockdown")

plot_grid(p1, p2, labels = "AUTO", ncol = 1)
rm(p1, p2)
```

####China time analysis (violin).
```{r, eval = TRUE}
#Function for finding medians over each time period. 
China_NO2_median <- function(x) {
  r <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, China.shp)
  lapply(r.vals, FUN=median, na.rm = TRUE)
}
China_NO2_median("China_NO2_2019-11-23_start.tif")
China_NO2_median("China_NO2_2020-01-23_start.tif")

#Function for finding averages over each time period. 
China_NO2_average <- function(x) {
  r <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, China.shp)
  lapply(r.vals, FUN=mean, na.rm = TRUE)
}
China_NO2_average("China_NO2_2019-11-23_start.tif")
China_NO2_average("China_NO2_2020-01-23_start.tif") 

#2019 violin plot
China_2019_violin <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, China.shp)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2018-Jan2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, China.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    scale_x_discrete(limits=c("Nov2018-Jan2019", "Jan-March 2019")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_2019_violin("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif")

#2020 violin plot
China_2020_violin <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, China.shp)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2019-Jan2020", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, China.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2 Before and After COVID-19') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    scale_x_discrete(limits=c("Nov2019-Jan2020", "Jan-March 2020")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_2020_violin("China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif")

#2021 violin plot
China_2021_violin <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, China.shp)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2020-Jan2021", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, China.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2: 2021 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    scale_x_discrete(limits=c("Nov2020-Jan2021", "Jan-March 2021")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_2021_violin("China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")

#All violin plots in 1 graph: 
China_violin <- function(a, b, c, d, e, f) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (a))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, China.shp)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2018-Jan2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (b))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, China.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  r3 <- raster(paste0("./China_NO2_Comparison/", (c))) %>% flip(direction='y')
  r3 <- crop(r3, extent(China.shp))
  mask(r3, China.shp)
  r3 <- r3 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2019-Jan2020", length.out = nrow(r3)) %>% as.data.frame()
  r3 <- cbind(vec, r3)
  names(r3)[1] <- "Timeframe"
  names(r3)[4] <- "NO2_Concentration"
  r4 <- raster(paste0("./China_NO2_Comparison/", (d))) %>% flip(direction='y')
  r4 <- crop(r4, extent(China.shp))
  mask(r4, China.shp)
  r4 <- r4 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r4)) %>% as.data.frame()
  r4 <- cbind(vec, r4)
  names(r4)[1] <- "Timeframe"
  names(r4)[4] <- "NO2_Concentration"
  r5 <- raster(paste0("./China_NO2_Comparison/", (e))) %>% flip(direction='y')
  r5 <- crop(r5, extent(China.shp))
  mask(r5, China.shp)
  r5 <- r5 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2020-Jan2021", length.out = nrow(r5)) %>% as.data.frame()
  r5 <- cbind(vec, r5)
  names(r5)[1] <- "Timeframe"
  names(r5)[4] <- "NO2_Concentration"
  r6 <- raster(paste0("./China_NO2_Comparison/", (f))) %>% flip(direction='y')
  r6 <- crop(r6, extent(China.shp))
  mask(r6, China.shp)
  r6 <- r6 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r6)) %>% as.data.frame()
  r6 <- cbind(vec, r6)
  names(r6)[1] <- "Timeframe"
  names(r6)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2, r3, r4, r5, r6)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    theme(axis.text.x = element_text(angle = 45)) +
    scale_x_discrete(limits=c("Nov2018-Jan2019", "Jan-March 2019", "Nov2019-Jan2020", "Jan-March 2020", "Nov2020-Jan2021", "Jan-March 2021")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_violin("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif", "China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif", "China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")
```

####China time analysis (boxplots).
```{r, eval = TRUE}
China_2019_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2: 2019 Seasonal Change', 
          ylab='Date',
          names = c('Nov2018-Jan2019', 'Jan-March 2019'))
}
China_2019_change("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif")

China_2020_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('Nov2019-Jan2020', 'Jan-March 2020'))
}
China_2020_change("China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif")

China_2021_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2: 2021 Seasonal Change', 
          ylab='Date',
          names = c('Nov2020-Jan2021', 'jan-March 2021'))
}
China_2021_change("China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")
```
