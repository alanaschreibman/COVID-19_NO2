---
title: "NO2 and COVID-19 Exploratory Analysis"
author: "Alana Schreibman"
date: "5/27/2021"
output: 
  html_document:
    toc: true
    toc_float: 
        collapsed: true
        smooth_scroll: true
    depth: 3 
    theme: cosmo
    highlight: pygments
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

***

```{r, eval = TRUE}
#Load libraries needed. 
library(easypackages)
libraries("rgdal", "gdalUtils", "rgeos", "raster", "exactextractr", "maptools", "tigris", "ggplot2", "cowplot", "dplyr", "sp", "sf", "rgdal", "stringr", "RColorBrewer", "ggcorrplot", "pander", "forcats", "ggsn", "mapproj", "rlist", "lubridate", "ggpubr")
```


### Merging NO2 data with COVID data for analysis.  
#### Preparing shapefiles.
```{r, eval = TRUE}
#Reading in world countries shapefile.
data(wrld_simpl)
wrld_simpl@data[["NAME"]]
plot(wrld_simpl) 
wrld_simpl <- wrld_simpl[wrld_simpl$NAME != "Antarctica", ]

#Reading in urban areas shapefile. 
world.sf <- st_read("urban_shapefile/ne_10m_urban_areas_landscan.shp", crs = 4326) # Read shapefile as an sf object
us.urban.sf <- st_read("us_urban_shapefile/tl_2017_us_uac10.shp", crs = 4979)  # Read shapefile as an sf object
```


#### Preparing COVID data.
```{r, eval = TRUE}
#Filtering COVID data (from COVID exploratory analysis.)
owid <- read.csv(url("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv"), na.strings = c("", "NA"), colClasses = c("date" = "Date"), header = TRUE)
owid.filtered <- owid %>%
                  rename(iso.code = iso_code, totcases = total_cases, newcases = new_cases, totdeaths = total_deaths, newdeaths = new_deaths, totcases.mil = total_cases_per_million, totdeaths.mil = total_deaths_per_million, pop.density = population_density, med.age = median_age, older70 = aged_70_older, gdp.cap = gdp_per_capita, card.death = cardiovasc_death_rate, diab.prev = diabetes_prevalence, fem.smokers = female_smokers, male.smokers = male_smokers) %>%
                  select(c(iso.code:newcases, totdeaths, newdeaths, totcases.mil, totdeaths.mil, population, pop.density, med.age, older70, gdp.cap, card.death, diab.prev, fem.smokers, male.smokers)) %>% #Renamed variables and filtered to keep only those of interest. 
                  filter(date == "2021-07-16") #Filtered out all but most recent date (most recent date is a running sum of total cases).
table(owid.filtered$continent, useNA = "ifany") #Data includes both continent and country-specific outcomes. Continent outcomes can be distinguished by "NA" in the continent column; the continent name is in the location column. 
cfr.df <- data.frame("case.fatality.rate"= owid.filtered$totdeaths / owid.filtered$totcases, "location" = owid.filtered$location)
owid.tottests <- read.csv(url("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/latest/owid-covid-latest.csv"), na.strings = c("", "NA"), header = TRUE)
owid.tottests <- owid.tottests %>% select(location, tottests.thousand = total_tests_per_thousand)
owid.filtered <- merge(owid.filtered, cfr.df, by = "location")
  rm(cfr.df)
owid.filtered <- left_join(owid.filtered, owid.tottests, by = "location")
owid.countries <- owid.filtered %>%
                    filter(!is.na(continent)) #Removed all rows with NA for continent, leaving behind only countries. 

#Filtering to get weekly averages for new cases and new deaths
dates.covid.weekly <- seq(as.Date("2020-01-20"), as.Date("2021-07-04"), by=7) 

owid.time.series.fxn <- function(country, t) {
  df <- owid %>%
  select(location, date, newcases = new_cases, newdeaths = new_deaths) %>%
  filter(location==country) %>%
  filter(date %in% (as.Date(t):(as.Date(t) + 6)))
  df
}

owid.world.time.series.list <- purrr::pmap(list(rep("World", 76), dates.covid.weekly), owid.time.series.fxn) #Creates list of data frames, each corresponding to a particular week during lockdown. 
owid.us.time.series.list <- purrr::pmap(list(rep("United States", 76), dates.covid.weekly), owid.time.series.fxn)

covid.mean.fxn <- function(x, column, lab) {
  df <- data.frame(owid.world.time.series.list[[x]])
  mean <- mean(df[[column]], na.rm = T)
  Date <- as.Date(dates.covid.weekly[[x]])
  Week <- paste0(as.character(as.Date(dates.covid.weekly[[x]])), " to ", as.character(as.Date(dates.covid.weekly[[x]]) + 6)) 
  col.lab <- as.character(paste0("Mean_Weekly_", lab))
  df <- data.frame(Date, Week, mean) 
  names(df)[3] <- as.character(paste0("Mean_Weekly_", lab))
  df
}

x <- 1:76
mean.newcases.df <- purrr::pmap_dfr(list(x, "newcases", "Cases"), covid.mean.fxn)
mean.newdeaths.df <- purrr::pmap_dfr(list(x, "newdeaths", "Deaths"), covid.mean.fxn)

covid.us.mean.fxn <- function(x, column, lab) {
  df <- data.frame(owid.us.time.series.list[[x]])
  mean <- mean(df[[column]], na.rm = T)
  Date <- as.Date(dates.covid.weekly[[x]])
  Week <- paste0(as.character(as.Date(dates.covid.weekly[[x]])), " to ", as.character(as.Date(dates.covid.weekly[[x]]) + 6)) 
  col.lab <- as.character(paste0("Mean_Weekly_", lab))
  df <- data.frame(Date, Week, mean) 
  names(df)[3] <- as.character(paste0("Mean_Weekly_", lab))
  df
}

mean.us.newcases.df <- purrr::pmap_dfr(list(x, "newcases", "Cases"), covid.us.mean.fxn)

owid.countries %>% select(location, tottests.thousand)
```


#### Creating mosaic of half-world raster files and reading in world satellite data. 
```{r, eval = TRUE}
#Reading in NO2 data averaging tropospheric NO2 column density from 2019-01-01 to 2020-01-01.
setwd("./World_Rasters")
left <- raster('Left_Half_World_NO2_2019-01-01_2021_07_19_10_49_23.tif') %>%
  flip(direction='y') 
left.c <- left
left.c[left.c < 0] <- NA
right <- raster('Right_Half_World_NO2_2019-01-01_2021_07_19_11_07_52.tif') %>%
  flip(direction='y')
right.c <- right
right.c[right.c < 0] <- NA
world.NO2.r <- raster::mosaic(left.c, right.c, fun=mean)
rm(left, left.c, right, right.c)

#Converting to data frame for plotting. 
r.crop <- crop(world.NO2.r, extent(wrld_simpl))
r.crop <- mask(r.crop, wrld_simpl)
r.pts <- rasterToPoints(r.crop, spatial = TRUE)
world.NO2.df <- data.frame(r.pts)
rm(r.pts, r.crop)

myPalette <- colorRampPalette(brewer.pal(9, "YlOrRd")) 

my_theme <- function() {
  theme_minimal() +                                  # shorthand for white background color
  theme(axis.line = element_blank(),                 # further customization of theme components
        axis.text = element_blank(),                 # remove x and y axis text and labels
        axis.title = element_blank(),
        panel.grid = element_line(color = "white"),  # make grid lines invisible
        legend.key.size = unit(0.5, "cm"),           # increase size of legend
        legend.text = element_text(size = 7),       # increase legend text size
        legend.title = element_text(size = 7))      # increase legend title size
}

ggplot() +
 geom_raster(data = world.NO2.df, aes(x = x, y = y, fill = layer)) + 
 geom_polygon(data = wrld_simpl, aes(x = long, y = lat, group = group), colour = "black", size = 0.2, fill = NA) +
  my_theme() + 
  ggtitle("World NO2 Concentrations 01-01-2019 to 01-01-2020") +
  #scale_fill_manual(breaks = c(0, 0.0000025, 0.000005, 0.0000075, 0.00001, 0.00002)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(mol/m^2)", colours = myPalette(100))  +
    north(x.min = -180, y.min = -90, x.max = 180, y.max = 90, anchor = c(x=-140, y=-35), symbol=12) +
    scalebar(x.min = -180, y.min = -90, x.max = 180, y.max = 90, dist = 1000, dist_unit = 'km', transform = TRUE, anchor = c(x=-140, y=-60), st.size = 2, model = 'WGS84') +
  coord_equal()

#R base plots.
plot(world.NO2.r)
plot(wrld_simpl, add = TRUE)
```


#### Preparing data for world analysis. 
```{r, eval = TRUE}
wrld_simpl@data$NAME <- as.character(wrld_simpl@data$NAME)

#Changing shapefile country names to match COVID dataset:
wrld_simpl@data$NAME[wrld_simpl$NAME=="Brunei Darussalam"] <- "Brunei"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Czech Republic"] <- "Czechia"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Democratic Republic of the Congo"] <- "Democratic Republic of Congo"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Faroe Islands"] <- "Faeroe Islands"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Iran (Islamic Republic of)"] <- "Iran"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Lao People's Democratic Republic"] <- "Laos"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Libyan Arab Jamahiriya"] <- "Libya"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Republic of Moldova"] <- "Moldova"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Burma"] <- "Myanmar"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Korea, Republic of"] <- "South Korea"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Korea, Democratic People's Republic of"] <- "North Korea"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Syrian Arab Republic"] <- "Syria"
wrld_simpl@data$NAME[wrld_simpl$NAME=="The former Yugoslav Republic of Macedonia"] <- "North Macedonia"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Macau"] <- "Macao"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Micronesia, Federated States of"] <- "Micronesia (country)"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Timor-Leste"] <- "Timor"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Holy See (Vatican City)"] <- "Vatican"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Viet Nam"] <- "Vietnam"
wrld_simpl@data$NAME[wrld_simpl$NAME=="Wallis and Futuna Islands"] <- "Wallis and Futuna"

#Missing from shapefiles but in OWID data: Kosovo, Tanzania, Eswatini
owid.countries$location[!(owid.countries$location %in% wrld_simpl@data$NAME)]
#Missing from OWID data but in shapefiles: 
wrld_simpl@data$NAME[!(wrld_simpl@data$NAME%in% owid.countries$location)]

#Function to extract mean NO2 values by country shapefile. 
extraction.fxn <- function(x) {
  r.mean <- exact_extract(world.NO2.r, wrld_simpl[wrld_simpl$NAME==as.character(x), ], weights = 'area', 'mean') 
  #r.vals <- raster::extract(world.NO2.r, wrld_simpl[wrld_simpl$NAME==as.character(x), ])
  #r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(wrld_simpl@data[wrld_simpl$NAME==as.character(x), ], r.mean)  
  names(final.df)[5] <- "location" 
  names(final.df)[6] <- "Area" 
  names(final.df)[10] <- "Longitude" 
  names(final.df)[11] <- "Latitude" 
  names(final.df)[12] <- "NO2_Concentration"
  final.df <- final.df %>% dplyr::select(location, Area, Longitude, Latitude, NO2_Concentration)
}

#Extracting mean NO2 values and adding to coordinates data to make final data frame.
country.shp.list <- wrld_simpl@data$NAME
x <- country.shp.list
total.df <- purrr::map_dfr(x, extraction.fxn)

#Read in IHME regions data. 
IHME.regions.df <- read.csv(file = 'IHME_regions.csv', header = TRUE) 
IHME.regions.df <- IHME.regions.df %>% rename(location = Countries) %>% dplyr::select("Super.region", "Regions", "location")

#Merged geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
covid.NO2.df <- right_join(IHME.regions.df, total.df, by = "location")
covid.NO2.df <- full_join(covid.NO2.df, owid.countries, by = "location")
covid.NO2.df$Regions <- as.factor(covid.NO2.df$Regions)
covid.NO2.df$Super.region <- as.factor(covid.NO2.df$Super.region)
```


#### Weighting by population by country for data frame. 
```{r, eval = TRUE}
#isolate country using extract and crop for both pop and NO2
#calculate product of population and pollution for each cell using overlay function 
#sum all of these products 
#divide this sum by tot pop for country from df

pop.den.r <- raster("gpw_v4_population_density/pop.density.tif") #Read in GPW v4 population raster data.  

pop.weighting.fxn <- function(x) {
  pop.cropped <- crop(pop.den.r, extent(wrld_simpl[wrld_simpl$NAME==as.character(x), ]))
  pop.cropped <- mask(pop.cropped, wrld_simpl[wrld_simpl$NAME==as.character(x), ])
  NO2.cropped <- crop(world.NO2.r, extent(wrld_simpl[wrld_simpl$NAME==as.character(x), ]))
  NO2.cropped <- mask(NO2.cropped, wrld_simpl[wrld_simpl$NAME==as.character(x), ])
  overlay.cropped <- overlay(pop.cropped, NO2.cropped, fun=function(x,y){(x*y)} )
  sum <- cellStats(overlay.cropped, stat='sum')
  mod.covid.df <- filter(covid.NO2.df, location == as.character(x))
  weighted.NO2 <- sum / mod.covid.df$population %>% data.frame()
  df <- wrld_simpl@data[wrld_simpl$NAME==as.character(x), ]
  weighted.NO2.df <- merge(df, weighted.NO2)
  names(weighted.NO2.df)[5] <- "location" 
  names(weighted.NO2.df)[12] <- "pop.weighted.NO2"
  weighted.NO2.df <- weighted.NO2.df %>% dplyr::select(location, pop.weighted.NO2)
} #Function to weight NO2 by population for each country. 

weighted.NO2.df <- purrr::map_dfr(x, pop.weighting.fxn)
weighted.covid.NO2.df <- full_join(covid.NO2.df, weighted.NO2.df, by = "location") #Join all data frames.
write.csv(weighted.covid.NO2.df, file = "weighted.covid.NO2.df.csv")
rm(weighted.covid.NO2.df)
```


#### Plotting weighted data.
```{r, eval = TRUE}
weighted.covid.NO2.df <- read.csv(file = 'weighted.covid.NO2.df.csv')

wrld.df <- as.data.frame(wrld_simpl)
wrld.fort <- fortify(wrld_simpl, region = "NAME")
names(wrld.fort)[6] <- "location" #Getting world shapefile into data frame for ggplot. 

covid.NO2.plot.df <- full_join(wrld.fort, weighted.covid.NO2.df, by ="location")
covid.NO2.plot.df <- arrange(covid.NO2.plot.df, order) #Joined full weighted COVID data set with shapefile data set. 

map <- ggplot(data = covid.NO2.plot.df, aes(x = long, y = lat, group = group))

map + 
  geom_polygon(aes(fill = NO2_Concentration), color = 'black', size = 0.1) +
  my_theme() + 
  ggtitle("World Raw NO2 Concentrations 07-10-2018 to 07-10-2019") +
  scale_fill_gradientn(name = "NO2 Concentration \n(mol/m^2)", colours = myPalette(100))  +
    north(x.min = -180, y.min = -90, x.max = 180, y.max = 90, anchor = c(x=-140, y=-35), symbol=12) +
    scalebar(covid.NO2.plot.df, dist = 1000, dist_unit = 'km', transform = TRUE, anchor = c(x=-140, y=-60), st.size = 4, model = 'WGS84') +
  coord_equal()
  #Plot of raw NO2 concentrations. 

map + 
  geom_polygon(aes(fill = pop.weighted.NO2), color = 'black', size = 0.1) +
  my_theme() + 
  ggtitle("World Weighted NO2 Concentrations 07-10-2018 to 07-10-2019") +
  scale_fill_gradientn(name = "Weighted NO2 \nConcentration", colours = myPalette(100))  +
    north(x.min = -180, y.min = -90, x.max = 180, y.max = 90, anchor = c(x=-140, y=-35), symbol=12) +
    scalebar(covid.NO2.plot.df, dist = 1000, dist_unit = 'km', transform = TRUE, anchor = c(x=-140, y=-60), st.size = 4, model = 'WGS84') +
  coord_equal() #Plot of population weighted NO2. 
```


#### Grouping data by median and into testing strata. 
```{r, eval = TRUE}
high.covid <- filter(weighted.covid.NO2.df, totcases.mil >= median(weighted.covid.NO2.df$totcases.mil, na.rm = T))
low.covid <- filter(weighted.covid.NO2.df, totcases.mil < median(weighted.covid.NO2.df$totcases.mil, na.rm = T))
high.NO2 <- filter(weighted.covid.NO2.df, NO2_Concentration >= median(weighted.covid.NO2.df$NO2_Concentration, na.rm = T))
low.NO2 <- filter(weighted.covid.NO2.df, NO2_Concentration < median(weighted.covid.NO2.df$NO2_Concentration, na.rm = T))

weighted.covid.complete.tests <- weighted.covid.NO2.df[complete.cases(weighted.covid.NO2.df[ , 28]),]
quantile(weighted.covid.complete.tests$tottests.thousand)
high.testing <- filter(weighted.covid.complete.tests, tottests.thousand >= median(weighted.covid.complete.tests$tottests.thousand, na.rm = T))
low.testing <- filter(weighted.covid.complete.tests, tottests.thousand <= median(weighted.covid.complete.tests$tottests.thousand, na.rm = T))
q4.testing <- filter(weighted.covid.complete.tests, tottests.thousand >=  7.937, tottests.thousand <= 132.389)
q3.testing <- filter(weighted.covid.complete.tests, tottests.thousand >=  132.389, tottests.thousand <= 422.857)
q2.testing <- filter(weighted.covid.complete.tests, tottests.thousand >=  422.857, tottests.thousand <= 1026.348)
q1.testing <- filter(weighted.covid.complete.tests, tottests.thousand >=  1026.348, tottests.thousand <= 10483.965)
```


***
### Exploratory Analysis of NO2 and COVID-19 variables. 
#### Univariate analysis of world NO2 concentrations. 
```{r, eval = TRUE}
#Statistics on world NO2 concentrations. 
covid.NO2.df %>%
    summarize(variable = "NO2_Concentration", mean_NO2 = mean(NO2_Concentration, na.rm = T), st_dev_cty = sd(NO2_Concentration, na.rm = T)) %>%
    pander

covid.NO2.df %>%
    summarize(variable = "NO2_Concentration",
              q0.2 = quantile(NO2_Concentration, 0.2, na.rm = T),
              q0.4 = quantile(NO2_Concentration, 0.4, na.rm = T),
              q0.6 = quantile(NO2_Concentration, 0.6, na.rm = T),
              q0.8 = quantile(NO2_Concentration, 0.8, na.rm = T)) %>%
    pander

#Histogram of NO2 concentrations.
covid.NO2.df %>%
    ggplot(aes(NO2_Concentration)) +
    geom_histogram(color = "black",fill = "grey") +
    geom_vline(xintercept = mean(covid.NO2.df$NO2_Concentration), lwd = 2) +
    labs(title = "Distribution of Tropospheric NO2",
         x = "NO2 Concentration (mol/m^2)",
         y = "Number of Countries") +
    theme_minimal() +
    scale_x_continuous(breaks = seq(0,8E-5,0.5E-5)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1))
```


#### Univariate analysis of world COVID statistics. 
```{r, eval = TRUE}
#Statistics on world COVID case statistics. 
covid.NO2.df %>%
    summarize(variable = "totcases.mil", mean_cases = mean(totcases.mil, na.rm = T), st_dev_cty = sd(totcases, na.rm = T)) %>%
    pander

covid.NO2.df %>%
    summarize(variable = "totcases.mil",
              q0.2 = quantile(totcases.mil, 0.2, na.rm = TRUE),
              q0.4 = quantile(totcases.mil, 0.4, na.rm = TRUE),
              q0.6 = quantile(totcases.mil, 0.6, na.rm = TRUE),
              q0.8 = quantile(totcases.mil, 0.8, na.rm = TRUE)) %>%
    pander

#Histogram of COVID case statistics.
max(covid.NO2.df$totcases.mil, na.rm = TRUE)
covid.case.hist <- covid.NO2.df %>%
    ggplot(aes(totcases.mil)) +
    geom_histogram(color = "black",fill = "grey") +
    geom_vline(xintercept = mean(covid.NO2.df$totcases.mil, na.rm = T), lwd = 2) +
    labs(title = "Distribution of World COVID-19 Cases per Million",
         x = "Total COVID-19 Cases per Million",
         y = "Number of Countries") +
    theme_minimal() +
    scale_x_continuous(breaks = seq(0, 179667.4,10000)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1))

#Statistics on world COVID death statistics. 
covid.NO2.df %>%
    summarize(variable = "totdeaths.mil", mean_cases = mean(totcases.mil, na.rm = T), st_dev_cty = sd(totcases, na.rm = T)) %>%
    pander

covid.NO2.df %>%
    summarize(variable = "totdeaths.mil",
              q0.2 = quantile(totdeaths.mil, 0.2, na.rm = TRUE),
              q0.4 = quantile(totdeaths.mil, 0.4, na.rm = TRUE),
              q0.6 = quantile(totdeaths.mil, 0.6, na.rm = TRUE),
              q0.8 = quantile(totdeaths.mil, 0.8, na.rm = TRUE)) %>%
    pander

#Histogram of COVID statistics.
max(covid.NO2.df$totdeaths.mil, na.rm = TRUE)
covid.death.hist <- covid.NO2.df %>%
    ggplot(aes(totdeaths.mil)) +
    geom_histogram(color = "black",fill = "grey") +
    geom_vline(xintercept = mean(covid.NO2.df$totdeaths.mil, na.rm = TRUE), lwd = 2) +
    labs(title = "Distribution of World COVID-19 Deaths per Million",
         x = "Total COVID-19 Deaths per Million",
         y = "Number of Countries") +
    theme_minimal() +
    scale_x_continuous(breaks = seq(0,5820.087,500)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1))

plot_grid(covid.case.hist, covid.death.hist, labels = 'AUTO', rows = 2)
```


#### Bivariate analysis of NO2 concentrations, COVID data, and categorical variables (super region divisions)
```{r, fig.width=5, fig.height=5,eval = TRUE}
#Summary statistics, NO2, grouping by Super.region
covid.NO2.df %>% 
  group_by(Super.region) %>%
  summarize(mean_NO2 = mean(NO2_Concentration, na.rm = TRUE), sd_NO2 = sd(NO2_Concentration, na.rm = TRUE)) %>%
  pander

#Summary statistics, COVID cases, grouping by Super.region
covid.NO2.df %>% 
  group_by(Super.region) %>%
  summarize(mean_cases.mil = mean(totcases.mil, na.rm = TRUE), sd_cases.mil = sd(totcases.mil, na.rm = TRUE)) %>%
  pander

#Summary statistics, COVID deaths, grouping by Super.region
covid.NO2.df %>% 
  group_by(Super.region) %>%
  summarize(mean_deaths.mil = mean(totdeaths.mil, na.rm = TRUE), sd_deaths.mil = sd(totdeaths.mil, na.rm = TRUE)) %>%
  pander

#Histogram, NO2, grouping by Super.region
covid.NO2.df %>%
    ggplot(aes(NO2_Concentration)) +
    geom_histogram(color = "black",fill = "grey") +
    labs(title = "Distribution of NO2 Concentrations Relative to Super Region",
         x = "NO2 Concentration (mol/m^2)",
         y = "Number of Countries") +
    theme_minimal() +
     scale_x_continuous(breaks = seq(0,8E-5,0.5E-5)) +
     scale_y_continuous(breaks = seq(0,12,2)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    facet_grid(Super.region~.)

#Histogram, COVID cases, grouping by Super.region
covid.NO2.df %>%
    ggplot(aes(totcases.mil)) +
    geom_histogram(color = "black",fill = "grey") +
    labs(title = "Distribution of COVID Cases Relative to Super Region",
         x = "COVID-19 Cases per Million",
         y = "Number of Countries") +
    theme_minimal() +
     scale_x_continuous(breaks = seq(0, 179667.4,10000)) +
     scale_y_continuous(breaks = seq(0,32,8)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    facet_grid(Super.region~.)

#Histogram, COVID deaths, grouping by Super.region
covid.NO2.df %>%
    ggplot(aes(totdeaths.mil)) +
    geom_histogram(color = "black",fill = "grey") +
    labs(title = "Distribution of COVID Deaths Relative to Super Region",
         x = "COVID-19 Deaths per Million",
         y = "Number of Countries") +
    theme_minimal() +
     scale_x_continuous(breaks = seq(0,5820.087,500)) +
     scale_y_continuous(breaks = seq(0,32,8)) +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    facet_grid(Super.region~.)

#Boxplot, NO2, grouping by Super.region 
covid.NO2.df %>%
    ggplot(aes(Super.region,NO2_Concentration)) +
    geom_boxplot() +
    geom_jitter(color="red", size=0.4, alpha=0.9) +
    labs(title = "Distribution of NO2 relative to Super Region",
         x = "Super Region",
         y = "NO2 Concentration (mol/m^2)") +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    scale_y_continuous(breaks = seq(0,8E-5,0.5E-5)) 

#Boxplot, COVID cases, grouping by Super.region 
covid.NO2.df %>%
    ggplot(aes(Super.region,totcases.mil)) +
    geom_boxplot() +
    geom_jitter(color="red", size=0.4, alpha=0.9) +
    labs(title = "Distribution of COVID Cases Relative to Super Region",
         x = "Super Region",
         y = "COVID-19 Cases per Million") +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    scale_y_continuous(breaks = seq(0, 179667.4,10000))

#Boxplot, COVID deaths, grouping by Super.region 
covid.NO2.df %>%
    ggplot(aes(Super.region,totdeaths.mil)) +
    geom_boxplot() +
    geom_jitter(color="red", size=0.4, alpha=0.9) +
    labs(title = "Distribution of COVID Deaths Relative to Super Region",
         x = "Super Region",
         y = "COVID-19 Deaths per Million") +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    scale_y_continuous(breaks = seq(0,5820.087,500))
```


#### Bivariate analysis of NO2 concentrations and all continuous variables.
```{r, eval = TRUE}
covid.NO2.df %>%
    select(NO2_Concentration, totcases.mil, totdeaths.mil, case.fatality.rate, pop.density, med.age, card.death, diab.prev, fem.smokers, male.smokers) %>% 
    cor(use="pairwise.complete.obs") %>% 
    pander

#Visual representation of correlations.
covid.NO2.df %>%
    select(NO2_Concentration, totcases.mil, totdeaths.mil, case.fatality.rate, tottests.thousand, pop.density, med.age, card.death, diab.prev, fem.smokers, male.smokers)  %>%
    cor(use="pairwise.complete.obs") %>%
    ggcorrplot(type = "lower", ggtheme = theme_minimal, colors = c("#6D9EC1","white","#E46726"),
               show.diag = T,
               lab = T, lab_size = 2, #shows correlation values and sets size of text
               title = "Correlation Matrix for the covid.NO2 dataset",
               legend.title = "Correlation Value",
               outline.color = "white",
               hc.order = T) #orders by variables most related
               
```


#### Bivariate graphs of NO2 concentrations and COVID-19 outcomes.
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1, size = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totcases.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration, data = covid.NO2.df)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1, size = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totdeaths.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.
```

```{r, fig.width = 7, fig.height = 10, eval = TRUE}
regions.list <- c("High-income", "Latin America and Caribbean", "Sub-Saharan Africa", "North Africa and the Middle East", "South Asia", "Southeast Asia, East Asia, and Oceania", "Central Europe, Eastern Europe, and Central Asia")
sub.regions.list <- c("High-income Asia Pacific", "High-income Australasia", "High-income North America", "High-income Southern Latin America", "High-income Western Europe", "Caribbean", "Central Latin America", "Tropical Latin America", "Andean Latin America", "Central sub-Saharan Africa", "Eastern sub-Saharan Africa", "Southern sub-Saharan Africa", "Western sub-Saharan Africa", "North Africa and the Middle East", "South Asia", "East Asia", "Oceania", "Southeast Asia", "Central Asia", "Central Europe", "Eastern Europe")

#Function for bivariate analysis by region. 
cases.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    filter(!is.na(totdeaths.mil)) %>%
                    filter(!is.na(NO2_Concentration)) %>%
                    ggplot(aes(x = NO2_Concentration, y = totcases.mil)) +
                        geom_point(color = "#333aff", size = 1) +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("Cases per Million in ", (Super.region = x), " vs. NO2 Concentration"))
} 
NO2.lm.cases <- function(x) {
                        covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        filter(!is.na(totdeaths.mil)) %>%
                        filter(!is.na(NO2_Concentration)) %>%
                        lm(totcases.mil ~ NO2_Concentration,.) %>%
                        summary.lm()  
} #Function for linear regression statistics to be included in for loop below. 

purrr::map(regions.list, NO2.lm.cases)
bivariate.cases.plots <- purrr::map(regions.list, cases.NO2)
plot_grid(plotlist = bivariate.cases.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.

deaths.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(Super.region == x) %>% 
                    filter(!is.na(totdeaths.mil)) %>%
                    filter(!is.na(NO2_Concentration)) %>%
                    ggplot(aes(x = NO2_Concentration, y = totdeaths.mil)) +
                        geom_point(color = "#333aff", size = 1) +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("Deaths per Million in ", (Super.region = x), " vs. NO2 Concentration"))
} 
NO2.lm.deaths <- function(x) {
                        covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        filter(!is.na(totdeaths.mil)) %>%
                        filter(!is.na(NO2_Concentration)) %>%
                        lm(totdeaths.mil ~ NO2_Concentration,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}

purrr::map(regions.list, NO2.lm.deaths)
bivariate.deaths.plots <- purrr::map(regions.list, deaths.NO2)
plot_grid(plotlist = bivariate.deaths.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.
```


#### Bivariate graphs of population weighted NO2 concentrations and COVID-19 outcomes.
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = weighted.covid.NO2.df, aes(x = pop.weighted.NO2, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1, size = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Weighted NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. Weighted NO2 Concentration") 
cor(weighted.covid.NO2.df$totcases.mil, weighted.covid.NO2.df$pop.weighted.NO2, use = "complete.obs")
NO2.lm.cases <- lm(totcases.mil ~ pop.weighted.NO2, data = weighted.covid.NO2.df)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = weighted.covid.NO2.df, aes(x = pop.weighted.NO2, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1, size = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Weighted NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. Weighted NO2 Concentration") 
cor(weighted.covid.NO2.df$totdeaths.mil, weighted.covid.NO2.df$pop.weighted.NO2, use = "complete.obs")
NO2.lm.deaths <- lm(totdeaths.mil ~ pop.weighted.NO2, data = weighted.covid.NO2.df,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.
```

```{r, fig.width = 7, fig.height = 10, eval = TRUE}
#Function for bivariate analysis by region. 
cases.NO2.w <- function(x) { 
                    weighted.covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    filter(!is.na(totdeaths.mil)) %>%
                    filter(!is.na(pop.weighted.NO2)) %>%
                    ggplot(aes(x = pop.weighted.NO2, y = totcases.mil)) +
                        geom_point(color = "#333aff", size = 1) +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Weighted NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("Cases per Million in ", (Super.region = x), "\nvs. Weighted NO2 Concentration"))
} 
NO2.lm.cases.w <- function(x) {
                        weighted.covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        filter(!is.na(totdeaths.mil)) %>%
                        filter(!is.na(pop.weighted.NO2)) %>%
                        lm(totcases.mil ~ pop.weighted.NO2,.) %>%
                        summary.lm()  
} #Function for linear regression statistics to be included in for loop below. 

purrr::map(regions.list, NO2.lm.cases.w)
bivariate.cases.w.plots <- purrr::map(regions.list, cases.NO2.w)
plot_grid(plotlist = bivariate.cases.w.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.

deaths.NO2.w <- function(x) { 
                    weighted.covid.NO2.df %>% 
                    filter(Super.region == x) %>% 
                    filter(!is.na(totdeaths.mil)) %>%
                    filter(!is.na(pop.weighted.NO2)) %>%
                    ggplot(aes(x = pop.weighted.NO2, y = totdeaths.mil)) +
                        geom_point(color = "#333aff", size = 1) +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Weighted NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("Deaths per Million in ", (Super.region = x), "\nvs. Weighted NO2 Concentration"))
} 
NO2.lm.deaths.w <- function(x) {
                        weighted.covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        filter(!is.na(totdeaths.mil)) %>%
                        filter(!is.na(pop.weighted.NO2)) %>%
                        lm(totdeaths.mil ~ pop.weighted.NO2,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}

purrr::map(regions.list, NO2.lm.deaths.w)
bivariate.deaths.w.plots <- purrr::map(regions.list, deaths.NO2.w)
plot_grid(plotlist = bivariate.deaths.w.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.
```


#### Bivariate graphs of NO2 concentrations and other continuous variables.
```{r, fig.width = 7, fig.height = 10, eval = TRUE}
 #NO2 concentration vs population density. 
pop.den.plot <- ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = pop.density)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Population Density") +
  labs(title = "World Population Density vs. NO2 Concentration") 
cor(covid.NO2.df$pop.density, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.pop <- lm(pop.density ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.pop)
confint(NO2.lm.pop) #Summary statistics for linear fit. 

#NO2 concentration vs median age. 
med.age.plot <- ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = med.age)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Median Age") +
  labs(title = "World Median Age by Country vs. NO2 Concentration") 
cor(covid.NO2.df$med.age, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.age <- lm(med.age ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.age)
confint(NO2.lm.age) #Summary statistics for linear fit.

#NO2 concentration vs GDP per capita. 
gdp.plot <- ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = gdp.cap)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "GDP per Capita") +
  labs(title = "World GDP per Capita vs. NO2 Concentration") 
cor(covid.NO2.df$gdp.cap, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.gdp <- lm(gdp.cap ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.gdp)
confint(NO2.lm.gdp) #Summary statistics for linear fit.

#NO2 concentration vs cardiovascular death. 
card.death.plot <- ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = card.death)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Cardiovascular Death Rates") +
  labs(title = "World Cardiovascular Death Rates vs. NO2 Concentration") 
cor(covid.NO2.df$card.death, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.card.death <- lm(card.death ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.card.death)
confint(NO2.lm.card.death) #Summary statistics for linear fit.

#NO2 concentration vs diabetes prevalence. 
diab.prev.plot <- ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = diab.prev)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Diabetes Prevalence Rates") +
  labs(title = "World Diabetes Prevalence Rates vs. NO2 Concentration") 
cor(covid.NO2.df$diab.prev, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.diab <- lm(diab.prev ~ NO2_Concentration, data = covid.NO2.df,)
summary.lm(NO2.lm.diab)
confint(NO2.lm.diab) #Summary statistics for linear fit.

plot_grid(pop.den.plot, med.age.plot, gdp.plot, card.death.plot, diab.prev.plot, labels = 'AUTO', cols = 2, align = "v")
```


#### Multivariate graphs of COVID outcomes vs NO2 concentrations. 
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totcases.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age + tottests.thousand, data = covid.NO2.df)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totdeaths.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = covid.NO2.df)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.
```

```{r, fig.width = 7, fig.height = 10, eval = TRUE}
#Function for multivariate analysis by Super.region. 
cases.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    ggplot(aes(x = NO2_Concentration, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("Cases per Million in ", (Super.region = x), "\nvs. NO2 Concentration"))
} 
NO2.lm.cases.reg <- function(x) {
                        covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        lm(totcases.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand,.) %>%
                        summary.lm()  
} #Function for linear regression statistics to be included in for loop below. 
purrr::map(regions.list, NO2.lm.cases.reg)
multi.cases.plots <- purrr::map(regions.list, cases.NO2)
plot_grid(plotlist = multi.cases.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.

deaths.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    ggplot(aes(x = NO2_Concentration, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("Deaths per Million in ", (Super.region = x), "\nvs. NO2 Concentration"))
} 
NO2.lm.deaths.reg <- function(x) {
                        covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
purrr::map(regions.list, NO2.lm.deaths.reg)
multi.deaths.plots <- purrr::map(regions.list, deaths.NO2)
plot_grid(plotlist = multi.deaths.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.
```


#### Multivariate graphs of COVID outcomes vs weighted NO2 concentrations. 
```{r, eval = TRUE}
#Weighted NO2 concentration vs COVID cases. 
  ggplot(data = weighted.covid.NO2.df, aes(x = pop.weighted.NO2, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World Cases per Million vs. Population Weighted NO2 Concentration") 
cor(weighted.covid.NO2.df$totcases.mil, weighted.covid.NO2.df$pop.weighted.NO2, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ pop.weighted.NO2 + gdp.cap + pop.density + med.age, data = weighted.covid.NO2.df)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#Weighted NO2 concentration vs COVID deaths. 
ggplot(data = weighted.covid.NO2.df, aes(x = pop.weighted.NO2, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World Deaths per Million vs. Population Weighted NO2 Concentration") 
cor(weighted.covid.NO2.df$totdeaths.mil, weighted.covid.NO2.df$pop.weighted.NO2, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ pop.weighted.NO2 + gdp.cap  + pop.density + med.age, data = weighted.covid.NO2.df,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.
```

```{r,  fig.width = 7, fig.height = 10, eval = TRUE}
#Function for multivariate analysis by Super.region. 
cases.NO2 <- function(x) { 
                    weighted.covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    ggplot(aes(x = pop.weighted.NO2, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("Cases per Million in ", (Super.region = x), "\nvs. Population Weighted NO2 Concentration"))
} 
NO2.lm.cases.reg <- function(x) {
                        weighted.covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        lm(totcases.mil ~ pop.weighted.NO2 + gdp.cap  + pop.density + med.age,.) %>%
                        summary.lm()  
} #Function for linear regression statistics to be included in for loop below. 

purrr::map(regions.list, NO2.lm.cases.reg)
multi.cases.w.plots <- purrr::map(regions.list, cases.NO2)
plot_grid(plotlist = multi.cases.w.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.

deaths.NO2 <- function(x) { 
                    weighted.covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    ggplot(aes(x = pop.weighted.NO2, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("Deaths per Million in ", (Super.region = x), "\nvs. Population Weighted NO2 Concentration"))
} 
NO2.lm.deaths.reg <- function(x) {
                        weighted.covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        lm(totdeaths.mil ~ pop.weighted.NO2 + gdp.cap  + pop.density + med.age,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}

purrr::map(regions.list, NO2.lm.deaths.reg)
multi.deaths.w.plots <- purrr::map(regions.list, deaths.NO2)
plot_grid(plotlist = multi.deaths.w.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.

fatality.rate.NO2 <- function(x) { 
                    weighted.covid.NO2.df %>% 
                    filter(Super.region == x) %>%
                    ggplot(aes(x = pop.weighted.NO2, y = case.fatality.rate)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("Case Fatality Rate in ", (Super.region = x), " \nvs. Population Weighted NO2 Concentration"))
} 
NO2.lm.fatality.reg <- function(x) {
                        weighted.covid.NO2.df %>%
                        filter(Super.region == x) %>%
                        lm(case.fatality.rate ~ pop.weighted.NO2 + gdp.cap  + pop.density + med.age,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}

purrr::map(regions.list, NO2.lm.fatality.reg)
multi.cfr.w.plots <- purrr::map(regions.list, fatality.rate.NO2)
plot_grid(plotlist = multi.cfr.w.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.
```


#### Analysis of high and low groups.
```{r, fig.width = 6, fig.height = 6, eval = TRUE}
high <- data.frame("group" = rep("high", length.out = nrow(high.covid)))
high.covid <- cbind(high, high.covid)
low <- data.frame("group" = rep("low", length.out = nrow(low.covid)))
low.covid <- cbind(low, low.covid)
df.covid <- rbind(high.covid, low.covid)

#Boxplot of NO2 Concentrations by case groups. 
highlow.covid.plot <- ggplot(df.covid, aes(group,NO2_Concentration)) +
  geom_boxplot() +
  geom_jitter(color="red", size=0.4, alpha=0.9) +
  labs(title = "NO2 Concentrations Grouped by COVID Case Levels", x = "Case Count Group", y = "NO2 Concentration (mol/m^2)") +
  stat_compare_means(method = "t.test")

#Boxplot of weighted NO2 Concentrations by case groups. 
highlow.w.covid.plot <- ggplot(df.covid, aes(group,pop.weighted.NO2)) +
  geom_boxplot() +
  geom_jitter(color="red", size=0.4, alpha=0.9) +
  labs(title = "Weighted NO2 Concentrations Grouped by COVID Case Levels", x = "Case Count Group", y = "Weighted NO2 Concentration") +
  stat_compare_means(method = "t.test")
rm(df.covid)

plot_grid(highlow.covid.plot, highlow.w.covid.plot, cols = 1)

high <- data.frame("group" = rep("high", length.out = nrow(high.NO2)))
high.NO2 <- cbind(high, high.NO2)
low <- data.frame("group" = rep("low", length.out = nrow(low.NO2)))
low.NO2<- cbind(low, low.NO2)
df.NO2 <- rbind(high.NO2, low.NO2)

#Boxplot of COVID cases by NO2 groups. 
highlow.NO2.cases.plot <- ggplot(df.NO2, aes(group,totcases.mil)) +
  geom_boxplot() +
  geom_jitter(color="red", size=0.4, alpha=0.9) +
  labs(title = "COVID Cases per Million Grouped by NO2 Concentration Levels", x = "NO2 Concentration Group", y = "Cases per Million") +
  stat_compare_means(method = "t.test")

#Boxplot of COVID deaths by NO2 groups. 
highlow.NO2.deaths.plot <- ggplot(df.NO2, aes(group,totdeaths.mil)) +
  geom_boxplot() +
  geom_jitter(color="red", size=0.4, alpha=0.9) +
  labs(title = "COVID Deaths per Million Grouped by NO2 Concentration Levels", x = "NO2 Concentration Group", y = "Deaths per Million") +
  stat_compare_means(method = "t.test")

#Boxplot of COVID CFR by NO2 groups. 
highlow.NO2.cfr.plot <- ggplot(df.NO2, aes(group,case.fatality.rate)) +
  geom_boxplot() +
  geom_jitter(color="red", size=0.4, alpha=0.9) +
  labs(title = "COVID Case Fatality Rate Grouped by NO2 Concentration Levels", x = "NO2 Concentration Group", y = "Case Fatality Rate") +
  stat_compare_means(method = "t.test")
rm(df.NO2)

plot_grid(highlow.NO2.cases.plot, highlow.NO2.deaths.plot, highlow.NO2.cfr.plot, cols = 1)
```


#### Multivariate graphs of COVID outcomes vs NO2 concentrations: NO2 group divisions. 
```{r, fig.width = 7, fig.height = 6, eval = TRUE}
#High NO2.
#NO2 concentration vs COVID cases. 
p1 <- ggplot(data = high.NO2, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "High NO2: World Cases per Million vs. \nPopulation Weighted NO2 Concentration") 
cor(high.NO2$totcases.mil, high.NO2$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age + tottests.thousand, data = high.NO2)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
p2 <- ggplot(data = high.NO2, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "High NO2: World Deaths per Million vs. NO2 Concentration") 
cor(high.NO2$totdeaths.mil, high.NO2$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = high.NO2,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

#NO2 concentration vs COVID CFR. 
p3 <- ggplot(data = high.NO2, aes(x = NO2_Concentration, y = case.fatality.rate)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Case Fatality Rate") +
  labs(title = "High NO2: Case Fatality Rate vs. NO2 Concentration") 
cor(high.NO2$case.fatality.rate, high.NO2$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(case.fatality.rate ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = high.NO2,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

plot_grid(p1, p2, p3, labels = 'AUTO', align = "v")
```

```{r, fig.width = 7, fig.height = 10, eval = TRUE}
#Function for multivariate analysis by Super.region. 
cases.NO2 <- function(x) { 
                    high.NO2 %>% 
                    filter(Super.region == x) %>%
                    ggplot(aes(x = NO2_Concentration, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("High NO2: Cases per Million in ", (Super.region = x), "\nvs. NO2 Concentration"))
} 
NO2.lm.cases.reg <- function(x) {
                        high.NO2 %>%
                        filter(Super.region == x) %>%
                        lm(totcases.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand,.) %>%
                        summary.lm()  
} #Function for linear regression statistics to be included in for loop below. 
purrr::map(regions.list, NO2.lm.cases.reg)
multi.high.cases.plots <- purrr::map(regions.list, cases.NO2)
plot_grid(plotlist = multi.high.cases.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.

deaths.NO2 <- function(x) { 
                    high.NO2 %>% 
                    filter(Super.region == x) %>%
                    ggplot(aes(x = NO2_Concentration, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("High NO2: Deaths per Million in ", (Super.region = x), "\nvs. NO2 Concentration"))
} 
NO2.lm.deaths.reg <- function(x) {
                        high.NO2 %>%
                        filter(Super.region == x) %>%
                        lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
purrr::map(regions.list, NO2.lm.deaths.reg)
multi.high.deaths.plots <- purrr::map(regions.list, deaths.NO2)
plot_grid(plotlist = multi.high.deaths.plots, labels = 'AUTO', cols = 2) #Loops function for continents of interest.
```

```{r, fig.width = 6, fig.height = 2, eval = TRUE}
#Low NO2.
#NO2 concentration vs COVID cases. 
p1 <- ggplot(data = low.NO2, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "Low NO2: World Cases per Million vs. NO2 Concentration") 
cor(low.NO2$totcases.mil, low.NO2$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age + tottests.thousand, data = low.NO2)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
p2 <- ggplot(data = low.NO2, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "Low NO2: World Deaths per Million vs. NO2 Concentration") 
cor(low.NO2$totdeaths.mil, low.NO2$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = low.NO2,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

plot_grid(p1, p2, labels = 'AUTO')
```


#### Multivariate graphs of COVID outcomes vs NO2 concentrations: level of COVID testing group divisions. 
```{r, eval = TRUE}
#Q1 testing.
#NO2 concentration vs COVID cases.
q1.cases.plot <- ggplot(data = q1.testing, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "Q1 COVID Testing: COVID-19 Cases per Million vs. NO2 Concentration") 
cor(q1.testing$totcases.mil, q1.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age + tottests.thousand, data = q1.testing)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
q1.deaths.plot <- ggplot(data = q1.testing, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "Q1 COVID Testing: COVID-19 Deaths per Million vs. NO2 Concentration") 
cor(q1.testing$totdeaths.mil, q1.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = q1.testing,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

#NO2 concentration vs COVID CFR. 
q1.cfr.plot <- ggplot(data = q1.testing, aes(x = NO2_Concentration, y = case.fatality.rate)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Case Fatality Rate") +
  labs(title = "Q1 COVID Testing: COVID-19 Case Fatality Rate vs. NO2 Concentration") 
cor(q1.testing$case.fatality.rate, q1.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(case.fatality.rate ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = q1.testing,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

#Q2 testing.
#NO2 concentration vs COVID cases. 
q2.cases.plot <- ggplot(data = q2.testing, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "Q2 COVID Testing: COVID-19 Cases per Million vs. NO2 Concentration") 
cor(q2.testing$totcases.mil, q2.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age + tottests.thousand, data = q2.testing)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
q2.deaths.plot <- ggplot(data = q2.testing, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "Q2 COVID Testing: COVID-19 Deaths per Million vs. NO2 Concentration") 
cor(q2.testing$totdeaths.mil, q2.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = q2.testing,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

#NO2 concentration vs COVID CFR. 
q2.cfr.plot <- ggplot(data = q2.testing, aes(x = NO2_Concentration, y = case.fatality.rate)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Case Fatality Rate") +
  labs(title = "Q2 COVID Testing: COVID-19 Case Fatality Rate vs. NO2 Concentration") 
cor(q2.testing$case.fatality.rate, q2.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(case.fatality.rate ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = q2.testing,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

#Q3 testing.
#NO2 concentration vs COVID cases. 
q3.cases.plot <- ggplot(data = q3.testing, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "Q3 COVID Testing: COVID-19 Cases per Million vs. NO2 Concentration") 
cor(q3.testing$totcases.mil, q3.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age + tottests.thousand, data = q3.testing)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
q3.deaths.plot <- ggplot(data = q3.testing, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "Q3 COVID Testing: COVID-19 Deaths per Million vs. NO2 Concentration") 
cor(q3.testing$totdeaths.mil, q3.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = q3.testing,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

#NO2 concentration vs COVID CFR. 
q3.cfr.plot <- ggplot(data = q3.testing, aes(x = NO2_Concentration, y = case.fatality.rate)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Case Fatality Rate") +
  labs(title = "Q3 COVID Testing: COVID-19 Case Fatality Rate vs. NO2 Concentration") 
cor(q3.testing$case.fatality.rate, q3.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(case.fatality.rate ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = q3.testing,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

#Q4 testing.
#NO2 concentration vs COVID cases. 
q4.cases.plot <- ggplot(data = q4.testing, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "Q4 COVID Testing: COVID-19 Cases per Million vs. NO2 Concentration") 
cor(q4.testing$totcases.mil, q4.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age + tottests.thousand, data = q4.testing)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
q4.deaths.plot <- ggplot(data = q4.testing, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "Q4 COVID Testing: COVID-19 Deaths per Million vs. NO2 Concentration") 
cor(q4.testing$totdeaths.mil, q4.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = q4.testing,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.

#NO2 concentration vs COVID CFR. 
q4.cfr.plot <- ggplot(data = q4.testing, aes(x = NO2_Concentration, y = case.fatality.rate)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Case Fatality Rate") +
  labs(title = "Q4 COVID Testing: COVID-19 Case Fatality Rate vs. NO2 Concentration") 
cor(q4.testing$case.fatality.rate, q4.testing$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(case.fatality.rate ~ NO2_Concentration + gdp.cap  + pop.density + med.age + tottests.thousand, data = q4.testing,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.
```

```{r, fig.width=7, fig.height=6, eval = TRUE}
plot_grid(q1.cases.plot, q2.cases.plot, q3.cases.plot, q4.cases.plot, labels='AUTO')
plot_grid(q1.deaths.plot, q2.deaths.plot, q3.deaths.plot, q4.deaths.plot, labels='AUTO')
plot_grid(q1.cfr.plot, q2.cfr.plot, q3.cfr.plot, q4.cfr.plot, labels='AUTO')
```


***
### Correlation analysis: satellite vs. ground EPA. 
#### Formatting sattelite and ground data (US only). 
```{r, eval = TRUE}
#Getting satellite data specifically for this time frame. 
July_Oct2018.sat.r <- raster('US_ground_NO2/US_NO2_2018-07-01_start.tif') %>%
  flip(direction='y')
July_Oct2018.sat.r <- crop(July_Oct2018.sat.r, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
July_Oct2018.sat.r <- mask(July_Oct2018.sat.r, wrld_simpl[wrld_simpl@data$NAME=="United States", ])

#Direct conversion from NO2 raster to data frame while filtering by shapefile. 
continental.US.fxn <- function(x) {
  r1 <- raster(x) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  r1 <- mask(r1, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r1 <- rasterToPoints(r1, spatial = TRUE) 
  July_Oct2018.sat <- r1 %>% 
      data.frame() %>% 
      select(Latitude = 3, Longitude = 2, NO2_Concentration = 1)
  assign("July_Oct2018.sat", July_Oct2018.sat, .GlobalEnv)
}  #Final satellite data to use for comparison to EPA data. 
continental.US.fxn("US_ground_NO2/US_NO2_2018-07-01_start.tif")

#Selecting just latitude and longitude from data frame just made to use with Pargasite retrieval. 
US.lat.lon <- July_Oct2018.sat %>% select(c(Latitude, Longitude))
# write.csv(US.lat.lon, file.path("US_ground_NO2", "US_lat_lon.csv"), row.names = FALSE) #Used to gather EPA data from Pargasite. 

#Reading in EPA data
#Pargasite: only overlapping time frame is July 2018 - October 2018 (Pargasite stops working in November 2018)
July_Oct2018.ground <- read.csv(file = './US_ground_NO2/July_Oct2018NO2.csv') %>% select(c("Latitude", "Longitude", "no2_estimate")) %>% rename(NO2_Concentration = no2_estimate)
July_Oct2018.ground <- data.frame(July_Oct2018.ground) #Final EPA data to use in comparison to satellite data. 

#EPA data frame changed to raster format.
July_Oct2018.ground.r <- July_Oct2018.ground %>% select(c("Longitude", "Latitude", "NO2_Concentration")) %>% rasterFromXYZ() 
```


#### Checking for satellite data correlation to ground data (US only).
```{r, eval = TRUE}
#Resampling raster data to be same size for comparisons. 
July_Oct2018.sat.r.re <- July_Oct2018.sat.r %>% resample(July_Oct2018.ground.r)

#Perform correlation test between satellite and ground rasters. 
cor(values(July_Oct2018.sat.r.re),
    values(July_Oct2018.ground.r),
    use = "na.or.complete")

#Linear model estimation. 
lm1 <- lm(values(July_Oct2018.sat.r.re) ~ values(July_Oct2018.ground.r))
summary(lm1)

#Local correlation estimates--shows where locally on map specific regions are positively or negatively correlated. (Getting an error: try to replicate code from this website https://statnmap.com/2018-01-27-spatial-correlation-between-rasters/)
```


#### Plotting satellite vs ground data (US only). 
```{r, eval = TRUE}
ggplot() +
 geom_raster(data = July_Oct2018.sat, aes(x = Longitude, y = Latitude, fill = NO2_Concentration)) + 
 geom_polygon(data = wrld_simpl[wrld_simpl@data$NAME=="United States", ], aes(x = long, y = lat, group = group), colour = "black", size = 0.5, fill = NA) +
  my_theme() + 
  ggtitle("NO2 US Satellite Data, July-Oct 2018") +
  #scale_fill_manual(breaks = c(0, 0.0000025, 0.000005, 0.0000075, 0.00001, 0.00002)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(mol/m^2)", colours = myPalette(100)) +
    north(x.min = -130, y.min = 23, x.max = -65, y.max = 49, anchor = c(x=-119, y=32), symbol=12) +
    scalebar(x.min = -130, y.min = 23, x.max = -65, y.max = 49, dist = 200, dist_unit = 'km', transform = TRUE, anchor = c(x=-120, y=27.5), st.size = 1.5, model = 'WGS84') +
  xlim(-130,-65) +
  ylim(23,49) +
  coord_quickmap()

ggplot() +
 geom_raster(data = July_Oct2018.ground, aes(x = Longitude, y = Latitude, fill = NO2_Concentration)) + 
 geom_polygon(data = wrld_simpl[wrld_simpl@data$NAME=="United States", ], aes(x = long, y = lat, group = group), colour = "black", size = 0.5, fill = NA) +
  my_theme() + 
  ggtitle("NO2 US EPA Ground Data, July-Oct 2018") +
  #scale_fill_manual(breaks = c(0, 0.0000025, 0.000005, 0.0000075, 0.00001, 0.00002)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(ppb)", colours = myPalette(100)) +
    north(x.min = -130, y.min = 23, x.max = -65, y.max = 49, anchor = c(x=-119, y=32), symbol=12) +
    scalebar(x.min = -130, y.min = 23, x.max = -65, y.max = 49, dist = 200, dist_unit = 'km', transform = TRUE, anchor = c(x=-120, y=27.5), st.size = 1.5, model = 'WGS84') +
  xlim(-130,-65) +
  ylim(23,49) +
  coord_quickmap()
```


#### Formatting sattelite and ground data to be used for correlation analysis (China only). 
```{r, eval = FALSE}
#No success in retrieving data so far due to lack of shapefiles. 
```


#### Reading in shapefiles for six cities analysis. 
```{r, eval = FALSE}
#Unsuccessful without ArcGIS access.
london.shp <- st_read("six_cities_shapefiles/london/ESRI/London_Borough_Excluding_MHW.shp")  # Read shapefile as an sf object
class(london.shp)
london.shp <- st_geometry(london.shp)
plot(london.shp)

seattle.shp <- st_read("six_cities_shapefiles/seattle/WA.shp")  # Read shapefile as an sf object
class(seattle.shp)
seattle.shp <- st_geometry(seattle.shp)
plot(seattle.shp)
```


#### World Air Quality Data City Analysis: data preparation. 
```{r, eval = FALSE}
#Unsuccessful: cannot find shapefiles for the selected cities without ArcGIS access.
#Read in world AQI data for 6 cities. Dates range 12/30/19 to 4/5/20. 
waqi.main <- read.csv(file = 'waqi_NO2.csv', header = TRUE) 
seattle.df <- filter(waqi.main, City == "Seattle") 
  seattle.df$Date <- as.Date(seattle.df$Date, format = "%m/%d/%y")
  seattle.df <- arrange(seattle.df, Date)
wuhan.df <- filter(waqi.main, City == "Wuhan")
  wuhan.df$Date <- as.Date(wuhan.df$Date, format = "%m/%d/%y")
  wuhan.df <- arrange(wuhan.df, Date)
milan.df <- filter(waqi.main, City == "Milan")
  milan.df$Date <- as.Date(milan.df$Date, format = "%m/%d/%y")
  milan.df <- arrange(milan.df, Date)
london.df <- filter(waqi.main, City == "London")
  london.df$Date <- as.Date(london.df$Date, format = "%m/%d/%y")
  london.df <- arrange(london.df, Date)
saopaulo.df <- filter(waqi.main, City == "Sao Paulo") 
  saopaulo.df$Date <- as.Date(saopaulo.df$Date, format = "%m/%d/%y")
  saopaulo.df <- arrange(saopaulo.df, Date)
johannesburg.df <- filter(waqi.main, City == "Johannesburg") 
  johannesburg.df$Date <- as.Date(johannesburg.df$Date, format = "%m/%d/%y")
  johannesburg.df <- arrange(johannesburg.df, Date)

dates.2020.Q1 <- seq(as.Date("2019-12-30"), as.Date("2020-04-05"), by=7) #List of dates starting Dec 30th 2019. 
#Averaging NO2 data by the week. 
#Seattle
seattle.ground.fxn <- function(x) {
  date.filter <- subset(seattle.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  seattle.avg.df <- data.frame(mean)
  names(seattle.avg.df)[1] <- "Mean_NO2_Concentration"
  Week_start_date <- as.Date(dates.2020.Q1[[x]])
  Type <- rep("satellite", length.out = nrow(seattle.avg.df)) 
  seattle.ground.weekly <- cbind(Week_start_date, Type, seattle.avg.df) 
  seattle.ground.weekly <- seattle.ground.weekly %>% dplyr::select(Type, Week_start_date, Mean_NO2_Concentration)
}
x <- seq_along(dates.2020.Q1)
seattle.ground.weekly.df <- purrr::map_dfr(x, seattle.ground.fxn) 

#Wuhan
wuhan.ground.NO2.fxn <- function(x) {
  date.filter <- subset(wuhan.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  date.start <- as.Date(dates.2020.Q1[[x]])
  wuhan.avg.df <- data.frame(date.start, wuhan.df[1,3], mean)
  names(wuhan.avg.df)[1] <- "Week_start_date"
  names(wuhan.avg.df)[2] <- "City"
  names(wuhan.avg.df)[3] <- "Mean_of_Median_NO2"
  output <- wuhan.avg.df 
  return(output)
}
wuhan.ground.df <- purrr::map_dfr(x, wuhan.ground.NO2.fxn) 

#Milan
milan.ground.NO2.fxn <- function(x) {
  date.filter <- subset(milan.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  date.start <- as.Date(dates.2020.Q1[[x]])
  milan.avg.df <- data.frame(date.start, milan.df[1,3], mean)
  names(milan.avg.df)[1] <- "Week_start_date"
  names(milan.avg.df)[2] <- "City"
  names(milan.avg.df)[3] <- "Mean_of_Median_NO2"
  output <- milan.avg.df 
  return(output)
}
milan.ground.df <- purrr::map_dfr(x, milan.ground.NO2.fxn) 

#London
london.ground.fxn <- function(x) {
  date.filter <- subset(london.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  london.avg.df <- data.frame(mean)
  names(london.avg.df)[1] <- "Mean_NO2_Concentration"
  Week_start_date <- as.Date(dates.2020.Q1[[x]])
  Type <- rep("satellite", length.out = nrow(london.avg.df)) 
  london.ground.weekly <- cbind(Week_start_date, Type, london.avg.df) 
  london.ground.weekly <- london.ground.weekly %>% dplyr::select(Type, Week_start_date, Mean_NO2_Concentration)
}
x <- seq_along(dates.2020.Q1)
london.ground.weekly <- purrr::map_dfr(x, london.ground.fxn)

#Sao Paulo
saopaulo.ground.NO2.fxn <- function(x) {
  date.filter <- subset(saopaulo.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  date.start <- as.Date(dates.2020.Q1[[x]])
  saopaulo.avg.df <- data.frame(date.start, saopaulo.df[1,3], mean)
  names(saopaulo.avg.df)[1] <- "Week_start_date"
  names(saopaulo.avg.df)[2] <- "City"
  names(saopaulo.avg.df)[3] <- "Mean_of_Median_NO2"
  output <- saopaulo.avg.df 
  return(output)
}
saopaulo.ground.df <- purrr::map_dfr(x, saopaulo.ground.NO2.fxn) 

#Jonannesburg
jonannesburg.ground.NO2.fxn <- function(x) {
  date.filter <- subset(johannesburg.df, Date >= dates.2020.Q1[[x]] & Date < dates.2020.Q1[[x]] + 6)
  mean <- mean(date.filter$median)
  date.start <- as.Date(dates.2020.Q1[[x]])
  johannesburg.avg.df <- data.frame(date.start, johannesburg.df[1,3], mean)
  names(johannesburg.avg.df)[1] <- "Week_start_date"
  names(johannesburg.avg.df)[2] <- "City"
  names(johannesburg.avg.df)[3] <- "Mean_of_Median_NO2"
  output <- johannesburg.avg.df 
  return(output)
}
jonannesburg.ground.df <- purrr::map_dfr(x, jonannesburg.ground.NO2.fxn) 

#Retrieving satellite data:
#Used code:
#gsutil -m cp \
# >   "file names" \
# >   COVID-19_NO2/six_cities_ground_NO2

# in terminal to copy all files from google cloud storage into folders in working directory.

#Plan:
#get shapefiles for each city
#use shapefiles to filter satellite data for each city and make data frame equivalent to ground data per week
#make graphs for each comparing the two data sets

#Creates list of raster files from folder to call in function. 
seattle.rastlist <- list.files(path = "six_cities_ground_NO2/seattle", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Function to make data frame for weekly average NO2 concentration. 
seattle.sat.fxn <- function(x, y) {
  r <- raster(paste0("six_cities_ground_NO2/seattle/", x))  %>% flip(direction='y')  
  r.vals <- raster::extract(r, `seattle.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(`seattle.shp`@data, r.mean)  
  Week_start_date <- as.Date(dates.2020.Q1[[y]])
  Type <- rep(satellite, length.out = nrow(final.df)) 
  seattle.sat.weekly <- cbind(final.df, Date, Week, Type) 
  seattle.sat.weekly <- seattle.sat.weekly %>% dplyr::mutate(Date = as.factor(strftime(as.Date(Date, format="%Y-%m-%d"), format="%m-%d")))
  names(seattle.sat.weekly)[11] <- "Mean_NO2_Concentration"
  seattle.sat.weekly <- seattle.sat.weekly %>% select(Type, Date, Mean_NO2_Concentration)
}

x <- seattle.rastlist
y <- 1:length(dates.2020.Q1)
seattle.sat.weekly.df <- purrr::map2_dfr(x, y, seattle.sat.fxn) 
seattle.weekly.df <- rbind(seattle.sat.weekly.df, seattle.ground.weekly.df) 


london.rastlist <- list.files(path = "six_cities_ground_NO2/london", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

london.sat.fxn <- function(x, y) {
  r <- raster(paste0("six_cities_ground_NO2/london/", x))  %>% flip(direction='y')  
  r.vals <- raster::extract(r, `london.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(r.mean)  
  Week_start_date <- as.Date(dates.2020.Q1[[y]])
  Type <- rep("satellite", length.out = nrow(final.df)) 
  london.sat.weekly <- cbind(final.df, Week_start_date, Type) 
  names(london.sat.weekly)[1] <- "Mean_NO2_Concentration"
  london.sat.weekly <- london.sat.weekly %>% dplyr::select(Type, Week_start_date, Mean_NO2_Concentration)
}

x <- london.rastlist
y <- 1:length(dates.2020.Q1)
london.sat.weekly <- purrr::map2_dfr(x, y, london.sat.fxn) 
london.weekly.df <- rbind(london.sat.weekly,london.ground.weekly.df) 
```


***
### Time analysis: NO2 and COVID changes during the COVID-19 pandemic.
#### COVID time analysis: interrupted series time analysis plots.
```{r, fig.width=10, fig.height=5, eval = TRUE}
time.series.theme <- function() {
  theme(legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size=22),
        legend.position="right",
        legend.title = element_text(size=14),
        legend.text = element_text(size=10),
        axis.title=element_text(size = 10),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10,angle=90, hjust=1)) 
}

#Cases
ggplot(mean.newcases.df, aes(x = Date, y = Mean_Weekly_Cases)) +
  geom_line(size = 0.75) + 
  theme_bw() +
  time.series.theme() +
  ggtitle("World Weekly Averaged COVID Cases") +
  ylab("Number of Cases") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2020-01-20",format="%Y-%m-%d"),as.Date("2021-07-04",format="%Y-%m-%d"))) +
ylim(0, 840000) +
  
  #Pre-lockdown
  geom_rect(data=mean.newcases.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-01-23",format="%Y-%m-%d"),ymin=8.3E5,ymax=8.4E5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=mean.newcases.df,aes(x=as.Date("2020-01-08"),y=8.35E5),label="Pre-Lockdown",color = "black", size = 3) +
  geom_vline(data=mean.newcases.df,xintercept = as.Date("2020-01-23",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=mean.newcases.df,aes(xmin=as.Date("2020-01-23",format="%Y-%m-%d"),xmax=as.Date("2020-07-01",format="%Y-%m-%d"),ymin=8.3E5,ymax=8.4E5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=mean.newcases.df,aes(x=as.Date("2020-04-01"),y=8.35E5),label="Lockdown 1", color = "black", size = 3) +
  geom_vline(data=mean.newcases.df,xintercept=as.Date("2020-07-01",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=mean.newcases.df,aes(xmin=as.Date("2020-07-01",format="%Y-%m-%d"),xmax=as.Date("2021-07-04",format="%Y-%m-%d"),ymin=8.3E5,ymax=8.4E5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=mean.newcases.df,aes(x=as.Date("2020-09-15"),y=8.35E5),label="Re-Opening", color = "black", size = 3) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("covid_cases_timeseries.pdf")

#Deaths
ggplot(mean.newdeaths.df , aes(x = Date, y = Mean_Weekly_Deaths)) +
  geom_line(size = 0.75) + 
  theme_bw() +
  time.series.theme() +
  ggtitle("World Weekly Averaged COVID Deaths") +
  ylab("Number of Deaths") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2020-01-20",format="%Y-%m-%d"),as.Date("2021-07-04",format="%Y-%m-%d"))) +
ylim(0, 1.5E4) +
  
  #Pre-lockdown
  geom_rect(data=mean.newdeaths.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-01-23",format="%Y-%m-%d"),ymin=1.45E4,ymax=1.5E4),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=mean.newdeaths.df,aes(x=as.Date("2020-01-08"),y=1.475E4),label="Pre-Lockdown",color = "black", size = 3) +
  geom_vline(data=mean.newdeaths.df,xintercept = as.Date("2020-01-23",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=mean.newdeaths.df,aes(xmin=as.Date("2020-01-23",format="%Y-%m-%d"),xmax=as.Date("2020-07-01",format="%Y-%m-%d"),ymin=1.45E4,ymax=1.5E4),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=mean.newdeaths.df,aes(x=as.Date("2020-04-01"),y=1.475E4),label="Lockdown 1", color = "black", size = 3) +
  geom_vline(data=mean.newdeaths.df,xintercept=as.Date("2020-07-01",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=mean.newdeaths.df,aes(xmin=as.Date("2020-07-01",format="%Y-%m-%d"),xmax=as.Date("2021-07-04",format="%Y-%m-%d"),ymin=1.45E4,ymax=1.5E4),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=mean.newdeaths.df,aes(x=as.Date("2020-09-15"),y=1.475E4),label="Re-Opening", color = "black", size = 3) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("covid_deaths_timeseries.pdf")
```


#### World Urban-Rural gradient shapefiles and raster preparation. 
```{r, eval = FALSE}
#lockdown time https://en.wikipedia.org/wiki/COVID-19_lockdowns (many country individual pages were also resources)
#world: PHEIC declared by WHO on 2020-01-30
#czechia 1st lockdown: 2020-03-16 -- 2020-04-12, second lockdown: 2020-10-22 -- 2021-03-28 
#slovenia 2020-03-16 -- 05-15-2020
#sweden: no lockdown (interesting comparison), use same time frame starting 2020-03-16
#uruguay 2020-03-13 (not entirely clear, but closest estimate) -- 2020-05-04 (also not clear--took shopping centers reopening as proxy because indicator of economic reopening )
#lithuania 1st lockdown: 2020-3-16 -- 2020-06-18, 2nd: 2020-11-07 -- 2020-11-28
#united states 2020-03-19 -- 2020-06-05
#netherlands 1st: 2020-03-15 -- 2020-04-06, 2nd: 2020-12-15 -- 2021-03-02
#estonia 2020-03-13 -- 2020-05-17 (state of emergency ends)
#argentina 2020-03-20 -- 2020-05-10 (for whole country minus Greater Buenos Aires, 2020-07-17: Buenos Aires urban area reopens)
#israel 2020-03-19 -- 2020-05-04 
#china 2020-01-23 to 04-08-2020
#Italy: 2020-03-09 -- 2020-05-18
#Iraq 2020-04-04 -- *end uncertain -- seems to be flux of lockdown and non lockdown depending on holidays*
#India 2020-03-24 -- 2020-05-31

#List of top 10 countries for analysis. 
top.10.countries <- covid.NO2.df %>% filter(Area > 100) %>% arrange(desc(totcases.mil)) 
top.10.countries <- top.10.countries$location[1:10]
extras <- c("China", "Italy", "Iraq", "India")
top.10.countries <- c(top.10.countries, extras) #Top 10 countries plus extras. 
top.10.countries[[6]] <- "US"

world.urban.sp <- as(world.sf, Class = "Spatial")
world.urban.sp <- spTransform(world.urban.sp, CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
world.urban.sp <- gSimplify(world.urban.sp, tol = 0.00001, topologyPreserve=TRUE)
world.urban.sp <- gBuffer(world.urban.sp, byid=TRUE, width=0)
world.urban.sf <- st_as_sf(world.urban.sp)

# any bad polys?
#sum(gIsValid(world.urban.sp, byid=TRUE)==FALSE)
#plot(world.urban.sp)

#Used code: 
  # gsutil -m cp \
  # file list 
  # COVID-19_NO2/[Location]_time_analysis_2019
# to retrieve files from google cloud storage. 

#Rastlist, all countries. 
rastlist.2019.fxn <- function(location) {
   rastlist <- list.files(path = paste0(location, "_time_analysis_2019"), pattern='.tif$', 
all.files=TRUE, full.names=FALSE)
   rastlist
}
top.10.2019.raster.list <- purrr::map(top.10.countries, rastlist.2019.fxn) #Makes list by country with all weekly files as elements.  

rastlist.2020.fxn <- function(location) {
   rastlist <- list.files(path = paste0(location, "_time_analysis_2020"), pattern='.tif$', 
all.files=TRUE, full.names=FALSE)
   rastlist
}
top.10.2020.raster.list <- purrr::map(top.10.countries, rastlist.2020.fxn) #Makes list by country with all weekly files as elements.  

#Urban shapefiles.
top.10.countries[[6]] <- "United States"
rgeos::set_RGEOS_CheckValidity(2L)
top.10.urban.fxn <- function(location) {
  country.shp <- wrld_simpl[wrld_simpl$NAME == location, ]
  country.shp <- spTransform(country.shp, CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
  urban.country.sp <- gIntersection(country.shp, world.urban.sp)
  urban.country.sf <- st_as_sf(urban.country.sp)
  urban.country.sf
}
top.10.urban.shp.list <- purrr::map(top.10.countries, top.10.urban.fxn) #Makes list of urban shapefiles by country.  
plot(top.10.rural.shp.list[[12]])
#Rural shapefiles.
top.10.rural.fxn <- function(location, n) {
  country.shp <- wrld_simpl[wrld_simpl$NAME == location, ]
  country.shp <- spTransform(country.shp, CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
  country.urban.sf <- top.10.urban.shp.list[[n]]
  country.urban.sp <- as(country.urban.sf, Class = "Spatial")
  country.rural.sp <- gDifference(country.shp, country.urban.sp)
  country.rural.sf <- st_as_sf(country.rural.sp)
  country.rural.sf
}

n <- 1:14
top.10.rural.shp.list <- purrr::pmap(list(top.10.countries, n), top.10.rural.fxn) #Makes list of rural shapefiles by country.  

#Sanity check: plotting rasters. 
test.fxn <- function(location, x) {
  r <- raster(paste0(location, "_time_analysis_2020/", x)) %>%
    flip(direction='y') 
  plot(r)
  plot(wrld_simpl[wrld_simpl$NAME == "Slovenia", ], add = TRUE)
}
#test.fxn("Slovenia", "Slovenia_NO2_2020-11-23_2021_07_15_21_49_06.tif")
#plot(wrld_simpl[wrld_simpl$NAME == "Uruguay", ])
#test <- raster("Sweden_time_analysis_2019/Sweden_NO2_2019-08-10_2021_07_14_19_37_54.tif")
#fix: Slovenia, Uruguay, Israel, Estonia, Czechia, Netherlands
```


#### Preparation of data frames by country for urban-rural ITS analysis. 
```{r, eval = FALSE}
#testing filtering for missing  values
test <- raster("Sweden_time_analysis_2019/Sweden_NO2_2018-12-22_2021_07_18_14_02_49.tif") %>% flip(direction='y') 
testc <- test
testc[testc < 0] <- NA

test <- test[test < 0] <- NA

r.vals <- exact_extract(testc, top.10.urban.shp.list[[3]], weights = 'area', 'mean') 
r.vals <- data.frame(r.vals)
r.vals <- r.vals[complete.cases(r.vals),]

#negative means (missing data): sweden Dec 1st through Feb midNov-midDec 2019, lithuania earlyDec-earlyJan 2019, lateJan-midFeb 2020, earlyDec-end 2020 , estonia beginning-earlyFeb 2019, midOct-midNov 2019, midDec-earlyFeb 2020

r.mean <- mean(r.vals, na.rm = TRUE)
plot(test)
plot(wrld_simpl[wrld_simpl$NAME == "Sweden", ], add = T)

#2019 general function. 
extract.2019.fxn <- function(location, year, x, country.sf, date) {
  r <- raster(paste0(location, "_time_analysis_", year, "/", x)) %>%
    flip(direction='y') 
  r.c <- r
  r.c[r.c < 0] <- NA
  r.mean <- exact_extract(r.c, country.sf, weights = 'area', 'mean') 
  final.df <- data.frame("NO2_Concentration" = r.mean)   
  Location <- as.character(location)
  Date <- as.factor((date %m+% years(1))) #Adds 1 year to date to match x axis of 2020 dates.
  Week <- paste0(as.character(date), " to ", as.character((date) + 6))
  Period <- rep(2019, length.out = nrow(final.df)) 
  weekly.2019 <- cbind(final.df, Location, Period, Date, Week) 
  weekly.2019 <- weekly.2019 %>% select(Location, Period, Date, Week, NO2_Concentration)
}

#2020 general function. 
extract.2020.fxn <- function(location, year, x, country.sf, date) {
  r <- raster(paste0(location, "_time_analysis_", year, "/", x)) %>%
    flip(direction='y') 
  r.c <- r
  r.c[r.c < 0] <- NA
  r.mean <- exact_extract(r.c, country.sf, weights = 'area', 'mean') 
  final.df <- data.frame("NO2_Concentration" = r.mean)   
  Location <- as.character(location)
  Date <- as.factor(date)
  Week <- paste0(as.character(date), " to ", as.character((date) + 6))
  Period <- rep(2020, length.out = nrow(final.df)) 
  weekly.2020 <- cbind(final.df, Location, Period, Date, Week) 
  weekly.2020 <- weekly.2020 %>% select(Location, Period, Date, Week, NO2_Concentration)
}

#Czechia
dates.2019 <- seq(as.Date("2018-12-01"), as.Date("2020-01-03"), by=7)  
d1 <- seq(as.Date("2019-12-01"), as.Date("2020-02-22"), by=7) 
d2 <- seq(as.Date("2020-02-23"), as.Date("2020-03-01"), by=8) 
d3 <- seq(as.Date("2020-03-02"), as.Date("2021-01-03"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Czechia 2019 urban
location.2019 <- rep("Czechia", length.out = length(top.10.2019.raster.list[[1]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[1]]))
x.2019 <- top.10.2019.raster.list[[1]]
country.sf <- rep(top.10.urban.shp.list[[1]], length.out = length(top.10.2019.raster.list[[1]]))
date.2019 <- as.Date(dates.2019)
czechia.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Czechia 2020 urban
location.2020 <- rep("Czechia", length.out = length(top.10.2020.raster.list[[1]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[1]]))
x.2020 <- top.10.2020.raster.list[[1]]
country.sf <- rep(top.10.urban.shp.list[[1]], length.out = length(top.10.2020.raster.list[[1]]))
date.2020 <- as.Date(dates.2020)
czechia.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

czechia.urban.weekly.df <- rbind(czechia.urban.2019.weekly.df, czechia.urban.2020.weekly.df) 
write.csv(czechia.urban.weekly.df, file = 'time_series_csv/czechia.urban.weekly.NO2.csv')
rm(czechia.urban.weekly.df, czechia.urban.2019.weekly.df, czechia.urban.2020.weekly.df)

#Czechia 2019 rural
country.sf <- rep(top.10.rural.shp.list[[1]], length.out = length(top.10.2019.raster.list[[1]]))
czechia.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Czechia 2020 rural
country.sf <- rep(top.10.rural.shp.list[[1]], length.out = length(top.10.2020.raster.list[[1]]))
czechia.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

czechia.rural.weekly.df <- rbind(czechia.rural.2019.weekly.df, czechia.rural.2020.weekly.df) 
write.csv(czechia.rural.weekly.df, file = 'time_series_csv/czechia.rural.weekly.NO2.csv')
rm(czechia.rural.weekly.df, czechia.rural.2019.weekly.df, czechia.rural.2020.weekly.df)

#Slovenia
dates.2019 <- seq(as.Date("2018-12-01"), as.Date("2020-01-03"), by=7) 
d1 <- seq(as.Date("2019-12-01"), as.Date("2020-02-22"), by=7) 
d2 <- seq(as.Date("2020-02-23"), as.Date("2020-03-01"), by=8) 
d3 <- seq(as.Date("2020-03-02"), as.Date("2021-01-03"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Slovenia 2019 urban
location.2019 <- rep("Slovenia", length.out = length(top.10.2019.raster.list[[2]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[2]]))
x.2019 <- top.10.2019.raster.list[[2]]
country.sf <- rep(top.10.urban.shp.list[[2]], length.out = length(top.10.2019.raster.list[[2]]))
date.2019 <- as.Date(dates.2019)
slovenia.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Slovenia 2020 urban
location.2020 <- rep("Slovenia", length.out = length(top.10.2020.raster.list[[2]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[2]]))
x.2020 <- top.10.2020.raster.list[[2]]
country.sf <- rep(top.10.urban.shp.list[[2]], length.out = length(top.10.2020.raster.list[[2]]))
date.2020 <- as.Date(dates.2020)
slovenia.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

slovenia.urban.weekly.df <- rbind(slovenia.urban.2019.weekly.df, slovenia.urban.2020.weekly.df) 
write.csv(slovenia.urban.weekly.df, file = 'time_series_csv/slovenia.urban.weekly.NO2.csv')
rm(slovenia.urban.weekly.df, slovenia.urban.2019.weekly.df, slovenia.urban.2020.weekly.df)

#Slovenia 2019 rural
country.sf <- rep(top.10.rural.shp.list[[2]], length.out = length(top.10.2019.raster.list[[2]]))
slovenia.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Slovenia 2020 rural
country.sf <- rep(top.10.rural.shp.list[[2]], length.out = length(top.10.2020.raster.list[[2]]))
slovenia.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

slovenia.rural.weekly.df <- rbind(slovenia.rural.2019.weekly.df, slovenia.rural.2020.weekly.df) 
write.csv(slovenia.rural.weekly.df, file = 'time_series_csv/slovenia.rural.weekly.NO2.csv')
rm(slovenia.rural.weekly.df, slovenia.rural.2019.weekly.df, slovenia.rural.2020.weekly.df)

#Sweden
dates.2019 <- seq(as.Date("2018-12-01"), as.Date("2020-01-03"), by=7) 
d1 <- seq(as.Date("2019-12-01"), as.Date("2020-02-22"), by=7) 
d2 <- seq(as.Date("2020-02-23"), as.Date("2020-03-01"), by=8) 
d3 <- seq(as.Date("2020-03-02"), as.Date("2021-01-03"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Sweden 2019 urban
location.2019 <- rep("Sweden", length.out = length(top.10.2019.raster.list[[3]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[3]]))
x.2019 <- top.10.2019.raster.list[[3]]
country.sf <- rep(top.10.urban.shp.list[[3]], length.out = length(top.10.2019.raster.list[[3]]))
date.2019 <- as.Date(dates.2019)
sweden.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Sweden 2020 urban
location.2020 <- rep("Sweden", length.out = length(top.10.2020.raster.list[[3]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[3]]))
x.2020 <- top.10.2020.raster.list[[3]]
country.sf <- rep(top.10.urban.shp.list[[3]], length.out = length(top.10.2020.raster.list[[3]]))
date.2020 <- as.Date(dates.2020)
sweden.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

sweden.urban.weekly.df <- rbind(sweden.urban.2019.weekly.df, sweden.urban.2020.weekly.df) 
write.csv(sweden.urban.weekly.df, file = 'time_series_csv/sweden.urban.weekly.NO2.csv')
rm(sweden.urban.weekly.df, sweden.urban.2019.weekly.df, sweden.urban.2020.weekly.df)

#Sweden 2019 rural
country.sf <- rep(top.10.rural.shp.list[[3]], length.out = length(top.10.2019.raster.list[[3]]))
sweden.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Sweden 2020 rural
country.sf <- rep(top.10.rural.shp.list[[3]], length.out = length(top.10.2020.raster.list[[3]]))
sweden.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

sweden.rural.weekly.df <- rbind(sweden.rural.2019.weekly.df, sweden.rural.2020.weekly.df) 
write.csv(sweden.rural.weekly.df, file = 'time_series_csv/sweden.rural.weekly.NO2.csv')
rm(sweden.rural.weekly.df, sweden.rural.2019.weekly.df, sweden.rural.2020.weekly.df)

#Uruguay
dates.2019 <- seq(as.Date("2018-11-28"), as.Date("2019-12-31"), by=7) 
d1 <- seq(as.Date("2019-11-28"), as.Date("2020-02-26"), by=7) 
d2 <- seq(as.Date("2020-02-27"), as.Date("2020-03-05"), by=8) 
d3 <- seq(as.Date("2020-03-06"), as.Date("2020-12-31"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Uruguay 2019 urban
location.2019 <- rep("Uruguay", length.out = length(top.10.2019.raster.list[[4]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[4]]))
x.2019 <- top.10.2019.raster.list[[4]]
country.sf <- rep(top.10.urban.shp.list[[4]], length.out = length(top.10.2019.raster.list[[4]]))
date.2019 <- as.Date(dates.2019)
uruguay.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Uruguay 2020 urban
location.2020 <- rep("Uruguay", length.out = length(top.10.2020.raster.list[[4]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[4]]))
x.2020 <- top.10.2020.raster.list[[4]]
country.sf <- rep(top.10.urban.shp.list[[4]], length.out = length(top.10.2020.raster.list[[4]]))
date.2020 <- as.Date(dates.2020)
uruguay.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

uruguay.urban.weekly.df <- rbind(uruguay.urban.2019.weekly.df, uruguay.urban.2020.weekly.df) 
write.csv(uruguay.urban.weekly.df, file = 'time_series_csv/uruguay.urban.weekly.NO2.csv')
rm(uruguay.urban.weekly.df, uruguay.urban.2019.weekly.df, uruguay.urban.2020.weekly.df)

#Uruguay 2019 rural
country.sf <- rep(top.10.rural.shp.list[[4]], length.out = length(top.10.2019.raster.list[[4]]))
uruguay.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Uruguay 2020 rural
country.sf <- rep(top.10.rural.shp.list[[4]], length.out = length(top.10.2020.raster.list[[4]]))
uruguay.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

uruguay.rural.weekly.df <- rbind(uruguay.rural.2019.weekly.df, uruguay.rural.2020.weekly.df) 
write.csv(uruguay.rural.weekly.df, file = 'time_series_csv/uruguay.rural.weekly.NO2.csv')
rm(uruguay.rural.weekly.df, uruguay.rural.2019.weekly.df, uruguay.rural.2020.weekly.df)

#Lithuania
dates.2019 <- seq(as.Date("2018-12-01"), as.Date("2020-01-03"), by=7) 
d1 <- seq(as.Date("2019-12-01"), as.Date("2020-02-22"), by=7) 
d2 <- seq(as.Date("2020-02-23"), as.Date("2020-03-01"), by=8) 
d3 <- seq(as.Date("2020-03-02"), as.Date("2021-01-03"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Lithuania 2019 urban
location.2019 <- rep("Lithuania", length.out = length(top.10.2019.raster.list[[5]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[5]]))
x.2019 <- top.10.2019.raster.list[[5]]
country.sf <- rep(top.10.urban.shp.list[[5]], length.out = length(top.10.2019.raster.list[[5]]))
date.2019 <- as.Date(dates.2019)
lithuania.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Lithuania 2020 urban
location.2020 <- rep("Lithuania", length.out = length(top.10.2020.raster.list[[5]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[5]]))
x.2020 <- top.10.2020.raster.list[[5]]
country.sf <- rep(top.10.urban.shp.list[[5]], length.out = length(top.10.2020.raster.list[[5]]))
date.2020 <- as.Date(dates.2020)
lithuania.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

lithuania.urban.weekly.df <- rbind(lithuania.urban.2019.weekly.df, lithuania.urban.2020.weekly.df) 
write.csv(lithuania.urban.weekly.df, file = 'time_series_csv/lithuania.urban.weekly.NO2.csv')
rm(lithuania.urban.weekly.df, lithuania.urban.2019.weekly.df, lithuania.urban.2020.weekly.df)

#Lithuania 2019 rural
country.sf <- rep(top.10.rural.shp.list[[5]], length.out = length(top.10.2019.raster.list[[5]]))
lithuania.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Lithuania 2020 rural
country.sf <- rep(top.10.rural.shp.list[[5]], length.out = length(top.10.2020.raster.list[[5]]))
lithuania.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

lithuania.rural.weekly.df <- rbind(lithuania.rural.2019.weekly.df, lithuania.rural.2020.weekly.df) 
write.csv(lithuania.rural.weekly.df, file = 'time_series_csv/lithuania.rural.weekly.NO2.csv')
rm(lithuania.rural.weekly.df, lithuania.rural.2019.weekly.df, lithuania.rural.2020.weekly.df)

#United States
dates.2019 <- seq(as.Date("2018-12-04"), as.Date("2020-01-06"), by=7) 
d1 <- seq(as.Date("2019-12-04"), as.Date("2020-02-25"), by=7) 
d2 <- seq(as.Date("2020-02-26"), as.Date("2020-03-04"), by=8) 
d3 <- seq(as.Date("2020-03-05"), as.Date("2021-01-06"), by=7) 
dates.2020 <- c(d1, d2, d3)
#US 2019 urban
location.2019 <- rep("US", length.out = length(top.10.2019.raster.list[[6]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[6]]))
x.2019 <- top.10.2019.raster.list[[6]]
country.sf <- rep(top.10.urban.shp.list[[6]], length.out = length(top.10.2019.raster.list[[6]]))
date.2019 <- as.Date(dates.2019)
us.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#US 2020 urban
location.2020 <- rep("US", length.out = length(top.10.2020.raster.list[[6]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[6]]))
x.2020 <- top.10.2020.raster.list[[6]]
country.sf <- rep(top.10.urban.shp.list[[6]], length.out = length(top.10.2020.raster.list[[6]]))
date.2020 <- as.Date(dates.2020)
us.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

us.urban.weekly.df <- rbind(us.urban.2019.weekly.df, us.urban.2020.weekly.df) 
write.csv(us.urban.weekly.df, file = 'time_series_csv/us.urban.weekly.NO2.csv')
rm(us.urban.weekly.df, us.urban.2019.weekly.df, us.urban.2020.weekly.df)

#US 2019 rural
country.sf <- rep(top.10.rural.shp.list[[6]], length.out = length(top.10.2019.raster.list[[6]]))
us.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#US 2020 rural
country.sf <- rep(top.10.rural.shp.list[[6]], length.out = length(top.10.2020.raster.list[[6]]))
us.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

us.rural.weekly.df <- rbind(us.rural.2019.weekly.df, us.rural.2020.weekly.df) 
write.csv(us.rural.weekly.df, file = 'time_series_csv/us.rural.weekly.NO2.csv')
rm(us.rural.weekly.df, us.rural.2019.weekly.df, us.rural.2020.weekly.df)

#Netherlands
dates.2019 <- seq(as.Date("2018-11-30"), as.Date("2020-01-02"), by=7) 
d1 <- seq(as.Date("2019-11-30"), as.Date("2020-02-21"), by=7) 
d2 <- seq(as.Date("2020-02-22"), as.Date("2020-02-29"), by=8) 
d3 <- seq(as.Date("2020-03-01"), as.Date("2021-01-02"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Netherlands 2019 urban
location.2019 <- rep("Netherlands", length.out = length(top.10.2019.raster.list[[7]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[7]]))
x.2019 <- top.10.2019.raster.list[[7]]
country.sf <- rep(top.10.urban.shp.list[[7]], length.out = length(top.10.2019.raster.list[[7]]))
date.2019 <- as.Date(dates.2019)
netherlands.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Netherlands 2020 urban
location.2020 <- rep("Netherlands", length.out = length(top.10.2020.raster.list[[7]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[7]]))
x.2020 <- top.10.2020.raster.list[[7]]
country.sf <- rep(top.10.urban.shp.list[[7]], length.out = length(top.10.2020.raster.list[[7]]))
date.2020 <- as.Date(dates.2020)
netherlands.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

netherlands.urban.weekly.df <- rbind(netherlands.urban.2019.weekly.df, netherlands.urban.2020.weekly.df) 
write.csv(netherlands.urban.weekly.df, file = 'time_series_csv/netherlands.urban.weekly.NO2.csv')
rm(netherlands.urban.weekly.df, netherlands.urban.2019.weekly.df, netherlands.urban.2020.weekly.df)

#Netherlands 2019 rural
country.sf <- rep(top.10.rural.shp.list[[7]], length.out = length(top.10.2019.raster.list[[7]]))
netherlands.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Netherlands 2020 rural
country.sf <- rep(top.10.rural.shp.list[[7]], length.out = length(top.10.2020.raster.list[[7]]))
netherlands.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

netherlands.rural.weekly.df <- rbind(netherlands.rural.2019.weekly.df, netherlands.rural.2020.weekly.df) 
write.csv(netherlands.rural.weekly.df, file = 'time_series_csv/netherlands.rural.weekly.NO2.csv')
rm(netherlands.rural.weekly.df, netherlands.rural.2019.weekly.df, netherlands.rural.2020.weekly.df)

#Estonia
dates.2019 <- seq(as.Date("2018-11-28"), as.Date("2019-12-31"), by=7) 
d1 <- seq(as.Date("2019-11-28"), as.Date("2020-02-26"), by=7) 
d2 <- seq(as.Date("2020-02-27"), as.Date("2020-03-05"), by=8) 
d3 <- seq(as.Date("2020-03-06"), as.Date("2020-12-31"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Estonia 2019 urban
location.2019 <- rep("Estonia", length.out = length(top.10.2019.raster.list[[8]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[8]]))
x.2019 <- top.10.2019.raster.list[[8]]
country.sf <- rep(top.10.urban.shp.list[[8]], length.out = length(top.10.2019.raster.list[[8]]))
date.2019 <- as.Date(dates.2019)
estonia.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Estonia 2020 urban
location.2020 <- rep("Estonia", length.out = length(top.10.2020.raster.list[[8]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[8]]))
x.2020 <- top.10.2020.raster.list[[8]]
country.sf <- rep(top.10.urban.shp.list[[8]], length.out = length(top.10.2020.raster.list[[8]]))
date.2020 <- as.Date(dates.2020)
estonia.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

estonia.urban.weekly.df <- rbind(estonia.urban.2019.weekly.df, estonia.urban.2020.weekly.df) 
write.csv(estonia.urban.weekly.df, file = 'time_series_csv/estonia.urban.weekly.NO2.csv')
rm(estonia.urban.weekly.df, estonia.urban.2019.weekly.df, estonia.urban.2020.weekly.df)

#Estonia 2019 rural
country.sf <- rep(top.10.rural.shp.list[[8]], length.out = length(top.10.2019.raster.list[[8]]))
estonia.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Estonia 2020 rural
country.sf <- rep(top.10.rural.shp.list[[8]], length.out = length(top.10.2020.raster.list[[8]]))
estonia.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

estonia.rural.weekly.df <- rbind(estonia.rural.2019.weekly.df, estonia.rural.2020.weekly.df) 
write.csv(estonia.rural.weekly.df, file = 'time_series_csv/estonia.rural.weekly.NO2.csv')
rm(estonia.rural.weekly.df, estonia.rural.2019.weekly.df, estonia.rural.2020.weekly.df)

#Argentina
dates.2019 <- seq(as.Date("2018-12-05"), as.Date("2020-01-07"), by=7) 
d1 <- seq(as.Date("2019-12-05"), as.Date("2020-02-26"), by=7) 
d2 <- seq(as.Date("2020-02-27"), as.Date("2020-03-05"), by=8) 
d3 <- seq(as.Date("2020-03-06"), as.Date("2021-01-07"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Argentina 2019 urban
location.2019 <- rep("Argentina", length.out = length(top.10.2019.raster.list[[9]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[9]]))
x.2019 <- top.10.2019.raster.list[[9]]
country.sf <- rep(top.10.urban.shp.list[[9]], length.out = length(top.10.2019.raster.list[[9]]))
date.2019 <- as.Date(dates.2019)
argentina.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Argentina 2020 urban
location.2020 <- rep("Argentina", length.out = length(top.10.2020.raster.list[[9]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[9]]))
x.2020 <- top.10.2020.raster.list[[9]]
country.sf <- rep(top.10.urban.shp.list[[9]], length.out = length(top.10.2020.raster.list[[9]]))
date.2020 <- as.Date(dates.2020)
argentina.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

argentina.urban.weekly.df <- rbind(argentina.urban.2019.weekly.df, argentina.urban.2020.weekly.df) 
write.csv(argentina.urban.weekly.df, file = 'time_series_csv/argentina.urban.weekly.NO2.csv')
rm(argentina.urban.weekly.df, argentina.urban.2019.weekly.df, argentina.urban.2020.weekly.df)

#Argentina 2019 rural
country.sf <- rep(top.10.rural.shp.list[[9]], length.out = length(top.10.2019.raster.list[[9]]))
argentina.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Argentina 2020 rural
country.sf <- rep(top.10.rural.shp.list[[9]], length.out = length(top.10.2020.raster.list[[9]]))
argentina.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

argentina.rural.weekly.df <- rbind(argentina.rural.2019.weekly.df, argentina.rural.2020.weekly.df) 
write.csv(argentina.rural.weekly.df, file = 'time_series_csv/argentina.rural.weekly.NO2.csv')
rm(argentina.rural.weekly.df, argentina.rural.2019.weekly.df, argentina.rural.2020.weekly.df)

#Israel
dates.2019 <- seq(as.Date("2018-12-04"), as.Date("2020-01-06"), by=7)
d1 <- seq(as.Date("2019-12-04"), as.Date("2020-02-25"), by=7)
d2 <- seq(as.Date("2020-02-26"), as.Date("2020-03-04"), by=8) 
d3 <- seq(as.Date("2020-03-05"), as.Date("2021-01-06"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Israel 2019 urban
location.2019 <- rep("Israel", length.out = length(top.10.2019.raster.list[[10]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[10]]))
x.2019 <- top.10.2019.raster.list[[10]]
country.sf <- rep(top.10.urban.shp.list[[10]], length.out = length(top.10.2019.raster.list[[10]]))
date.2019 <- as.Date(dates.2019)
israel.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Israel 2020 urban
location.2020 <- rep("Israel", length.out = length(top.10.2020.raster.list[[10]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[10]]))
x.2020 <- top.10.2020.raster.list[[10]]
country.sf <- rep(top.10.urban.shp.list[[10]], length.out = length(top.10.2020.raster.list[[10]]))
date.2020 <- as.Date(dates.2020)
israel.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

israel.urban.weekly.df <- rbind(israel.urban.2019.weekly.df, israel.urban.2020.weekly.df) 
write.csv(israel.urban.weekly.df, file = 'time_series_csv/israel.urban.weekly.NO2.csv')
rm(israel.urban.weekly.df, israel.urban.2019.weekly.df, israel.urban.2020.weekly.df)

#Israel 2019 rural
country.sf <- rep(top.10.rural.shp.list[[10]], length.out = length(top.10.2019.raster.list[[10]]))
israel.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Israel 2020 rural
country.sf <- rep(top.10.rural.shp.list[[10]], length.out = length(top.10.2020.raster.list[[10]]))
israel.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

israel.rural.weekly.df <- rbind(israel.rural.2019.weekly.df, israel.rural.2020.weekly.df) 
write.csv(israel.rural.weekly.df, file = 'time_series_csv/israel.rural.weekly.NO2.csv')
rm(israel.rural.weekly.df, israel.rural.2019.weekly.df, israel.rural.2020.weekly.df)

#China
dates.2019 <- seq(as.Date("2018-10-31"), as.Date("2019-10-29"), by=7)  
d1 <- seq(as.Date("2019-10-31"), as.Date("2020-02-26"), by=7) 
d2 <- seq(as.Date("2020-02-27"), as.Date("2020-03-05"), by=8) 
d3 <- seq(as.Date("2020-03-06"), as.Date("2020-10-29"), by=7) 
dates.2020 <- c(d1, d2, d3)
#China 2019 urban
location.2019 <- rep("China", length.out = length(top.10.2019.raster.list[[11]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[11]]))
x.2019 <- top.10.2019.raster.list[[11]]
country.sf <- rep(top.10.urban.shp.list[[11]], length.out = length(top.10.2019.raster.list[[11]]))
date.2019 <- as.Date(dates.2019)
china.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#China 2020 urban
location.2020 <- rep("China", length.out = length(top.10.2020.raster.list[[11]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[11]]))
x.2020 <- top.10.2020.raster.list[[11]]
country.sf <- rep(top.10.urban.shp.list[[11]], length.out = length(top.10.2020.raster.list[[11]]))
date.2020 <- as.Date(dates.2020)
china.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

china.urban.weekly.df <- rbind(china.urban.2019.weekly.df, china.urban.2020.weekly.df) 
write.csv(china.urban.weekly.df, file = 'time_series_csv/china.urban.weekly.NO2.csv')
rm(china.urban.weekly.df, china.urban.2019.weekly.df, china.urban.2020.weekly.df)

#China 2019 rural
country.sf <- rep(top.10.rural.shp.list[[11]], length.out = length(top.10.2019.raster.list[[11]]))
china.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#China 2020 rural
country.sf <- rep(top.10.rural.shp.list[[11]], length.out = length(top.10.2020.raster.list[[11]]))
china.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

china.rural.weekly.df <- rbind(china.rural.2019.weekly.df, china.rural.2020.weekly.df) 
write.csv(china.rural.weekly.df, file = 'time_series_csv/china.rural.weekly.NO2.csv')
rm(china.rural.weekly.df, china.rural.2019.weekly.df, china.rural.2020.weekly.df)

#Italy
dates.2019 <- seq(as.Date("2018-11-24"), as.Date("2019-12-27"), by=7) 
d1 <- seq(as.Date("2019-11-24"), as.Date("2020-02-22"), by=7)
d2 <- seq(as.Date("2020-02-23"), as.Date("2020-03-01"), by=8) 
d3 <- seq(as.Date("2020-03-02"), as.Date("2020-12-27"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Italy 2019 urban
location.2019 <- rep("Italy", length.out = length(top.10.2019.raster.list[[12]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[12]]))
x.2019 <- top.10.2019.raster.list[[12]]
country.sf <- rep(top.10.urban.shp.list[[12]], length.out = length(top.10.2019.raster.list[[12]]))
date.2019 <- as.Date(dates.2019)
italy.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Italy 2020 urban
location.2020 <- rep("Italy", length.out = length(top.10.2020.raster.list[[12]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[12]]))
x.2020 <- top.10.2020.raster.list[[12]]
country.sf <- rep(top.10.urban.shp.list[[12]], length.out = length(top.10.2020.raster.list[[12]]))
date.2020 <- as.Date(dates.2020)
italy.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

italy.urban.weekly.df <- rbind(italy.urban.2019.weekly.df, italy.urban.2020.weekly.df) 
write.csv(italy.urban.weekly.df, file = 'time_series_csv/italy.urban.weekly.NO2.csv')
rm(italy.urban.weekly.df, italy.urban.2019.weekly.df, italy.urban.2020.weekly.df)

#Italy 2019 rural
country.sf <- rep(top.10.rural.shp.list[[12]], length.out = length(top.10.2019.raster.list[[12]]))
italy.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Italy 2020 rural
country.sf <- rep(top.10.rural.shp.list[[12]], length.out = length(top.10.2020.raster.list[[12]]))
italy.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

italy.rural.weekly.df <- rbind(italy.rural.2019.weekly.df, italy.rural.2020.weekly.df) 
write.csv(italy.rural.weekly.df, file = 'time_series_csv/italy.rural.weekly.NO2.csv')
rm(italy.rural.weekly.df, italy.rural.2019.weekly.df, italy.rural.2020.weekly.df)

#Iraq
dates.2019 <- seq(as.Date("2018-12-13"), as.Date("2020-01-15"), by=7) 
d1 <- seq(as.Date("2019-12-13"), as.Date("2020-02-27"), by=7) 
d2 <- seq(as.Date("2020-02-28"), as.Date("2020-03-06"), by=8) 
d3 <- seq(as.Date(" 2020-03-07"), as.Date("2021-01-15"), by=7) 
dates.2020 <- c(d1, d2, d3)
#Iraq 2019 urban
location.2019 <- rep("Iraq", length.out = length(top.10.2019.raster.list[[13]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[13]]))
x.2019 <- top.10.2019.raster.list[[13]]
country.sf <- rep(top.10.urban.shp.list[[13]], length.out = length(top.10.2019.raster.list[[13]]))
date.2019 <- as.Date(dates.2019)
iraq.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Iraq 2020 urban
location.2020 <- rep("Iraq", length.out = length(top.10.2020.raster.list[[13]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[13]]))
x.2020 <- top.10.2020.raster.list[[13]]
country.sf <- rep(top.10.urban.shp.list[[13]], length.out = length(top.10.2020.raster.list[[13]]))
date.2020 <- as.Date(dates.2020)
iraq.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

iraq.urban.weekly.df <- rbind(iraq.urban.2019.weekly.df, iraq.urban.2020.weekly.df) 
write.csv(iraq.urban.weekly.df, file = 'time_series_csv/iraq.urban.weekly.NO2.csv')
rm(iraq.urban.weekly.df, iraq.urban.2019.weekly.df, iraq.urban.2020.weekly.df)

#Iraq 2019 rural
country.sf <- rep(top.10.rural.shp.list[[13]], length.out = length(top.10.2019.raster.list[[13]]))
iraq.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#Iraq 2020 rural
country.sf <- rep(top.10.rural.shp.list[[13]], length.out = length(top.10.2020.raster.list[[13]]))
iraq.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

iraq.rural.weekly.df <- rbind(iraq.rural.2019.weekly.df, iraq.rural.2020.weekly.df) 
write.csv(iraq.rural.weekly.df, file = 'time_series_csv/iraq.rural.weekly.NO2.csv')
rm(iraq.rural.weekly.df, iraq.rural.2019.weekly.df, iraq.rural.2020.weekly.df)

#India
dates.2019 <- seq(as.Date("2018-12-09"), as.Date("2020-01-11"), by=7) 
d1 <- seq(as.Date("2019-12-09"), as.Date("2020-02-23"), by=7) 
d2 <- seq(as.Date("2020-02-24"), as.Date("2020-03-02"), by=8) 
d3 <- seq(as.Date("2020-03-03"), as.Date("2021-01-11"), by=7) 
dates.2020 <- c(d1, d2, d3)
#India 2019 urban
location.2019 <- rep("India", length.out = length(top.10.2019.raster.list[[14]]))
year.2019 <- rep("2019", length.out = length(top.10.2019.raster.list[[14]]))
x.2019 <- top.10.2019.raster.list[[14]]
country.sf <- rep(top.10.urban.shp.list[[14]], length.out = length(top.10.2019.raster.list[[14]]))
date.2019 <- as.Date(dates.2019)
india.urban.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#India 2020 urban
location.2020 <- rep("India", length.out = length(top.10.2020.raster.list[[14]]))
year.2020 <- rep("2020", length.out = length(top.10.2020.raster.list[[14]]))
x.2020 <- top.10.2020.raster.list[[14]]
country.sf <- rep(top.10.urban.shp.list[[14]], length.out = length(top.10.2020.raster.list[[14]]))
date.2020 <- as.Date(dates.2020)
india.urban.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

india.urban.weekly.df <- rbind(india.urban.2019.weekly.df, india.urban.2020.weekly.df) 
write.csv(india.urban.weekly.df, file = 'time_series_csv/india.urban.weekly.NO2.csv')
rm(india.urban.weekly.df, india.urban.2019.weekly.df, india.urban.2020.weekly.df)

#India 2019 rural
country.sf <- rep(top.10.rural.shp.list[[14]], length.out = length(top.10.2019.raster.list[[14]]))
india.rural.2019.weekly.df <- purrr::pmap_dfr(list(location.2019, year.2019, x.2019, country.sf, date.2019), extract.2019.fxn)

#India 2020 rural
country.sf <- rep(top.10.rural.shp.list[[14]], length.out = length(top.10.2020.raster.list[[14]]))
india.rural.2020.weekly.df <- purrr::pmap_dfr(list(location.2020, year.2020, x.2020, country.sf, date.2020), extract.2020.fxn)

india.rural.weekly.df <- rbind(india.rural.2019.weekly.df, india.rural.2020.weekly.df) 
write.csv(india.rural.weekly.df, file = 'time_series_csv/india.rural.weekly.NO2.csv')
rm(india.rural.weekly.df, india.rural.2019.weekly.df, india.rural.2020.weekly.df)
```


#### World urban/rural interrupted time series analysis.
```{r, eval = FALSE}
#Used code:
#gsutil -m cp \
# >   "file names" \
# >   COVID-19_NO2/time_analysis_2020

# in terminal to copy all files from google cloud storage into folders in working directory.

#Rural world shapefile.
world.shp <- spTransform(wrld_simpl, CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
world.rural.sp <- gDifference(world.shp, world.urban.sp)
world.rural.sf <- st_as_sf(world.rural.sp)

#Creates list of raster files from folder to call in function. 
rastlist.2019.left <- list.files(path = "time_analysis_2019_left", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)
rastlist.2019.right <- list.files(path = "time_analysis_2019_right", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

rastlist.2020.left <- list.files(path = "time_analysis_2020_left", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)
rastlist.2020.right <- list.files(path = "time_analysis_2020_right", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)
        
#Function to make list of rasters for each week, combining left and right halves of world rasters.  
raster.list.fxn <- function(year, x1, x2) {
  left <- raster(paste0("time_analysis_", year, "_left/", x1)) %>%
    flip(direction='y') 
  left.c <- left
  left.c[left.c < 0] <- NA
  right <- raster(paste0("time_analysis_", year, "_right/", x2)) %>%
    flip(direction='y') 
  right.c <- right
  right.c[right.c < 0] <- NA
  world.NO2.r <- raster::mosaic(left.c, right.c, fun=mean) #Combines left and right halves of world raster.
  world.NO2.r
}

x1 <- as.list(rastlist.2019.left)
x2 <- as.list(rastlist.2019.right)
weekly.list.2019 <- purrr::pmap(list(as.character("2019"), x1, x2), raster.list.fxn)
                                  
x1 <- as.list(rastlist.2020.left)
x2 <- as.list(rastlist.2020.right)
weekly.list.2020 <- purrr::pmap(list(as.character("2020"), x1, x2), raster.list.fxn)    

world.extract.2019.fxn <- function(r, shape, date) {
  r.mean <- exact_extract(r, shape, weights = 'area', 'mean') 
  final.df <- data.frame("NO2_Concentration" = r.mean)   
  Location <- rep(as.character("World"), length.out = nrow(final.df))
  Date <- as.factor((date %m+% years(1))) #Adds 1 year to date to match x axis of 2020 dates.
  Week <- paste0(as.character(date), " to ", as.character((date) + 6))
  Period <- rep(2019, length.out = nrow(final.df)) 
  weekly.2019 <- cbind(final.df, Location, Period, Date, Week) 
  weekly.2019 <- weekly.2019 %>% select(Location, Period, Date, Week, NO2_Concentration)
}
  
world.extract.2020.fxn <- function(r, shape, date) {
  r.mean <- exact_extract(r, shape, weights = 'area', 'mean') 
  final.df <- data.frame("NO2_Concentration" = r.mean)   
  Date <- as.factor(date)
  Location <- rep(as.character("World"), length.out = nrow(final.df))
  Week <- paste0(as.character(date), " to ", as.character((date) + 6))
  Period <- rep(2020, length.out = nrow(final.df)) 
  weekly.2020 <- cbind(final.df, Location, Period, Date, Week) 
  weekly.2020 <- weekly.2020 %>% select(Location, Period, Date, Week, NO2_Concentration)
}

#Creates list of dates to call in function. 
dates.2019 <- seq(as.Date("2018-10-29"), as.Date("2019-12-29"), by=7)
d1 <- seq(as.Date("2019-10-29"), as.Date("2020-02-24"), by=7)
d2 <- seq(as.Date("2020-02-25"), as.Date("2020-03-03"), by=8) 
d3 <- seq(as.Date("2020-03-04"), as.Date("2020-12-29"), by=7) 
dates.2020 <- c(d1, d2, d3)

#2019 urban
r.2019 <- weekly.list.2019
shape <- rep(world.urban.sf, length.out = length(weekly.list.2019))
date.2019 <- as.Date(dates.2019)
urban.2019.weekly.df <- purrr::pmap_dfr(list(r.2019, shape, date.2019), world.extract.2019.fxn)
#2020 urban
r.2020 <- weekly.list.2020
shape <- rep(world.urban.sf, length.out = length(weekly.list.2020))
date.2020 <- as.Date(dates.2020)
urban.2020.weekly.df <- purrr::pmap_dfr(list(r.2020, shape, date.2020), world.extract.2020.fxn)
urban.weekly.df <- rbind(urban.2019.weekly.df, urban.2020.weekly.df) 
urban.weekly.df$Date <- as.Date(urban.weekly.df$Date)
urban.weekly.df$Period <- as.factor(urban.weekly.df$Period)
write.csv(urban.weekly.df, file = 'time_series_csv/world.urban.weekly.NO2.csv')
rm(urban.weekly.df, urban.2019.weekly.df, urban.2020.weekly.df)

#2019 rural
shape <- rep(world.rural.sf, length.out = length(weekly.list.2019))
rural.2019.weekly.df <- purrr::pmap_dfr(list(r.2019, shape, date.2019), world.extract.2019.fxn)
#2020 rural
shape <- rep(world.rural.sf, length.out = length(weekly.list.2020))
rural.2020.weekly.df <- purrr::pmap_dfr(list(r.2020, shape, date.2020), world.extract.2020.fxn)
rural.weekly.df <- rbind(rural.2019.weekly.df, rural.2020.weekly.df) 
rural.weekly.df$Date <- as.Date(rural.weekly.df$Date)
rural.weekly.df$Period <- as.factor(rural.weekly.df$Period)
write.csv(rural.weekly.df, file = 'time_series_csv/world.rural.weekly.NO2.csv')
rm(rural.weekly.df, rural.2019.weekly.df, rural.2020.weekly.df)
```


#### Urban areas time analysis: interrupted series time analysis plots.
```{r, fig.width=10, fig.height=8, eval = TRUE}
urban.weekly.df <- read.csv(file = 'time_series_csv/urban.weekly.NO2.csv') 
urban.weekly.df$Date <- as.Date(urban.weekly.df$Date)
urban.weekly.df$Period <- as.factor(urban.weekly.df$Period)

urban.plot <- ggplot(urban.weekly.df, aes(x = Date, y = NO2_Concentration, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme_bw() + 
  time.series.theme() +
  labs(fill = "Year of Measured Pollution") +
  ggtitle("Urban Areas NO2 in 2019 vs 2020") +
  ylab("NO2 Concentration \n(mol/m^2)") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-25",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 3.3E-5) +
  
  #Pre-lockdown
  geom_rect(data=urban.weekly.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-01-23",format="%Y-%m-%d"),ymin=3.25E-5,ymax=3.3E-5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=urban.weekly.df,aes(x=as.Date("2020-01-08"),y=3.275E-5),label="Pre-Lockdown",color = "black", size = 1.5) +
  geom_vline(data=urban.weekly.df,xintercept = as.Date("2020-01-23",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=urban.weekly.df,aes(xmin=as.Date("2020-01-23",format="%Y-%m-%d"),xmax=as.Date("2020-07-01",format="%Y-%m-%d"),ymin=3.25E-5,ymax=3.3E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=urban.weekly.df,aes(x=as.Date("2020-04-01"),y=3.275E-5),label="Lockdown 1", color = "black", size = 1.5) +
  geom_vline(data=urban.weekly.df,xintercept=as.Date("2020-07-01",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=urban.weekly.df,aes(xmin=as.Date("2020-07-01",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"),ymin=3.25E-5,ymax=3.3E-5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=urban.weekly.df,aes(x=as.Date("2020-09-15"),y=3.275E-5),label="Re-Opening", color = "black", size = 1.5) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("urban_time_series.pdf")
```


#### Combining COVID time series data frame with NO2.
```{r, eval = TRUE}
covid.weekly.df <- mean.newcases.df %>% inner_join(mean.newdeaths.df, by = c("Date", "Week"))
total.weekly.df <- urban.weekly.df %>% left_join(covid.weekly.df, by = c("Date", "Week"))

#Cases
mean.newcases.plot <- ggplot(total.weekly.df, aes(x = Date, y = Mean_Weekly_Cases, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme_bw() +
  time.series.theme() +
  ggtitle("World Weekly Averaged COVID Cases") +
  ylab("Number of Cases") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-25",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 840000) +
  
  #Pre-lockdown
  geom_rect(data=total.weekly.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-01-23",format="%Y-%m-%d"),ymin=8.3E5,ymax=8.4E5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=total.weekly.df,aes(x=as.Date("2020-01-08"),y=8.35E5),label="Pre-Lockdown",color = "black", size = 1.5) +
  geom_vline(data=total.weekly.df,xintercept = as.Date("2020-01-23",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=total.weekly.df,aes(xmin=as.Date("2020-01-23",format="%Y-%m-%d"),xmax=as.Date("2020-07-01",format="%Y-%m-%d"),ymin=8.3E5,ymax=8.4E5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=total.weekly.df,aes(x=as.Date("2020-04-01"),y=8.35E5),label="Lockdown 1", color = "black", size = 1.5) +
  geom_vline(data=total.weekly.df,xintercept=as.Date("2020-07-01",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=total.weekly.df,aes(xmin=as.Date("2020-07-01",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"),ymin=8.3E5,ymax=8.4E5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=total.weekly.df,aes(x=as.Date("2020-09-15"),y=8.35E5),label="Re-Opening", color = "black", size = 1.5) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black"))

#Deaths
mean.newdeaths.plot <- ggplot(total.weekly.df , aes(x = Date, y = Mean_Weekly_Deaths, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme_bw() +
  time.series.theme() +
  ggtitle("World Weekly Averaged COVID Deaths") +
  ylab("Number of Deaths") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-25",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 1.5E4) +
  
  #Pre-lockdown
  geom_rect(data=total.weekly.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-01-23",format="%Y-%m-%d"),ymin=1.45E4,ymax=1.5E4),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=total.weekly.df,aes(x=as.Date("2020-01-08"),y=1.475E4),label="Pre-Lockdown",color = "black", size = 1.5) +
  geom_vline(data=total.weekly.df,xintercept = as.Date("2020-01-23",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=total.weekly.df,aes(xmin=as.Date("2020-01-23",format="%Y-%m-%d"),xmax=as.Date("2020-07-01",format="%Y-%m-%d"),ymin=1.45E4,ymax=1.5E4),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=total.weekly.df,aes(x=as.Date("2020-04-01"),y=1.475E4),label="Lockdown 1", color = "black", size = 1.5) +
  geom_vline(data=total.weekly.df,xintercept=as.Date("2020-07-01",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=total.weekly.df,aes(xmin=as.Date("2020-07-01",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"),ymin=1.45E4,ymax=1.5E4),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=total.weekly.df,aes(x=as.Date("2020-09-15"),y=1.475E4),label="Re-Opening", color = "black", size = 1.5) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) 

NO2.vs.cases <- plot_grid(urban.plot, mean.newcases.plot, labels = c('A', 'B'), ncol = 1, align = "v") 
ggsave("NO2_vs_cases.pdf", NO2.vs.cases)
NO2.vs.cases 

NO2.vs.deaths <- plot_grid(urban.plot, mean.newdeaths.plot, labels = c('A', 'B'), ncol = 1, align = "v") 
ggsave("NO2_vs_deaths.pdf", NO2.vs.deaths)
NO2.vs.deaths 
```


#### US urban areas only interrupted time series analysis. 
```{r, eval = FALSE}
#DELETE LATER
us.urban.sf <- us.urban.sf %>% filter(UATYP10=="U")

#2019 data. 
#Creates list of raster files from folder to call in function. 
us.rastlist.2019 <- list.files(path = "US_time_analysis_2019", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2019 <- seq(as.Date("2018-12-17"), as.Date("2019-12-29"), by=7) #List of dates starting Dec 31 2018. 

#Function to make data frame for weekly average NO2 concentration. 
raster.extract.fxn <- function(x, y) {
  r <- raster(paste0("US_time_analysis_2019/", x)) %>%
    flip(direction='y') 
  r.vals <- exact_extract(r, us.urban.sf, weights = 'area', 'mean') 
  r.mean <- mean(r.vals, na.rm = TRUE)
  final.df <- data.frame("NO2_Concentration" = r.mean)   
  Date <- as.factor(as.Date(dates.2019[[y]] %m+% years(1))) #Adds 1 year to date to match x axis of 2020 dates.
  Week <- paste0(as.character(as.Date(dates.2019[[y]])), " to ", as.character(as.Date(dates.2019[[y]]) + 6)) 
  Period <- rep(2019, length.out = nrow(final.df)) 
  us.urban.2019.weekly <- cbind(final.df, Period, Date, Week) 
  us.urban.2019.weekly <- us.urban.2019.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- as.list(us.rastlist.2019)
y <- as.list(1:length(dates.2019))
us.urban.2019.weekly.df <- purrr::pmap_dfr(list(x, y), raster.extract.fxn)

#2020 data.  
#Creates list of raster files from folder to call in function. 
us.rastlist.2020 <- list.files(path = "US_time_analysis_2020", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2020 <- seq(as.Date("2019-12-16"), as.Date("2021-01-03"), by=7) #List of dates starting Dec 30th 2019. 

#Function to make data frame for weekly average NO2 concentration. 
raster.extract.fxn <- function(x, y) {
  r <- raster(paste0("US_time_analysis_2020/", x)) %>%
    flip(direction='y') 
  r.vals <- exact_extract(r, us.urban.sf, weights = 'area', 'mean') 
  r.mean <- mean(r.vals, na.rm = TRUE)
  final.df <- data.frame("NO2_Concentration" = r.mean)   
  Date <- as.factor(as.Date(dates.2020[[y]]))  
  Week <- paste0(as.character(as.Date(dates.2020[[y]])), " to ", as.character(as.Date(dates.2020[[y]]) + 6)) 
  Period <- rep(2020, length.out = nrow(final.df)) 
  us.urban.2020.weekly <- cbind(final.df, Period, Date, Week) 
  us.urban.2020.weekly <- us.urban.2020.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- as.list(us.rastlist.2020)
y <- as.list(1:length(dates.2020))
us.urban.2020.weekly.df <- purrr::pmap_dfr(list(x, y), raster.extract.fxn) 
us.urban.weekly.df <- rbind(us.urban.2019.weekly.df, us.urban.2020.weekly.df) 
us.urban.weekly.df$Date <- as.Date(us.urban.weekly.df$Date)
us.urban.weekly.df$Period <- as.factor(us.urban.weekly.df$Period)
write.csv(us.urban.weekly.df, file = 'time_series_csv/us.urban.weekly.NO2.csv')
rm(us.urban.weekly.df)
```

#### US urban areas only: interrupted time series analysis plots.
```{r, eval = TRUE}
us.urban.weekly.df <- read.csv(file = 'time_series_csv/us.urban.weekly.NO2.csv')
us.urban.weekly.df$Date <- as.Date(us.urban.weekly.df$Date)
us.urban.weekly.df$Period <- as.factor(us.urban.weekly.df$Period)

us.urban.plot <- ggplot(us.urban.weekly.df, aes(x = Date, y = NO2_Concentration, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme_bw() +
  time.series.theme() +
  labs(fill = "Year of Measured Pollution") +
  ggtitle("US Urban NO2 in 2019 vs 2020") +
  ylab("NO2 Concentration (mol/m^2)") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-30",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 4.6E-5) +
  
  #Pre-lockdown
  geom_rect(data=us.urban.weekly.df,aes(xmin=as.Date("2019-12-30",format="%Y-%m-%d"),xmax=as.Date("2020-03-19",format="%Y-%m-%d"),ymin=4.55E-5,ymax=4.6E-5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=us.urban.weekly.df,aes(x=as.Date("2020-02-07"),y=4.575E-5),label="Pre-Lockdown",color = "black", size = 2) +
  geom_vline(data=us.urban.weekly.df,xintercept = as.Date("2020-03-19",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=us.urban.weekly.df,aes(xmin=as.Date("2020-03-19",format="%Y-%m-%d"),xmax=as.Date("2020-06-05",format="%Y-%m-%d"),ymin=4.55E-5,ymax=4.6E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=us.urban.weekly.df,aes(x=as.Date("2020-05-01"),y=4.575E-5),label="Lockdown 1", color = "black", size = 2) +
  geom_vline(data=us.urban.weekly.df,xintercept=as.Date("2020-06-05",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=us.urban.weekly.df,aes(xmin=as.Date("2020-06-05",format="%Y-%m-%d"),xmax=as.Date("2020-11-16",format="%Y-%m-%d"), ymin=4.55E-5,ymax=4.6E-5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=us.urban.weekly.df,aes(x=as.Date("2020-08-15"),y=4.575E-5),label="Re-Opening", color = "black", size = 2) +
  geom_vline(data=us.urban.weekly.df,xintercept=as.Date("2020-11-16",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 2
  geom_rect(data=us.urban.weekly.df,aes(xmin=as.Date("2020-11-16",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"), ymin=4.55E-5,ymax=4.6E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=us.urban.weekly.df,aes(x=as.Date("2020-12-10"),y=4.575E-5),label="Lockdown 2", color = "black", size = 2) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("US_urban_time_series.pdf")
```

#### US rural areas only interrupted time series analysis. 
```{r, eval = FALSE}
#DELETE LATER
us.urban.sp <- as(us.urban.sf, Class = "Spatial")
us.rural.sp <- gDifference(wrld_simpl[wrld_simpl$NAME == "United States", ], us.urban.sp)
us.rural.sf <- st_as_sf(us.rural.sp)

#2019 data. 
#Creates list of dates to call in function. 
dates.2019 <- seq(as.Date("2018-12-17"), as.Date("2019-12-29"), by=7) #List of dates starting Dec 31 2018. 
 
#Function to make data frame for weekly average NO2 concentration. 
raster.extract.fxn <- function(x, y) {
  r <- raster(paste0("US_time_analysis_2019/", x)) %>%
    flip(direction='y') 
  r.vals <- exact_extract(r, us.rural.sf, weights = 'area', 'mean') 
  r.mean <- mean(r.vals, na.rm = TRUE)
  final.df <- data.frame("NO2_Concentration" = r.mean)   
  Date <- as.factor(as.Date(dates.2019[[y]] %m+% years(1))) #Adds 1 year to date to match x axis of 2020 dates.
  Week <- paste0(as.character(as.Date(dates.2019[[y]])), " to ", as.character(as.Date(dates.2019[[y]]) + 6)) 
  Period <- rep(2019, length.out = nrow(final.df)) 
  us.rural.2019.weekly <- cbind(final.df, Period, Date, Week) 
  us.rural.2019.weekly <- us.rural.2019.weekly %>% select(Period, Date, Week, NO2_Concentration)
}
  
x <- as.list(us.rastlist.2019)
y <- as.list(1:length(dates.2019))
us.rural.2019.weekly.df <- purrr::pmap_dfr(list(x, y), raster.extract.fxn)

#2020 data.  
#Creates list of dates to call in function. 
dates.2020 <- seq(as.Date("2019-12-16"), as.Date("2021-01-03"), by=7) #List of dates starting Dec 30th 2019. 

#Function to make data frame for weekly average NO2 concentration. 
raster.extract.fxn <- function(x, y) {
  r <- raster(paste0("US_time_analysis_2020/", x)) %>%
    flip(direction='y') 
  r.vals <- exact_extract(r, us.rural.sf, weights = 'area', 'mean') 
  r.mean <- mean(r.vals, na.rm = TRUE)
  final.df <- data.frame("NO2_Concentration" = r.mean)   
  Date <- as.factor(as.Date(dates.2020[[y]]))  
  Week <- paste0(as.character(as.Date(dates.2020[[y]])), " to ", as.character(as.Date(dates.2020[[y]]) + 6)) 
  Period <- rep(2020, length.out = nrow(final.df)) 
  us.rural.2020.weekly <- cbind(final.df, Period, Date, Week) 
  us.rural.2020.weekly <- us.rural.2020.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- as.list(us.rastlist.2020)
y <- as.list(1:length(dates.2020))
us.rural.2020.weekly.df <- purrr::pmap_dfr(list(x, y), raster.extract.fxn) 
us.rural.weekly.df <- rbind(us.rural.2019.weekly.df, us.rural.2020.weekly.df) 
us.rural.weekly.df$Date <- as.Date(us.rural.weekly.df$Date)
us.rural.weekly.df$Period <- as.factor(us.rural.weekly.df$Period)
write.csv(us.rural.weekly.df, file = 'time_series_csv/us.rural.weekly.NO2.csv')
rm(us.rural.weekly.df)
```

#### US rural areas only: interrupted time series analysis plots.
```{r, eval = TRUE}
us.rural.weekly.df <- read.csv(file = 'time_series_csv/us.rural.weekly.NO2.csv')
us.rural.weekly.df$Date <- as.Date(us.rural.weekly.df$Date)
us.rural.weekly.df$Period <- as.factor(us.rural.weekly.df$Period)

us.rural.plot <- ggplot(us.rural.weekly.df, aes(x = Date, y = NO2_Concentration, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme_bw() +
  time.series.theme() +
  labs(fill = "Year of Measured Pollution") +
  ggtitle("US Rural NO2 in 2019 vs 2020") +
  ylab("NO2 Concentration (mol/m^2)") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-30",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 4.6E-5) +
  
  #Pre-lockdown
  geom_rect(data=us.rural.weekly.df,aes(xmin=as.Date("2019-12-30",format="%Y-%m-%d"),xmax=as.Date("2020-03-19",format="%Y-%m-%d"),ymin=4.55E-5,ymax=4.6E-5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=us.rural.weekly.df,aes(x=as.Date("2020-02-07"),y=4.575E-5),label="Pre-Lockdown",color = "black", size = 2) +
  geom_vline(data=us.rural.weekly.df,xintercept = as.Date("2020-03-19",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=us.rural.weekly.df,aes(xmin=as.Date("2020-03-19",format="%Y-%m-%d"),xmax=as.Date("2020-06-05",format="%Y-%m-%d"),ymin=4.55E-5,ymax=4.6E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=us.rural.weekly.df,aes(x=as.Date("2020-05-01"),y=4.575E-5),label="Lockdown 1", color = "black", size = 2) +
  geom_vline(data=us.rural.weekly.df,xintercept=as.Date("2020-06-05",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=us.rural.weekly.df,aes(xmin=as.Date("2020-06-05",format="%Y-%m-%d"),xmax=as.Date("2020-11-16",format="%Y-%m-%d"), ymin=4.55E-5,ymax=4.6E-5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=us.rural.weekly.df,aes(x=as.Date("2020-08-15"),y=4.575E-5),label="Re-Opening", color = "black", size = 2) +
  geom_vline(data=us.rural.weekly.df,xintercept=as.Date("2020-11-16",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 2
  geom_rect(data=us.rural.weekly.df,aes(xmin=as.Date("2020-11-16",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"), ymin=4.55E-5,ymax=4.6E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=us.rural.weekly.df,aes(x=as.Date("2020-12-10"),y=4.575E-5),label="Lockdown 2", color = "black", size = 2) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("US_rural_time_series.pdf")

us.rural.vs.urban <- plot_grid(us.urban.plot, us.rural.plot, labels = c('A', 'B'), ncol = 1) 
ggsave("US_rural_vs_urban.pdf", us.rural.vs.urban)
us.rural.vs.urban 
```


#### US urban NO2 vs COVID cases. 
```{r, eval = TRUE}
us.total.weekly.df <- urban.weekly.df %>% left_join(mean.us.newcases.df, by = c("Date", "Week"))

#Cases
us.mean.newcases.plot <- ggplot(us.total.weekly.df, aes(x = Date, y = Mean_Weekly_Cases, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme_bw() +
  time.series.theme() +
  ggtitle("World Weekly Averaged COVID Cases") +
  ylab("Number of Cases") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-25",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 230000) +
  
  #Pre-lockdown
  geom_rect(data=us.total.weekly.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-03-19",format="%Y-%m-%d"),ymin=2.3E5,ymax=2.4E5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=us.total.weekly.df,aes(x=as.Date("2020-02-07"),y=2.35E5),label="Pre-Lockdown",color = "black", size = 2) +
  geom_vline(data=us.total.weekly.df,xintercept = as.Date("2020-03-19",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=us.total.weekly.df,aes(xmin=as.Date("2020-03-19",format="%Y-%m-%d"),xmax=as.Date("2020-06-05",format="%Y-%m-%d"),ymin=2.3E5,ymax=2.4E5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=us.total.weekly.df,aes(x=as.Date("2020-05-01"),y=2.35E5),label="Lockdown 1", color = "black", size = 2) +
  geom_vline(data=us.total.weekly.df,xintercept=as.Date("2020-06-05",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=us.total.weekly.df,aes(xmin=as.Date("2020-06-05",format="%Y-%m-%d"),xmax=as.Date("2020-11-16",format="%Y-%m-%d"), ymin=2.3E5,ymax=2.4E5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=us.total.weekly.df,aes(x=as.Date("2020-08-15"),y=2.35E5),label="Re-Opening", color = "black", size = 2) +
  geom_vline(data=us.total.weekly.df,xintercept=as.Date("2020-11-16",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 2
  geom_rect(data=us.total.weekly.df,aes(xmin=as.Date("2020-11-16",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"), ymin=2.3E5,ymax=2.4E5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=us.total.weekly.df,aes(x=as.Date("2020-12-10"),y=2.35E5),label="Lockdown 2", color = "black", size = 2) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black"))

us.NO2.vs.cases <- plot_grid(us.urban.plot, us.mean.newcases.plot, labels = c('A', 'B'), ncol = 1, align = "v") 
ggsave("US_NO2_vs_cases.pdf", us.NO2.vs.cases)
us.NO2.vs.cases 
```


#### US time analysis: interrupted series time analysis data preparation. 
```{r, fig.width=10, fig.height=8, eval = TRUE}
#Use function in other NO2_Exploratory Analysis to filter out each week from Jan-Dec 2019 and Jan-Dec 2020 for comparison.

#Used code:
# gsutil -m cp \
# >   "file names" \
# >   COVID-19_NO2/US_time_analysis_2020

# in terminal to copy all files from google cloud storage into folders in working directory. 

#2019 data.
us.rastlist.2019 <- list.files(path = "US_time_analysis_2019", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2019 <- seq(as.Date("2018-12-03"), as.Date("2020-01-05"), by=7) #List of dates starting Dec 3 2018. 
d1 <- seq(as.Date("2019-12-03"), as.Date("2020-02-24"), by=7) #List of dates starting Dec 2 2019. 
d2 <- seq(as.Date("2020-02-25"), as.Date("2020-03-03"), by=8) 
d3 <- seq(as.Date("2020-03-04"), as.Date("2021-01-05"), by=7) 
dates.2020 <- c(d1, d2, d3)

#Function to make data frame for weekly average NO2 concentration. 
raster.extract.fxn <- function(x, y) {
  r <- raster(paste0("US_time_analysis_2019/", x)) %>% flip(direction='y')  
  r.vals <- exact_extract(r, wrld_simpl[wrld_simpl@data$NAME=="United States", ], weights = 'area', 'mean') 
  r.mean <- mean(r.vals, na.rm = TRUE)
  final.df <- data.frame(wrld_simpl[wrld_simpl@data$NAME=="United States", ]@data, r.mean)  
  Date <- as.factor(as.Date(dates.2019[[y]] %m+% years(1))) #Adds 1 year to date to match x axis of 2020 dates.
  Week <- paste0(as.character(as.Date(dates.2019[[y]])), " to ", as.character(as.Date(dates.2019[[y]]) + 6)) 
  Period <- rep(2019, length.out = nrow(final.df)) 
  US.2019.weekly <- cbind(final.df, Date, Week, Period) 
  rm(r.mean, r.vals)
  names(US.2019.weekly)[12] <- "NO2_Concentration"
  US.2019.weekly <- US.2019.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- us.rastlist.2019
y <- 1:length(dates.2019)
US.2019.weekly.df <- purrr::map2_dfr(x, y, raster.extract.fxn) 

#2020 data.  
us.rastlist.2020 <- list.files(path = "US_time_analysis_2020", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Function to make data frame for weekly average NO2 concentration. 
raster.extract.fxn <- function(x, y) {
  r <- raster(paste0("US_time_analysis_2020/", x)) %>% flip(direction='y')  
  r.vals <- exact_extract(r, wrld_simpl[wrld_simpl@data$NAME=="United States", ], weights = 'area', 'mean') 
  r.mean <- mean(r.vals, na.rm = TRUE)
  final.df <- data.frame(wrld_simpl[wrld_simpl@data$NAME=="United States", ]@data, r.mean)   
  Date <- as.factor(as.Date(dates.2020[[y]]))
  Week <- paste0(as.character(as.Date(dates.2020[[y]])), " to ", as.character(as.Date(dates.2020[[y]]) + 6)) 
  Period <- rep(2020, length.out = nrow(final.df)) 
  US.2020.weekly <- cbind(final.df, Date, Week, Period)     # Add new column to data
  rm(r.mean, r.vals)
  names(US.2020.weekly)[12] <- "NO2_Concentration"
  US.2020.weekly <- US.2020.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- us.rastlist.2020
y <- 1:length(dates.2020)
US.2020.weekly.df <- purrr::map2_dfr(x, y, raster.extract.fxn) 
US.weekly.df <- rbind(US.2019.weekly.df, US.2020.weekly.df) 
US.weekly.df$Date <- as.Date(US.weekly.df$Date)
US.weekly.df$Period <- as.factor(US.weekly.df$Period)
write.csv(US.weekly.df, file = 'time_series_csv/us.weekly.NO2.csv')
rm(US.weekly.df)
```


#### US time analysis: interrupted series time analysis plots.
```{r, fig.width=10, fig.height=8, eval = TRUE}
us.weekly.df <- read.csv(file = 'time_series_csv/us.weekly.NO2.csv')
us.weekly.df$Date <- as.Date(us.weekly.df$Date)
us.weekly.df$Period <- as.factor(us.weekly.df$Period)

ggplot(us.weekly.df, aes(x = Date, y = NO2_Concentration, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme_bw() +
  time.series.theme() +
  labs(fill = "Year of Measured Pollution") +
  ggtitle("US NO2 in 2019 vs 2020") +
  ylab("NO2 Concentration (mol/m^2)") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-25",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 3E-5) +
  
  #Pre-lockdown
  geom_rect(data=us.weekly.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-03-19",format="%Y-%m-%d"),ymin=2.95E-5,ymax=3E-5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=us.weekly.df,aes(x=as.Date("2020-02-07"),y=2.975E-5),label="Pre-Lockdown",color = "black", size = 2) +
  geom_vline(data=us.weekly.df,xintercept = as.Date("2020-03-19",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=us.weekly.df,aes(xmin=as.Date("2020-03-19",format="%Y-%m-%d"),xmax=as.Date("2020-06-05",format="%Y-%m-%d"),ymin=2.95E-5,ymax=3E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=us.weekly.df,aes(x=as.Date("2020-05-01"),y=2.975E-5),label="Lockdown 1", color = "black", size = 2) +
  geom_vline(data=us.weekly.df,xintercept=as.Date("2020-06-05",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=us.weekly.df,aes(xmin=as.Date("2020-06-05",format="%Y-%m-%d"),xmax=as.Date("2020-11-16",format="%Y-%m-%d"), ymin=2.95E-5,ymax=3E-5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=us.weekly.df,aes(x=as.Date("2020-08-15"),y=2.975E-5),label="Re-Opening", color = "black", size = 2) +
  geom_vline(data=us.weekly.df,xintercept=as.Date("2020-11-16",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 2
  geom_rect(data=us.weekly.df,aes(xmin=as.Date("2020-11-16",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"), ymin=2.95E-5,ymax=3E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=us.weekly.df,aes(x=as.Date("2020-12-10"),y=2.975E-5),label="Lockdown 2", color = "black", size = 2) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("US_time_series.pdf")
```


#### China time analysis: interrupted series time analysis data preparation. 
```{r, eval = FALSE}
#Use function in other NO2_Exploratory Analysis file to filter out each week from Jan-Dec 2019 and Jan-Dec 2020 for comparison.

#Used code:
# gsutil -m cp \
# >   "file names" \
# >   COVID-19_NO2/China_time_analysis_2020

# in terminal to copy all files from google cloud storage into folders in working directory. 

#2019 data. 
#Creates list of raster files from folder to call in function. 
china.rastlist.2019 <- list.files(path = "China_time_analysis_2019", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2019 <- seq(as.Date("2018-10-22"), as.Date("2019-11-10"), by=7) #List of dates starting Dec 31 2018.

#Function to make data frame for weekly average NO2 concentration. 
raster.extract.fxn <- function(x, y) {
  r <- raster(paste0("China_time_analysis_2019/", x)) %>% flip(direction='y')
  r.vals <- exact_extract(r, wrld_simpl[wrld_simpl@data$NAME=="China", ], weights = 'area', 'mean')
  r.mean <- mean(r.vals, na.rm = TRUE)
  final.df <- data.frame(wrld_simpl[wrld_simpl@data$NAME=="China", ]@data, r.mean)  
  Date <- as.factor(as.Date(dates.2019[[y]] %m+% years(1))) #Adds 1 year to date to match x axis of 2020 dates.
  Week <- paste0(as.character(as.Date(dates.2019[[y]])), " to ", as.character(as.Date(dates.2019[[y]]) + 6)) 
  Period <- rep("2018-2019", length.out = nrow(final.df)) 
  China.2019.weekly <- cbind(final.df, Date, Week, Period) 
  rm(r.mean, r.vals)
  names(China.2019.weekly)[12] <- "NO2_Concentration"
  China.2019.weekly <- China.2019.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- china.rastlist.2019
y <- 1:length(dates.2019)
China.2019.weekly.df <- purrr::map2_dfr(x, y, raster.extract.fxn) 

#2020 data.  
#Creates list of raster files from folder to call in function. 
china.rastlist.2020 <- list.files(path = "China_time_analysis_2020", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2020 <- seq(as.Date("2019-10-21"), as.Date("2020-11-08"), by=7) #List of dates starting Dec 30th 2019. 

#Function to make data frame for weekly average NO2 concentration. 
raster.extract.fxn <- function(x, y) {
  r <- raster(paste0("China_time_analysis_2020/", x)) %>% flip(direction='y')  
  r.vals <- exact_extract(r, wrld_simpl[wrld_simpl@data$NAME=="China", ], weights = 'area', 'mean')
  r.mean <- mean(r.vals, na.rm = TRUE)
  final.df <- data.frame(wrld_simpl[wrld_simpl@data$NAME=="China", ]@data, r.mean)   
  Date <- as.factor(as.Date(dates.2020[[y]]))
  Week <- paste0(as.character(as.Date(dates.2020[[y]])), " to ", as.character(as.Date(dates.2020[[y]]) + 6)) 
  Period <- rep("2019-2020", length.out = nrow(final.df)) 
  China.2020.weekly <- cbind(final.df, Date, Week, Period)     # Add new column to data
  rm(r.mean, r.vals)
  names(China.2020.weekly)[12] <- "NO2_Concentration"
  China.2020.weekly <- China.2020.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- china.rastlist.2020
y <- 1:length(dates.2020)
China.2020.weekly.df <- purrr::map2_dfr(x, y, raster.extract.fxn) 
China.weekly.df <- rbind(China.2019.weekly.df, China.2020.weekly.df) 
China.weekly.df$Date <- as.Date(China.weekly.df$Date)
China.weekly.df$Period <- as.factor(China.weekly.df$Period)
max(China.weekly.df$NO2_Concentration)
write.csv(China.weekly.df, file = 'time_series_csv/china.weekly.NO2.csv')
rm(China.weekly.df)
```


#### China time analysis: interrupted series time analysis plots.
```{r, fig.width=10, fig.height=8, eval = TRUE}
china.weekly.df <- read.csv(file = 'time_series_csv/china.weekly.NO2.csv')
china.weekly.df$Date <- as.Date(china.weekly.df$Date)
china.weekly.df$Period <- as.factor(china.weekly.df$Period)

ggplot(china.weekly.df, aes(x = Date, y = NO2_Concentration, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  labs(fill = "Year of Measured Pollution") +
  ggtitle("China NO2 in 2019 vs 2020") +
  ylab("NO2 Concentration (mol/m^2)") +
  scale_x_date(date_labels = "%b-%Y",date_breaks = "1 month",limits=c(as.Date("2019-11-01",format="%Y-%m-%d"),as.Date("2020-11-10",format="%Y-%m-%d"))) +
ylim(0,6E-5) +
  theme_bw() +
  time.series.theme() +

  #Pre-lockdown
  geom_rect(data=china.weekly.df,aes(xmin=as.Date("2019-11-01",format="%Y-%m-%d"),xmax=as.Date("2020-01-23",format="%Y-%m-%d"),ymin=5.9E-5,ymax=6E-5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=china.weekly.df,aes(x=as.Date("2019-12-15"),y=5.95E-5),label="Pre-Lockdown",color = "black", size = 2) +
  geom_vline(data=china.weekly.df,xintercept = as.Date("2020-01-23",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=china.weekly.df,aes(xmin=as.Date("2020-01-23",format="%Y-%m-%d"),xmax=as.Date("2020-04-08",format="%Y-%m-%d"),ymin=5.9E-5,ymax=6E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=china.weekly.df,aes(x=as.Date("2020-03-01"),y=5.95E-5),label="Lockdown 1", color = "black", size = 2) +
  geom_vline(data=china.weekly.df,xintercept=as.Date("2020-04-08",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=china.weekly.df,aes(xmin=as.Date("2020-04-08",format="%Y-%m-%d"),xmax=as.Date("2020-11-08",format="%Y-%m-%d"), ymin=5.9E-5,ymax=6E-5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=china.weekly.df,aes(x=as.Date("2020-08-01"),y=5.95E-5),label="Re-Opening", color = "black", size = 2) +
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("China_time_series.pdf")
```


#### US time analysis plots. 
```{r, eval = TRUE}
#Converting before lockdown and after lockdown rasters for US to data frames.
US.NO2.change.fxn <- function(file) {
  r <- raster(paste0('./US_NO2_comparison/', file)) %>%
  flip(direction='y') 
  df <- r %>% crop(., extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ])) %>% 
  mask(., wrld_simpl[wrld_simpl@data$NAME=="United States", ]) %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() %>%
  select(NO2_Concentration = 1, Longitude = 2, Latitude = 3) 
  df
}
files <- c("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif", "US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif", "US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")

US.NO2.list <- purrr::map(files, US.NO2.change.fxn)

#Plotting before and after maps. 
US.NO2.change.map.fxn <- function(x, y, t1, t2) {
p1 <- ggplot() +
 geom_raster(data = x, aes(x = Longitude, y = Latitude, fill = NO2_Concentration)) + 
 geom_polygon(data = wrld_simpl[wrld_simpl@data$NAME=="United States", ], aes(x = long, y = lat, group = group), colour = "black", size = 0.5, fill = NA) +
  my_theme() + 
  ggtitle(paste("US NO2 Concentrations (Sentinel Satellite)", t1)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(mol/m^2)", colours = myPalette(100), limits=c(0, 10E-5)) +
    north(x.min = -130, y.min = 23, x.max = -65, y.max = 49, anchor = c(x=-119, y=32), symbol=12) +
    scalebar(x.min = -130, y.min = 23, x.max = -65, y.max = 49, dist = 200, dist_unit = 'km', transform = TRUE, anchor = c(x=-120, y=27.5), st.size = 1.5, model = 'WGS84') +
  xlim(-130,-65) +
  ylim(23,49) +
  coord_quickmap()
p2 <- ggplot() +
 geom_raster(data = y, aes(x = Longitude, y = Latitude, fill = NO2_Concentration)) + 
 geom_polygon(data = wrld_simpl[wrld_simpl@data$NAME=="United States", ], aes(x = long, y = lat, group = group), colour = "black", size = 0.5, fill = NA) +
  my_theme() + 
  ggtitle(paste("US NO2 Concentrations (Sentinel Satellite)", t2)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(ppb)", colours = myPalette(100), limits=c(0, 10E-5)) +
    north(x.min = -130, y.min = 23, x.max = -65, y.max = 49, anchor = c(x=-119, y=32), symbol=12) +
    scalebar(x.min = -130, y.min = 23, x.max = -65, y.max = 49, dist = 200, dist_unit = 'km', transform = TRUE, anchor = c(x=-120, y=27.5), st.size = 1.5, model = 'WGS84') +
  xlim(-130,-65) +
  ylim(23,49) +
  coord_quickmap()
plot_grid(p1, p2, labels = "AUTO", ncol = 1)
}

US.NO2.change.map.fxn(data.frame(US.NO2.list[1]), data.frame(US.NO2.list[2]), "Jan-March 2019", "March-May 2019")
US.NO2.change.map.fxn(data.frame(US.NO2.list[3]), data.frame(US.NO2.list[4]), "Jan-March 2020", "March-May 2020")
US.NO2.change.map.fxn(data.frame(US.NO2.list[5]), data.frame(US.NO2.list[6]), "Jan-March 2021", "March-May 2021")
```


#### US time analysis (violin plots).
```{r, eval = TRUE}
#Function for finding medians over each time period. 
US_NO2_median <- function(x) {
  r <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  lapply(r.vals, FUN=median, na.rm = TRUE)
}
US_NO2_median("US_NO2_2020-01-19_start.tif")
US_NO2_median("US_NO2_2020-03-19_start.tif")

#Function for finding averages over each time period. 
US_NO2_average <- function(x) {
  r <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  lapply(r.vals, FUN=mean, na.rm = TRUE)
}
US_NO2_average("US_NO2_2020-01-19_start.tif")
US_NO2_average("US_NO2_2020-03-19_start.tif")

#2019 violin plot
US_2019_violin <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_2019_violin("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif")

#2020 violin plot
US_2020_violin <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2020", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2 Before and After COVID-19') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_2020_violin("US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif")

#2021 violin plot
US_2021_violin <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2021", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2: 2021 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_2021_violin("US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")

#All violin plots in 1 graph:
US_violin <- function(a, b, c, d, e, f) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (a))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (b))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  r3 <- raster(paste0("./US_NO2_Comparison/", (c))) %>% flip(direction='y')
  r3 <- crop(r3, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r3, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r3 <- r3 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r3)) %>% as.data.frame()
  r3 <- cbind(vec, r3)
  names(r3)[1] <- "Timeframe"
  names(r3)[4] <- "NO2_Concentration"
  r4 <- raster(paste0("./US_NO2_Comparison/", (d))) %>% flip(direction='y')
  r4 <- crop(r4, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r4, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r4 <- r4 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2020", length.out = nrow(r4)) %>% as.data.frame()
  r4 <- cbind(vec, r4)
  names(r4)[1] <- "Timeframe"
  names(r4)[4] <- "NO2_Concentration"
  r5 <- raster(paste0("./US_NO2_Comparison/", (e))) %>% flip(direction='y')
  r5 <- crop(r5, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r5, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r5 <- r5 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r5)) %>% as.data.frame()
  r5 <- cbind(vec, r5)
  names(r5)[1] <- "Timeframe"
  names(r5)[4] <- "NO2_Concentration"
  r6 <- raster(paste0("./US_NO2_Comparison/", (f))) %>% flip(direction='y')
  r6 <- crop(r6, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r6, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r6 <- r6 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2021", length.out = nrow(r6)) %>% as.data.frame()
  r6 <- cbind(vec, r6)
  names(r6)[1] <- "Timeframe"
  names(r6)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2, r3, r4, r5, r6)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    theme(axis.text.x = element_text(angle = 45)) +
    scale_x_discrete(limits=c("Jan-March 2019", "March-May 2019", "Jan-March 2020", "March-May 2020", "Jan-March 2021", "March-May 2021")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_violin("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif", "US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif", "US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")
```


#### US time analysis (box plots).
```{r, eval = TRUE}
US_2019_boxplot <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2: 2019 Seasonal Change', 
          ylab='Date',
          names = c('2019 Jan-Mar', '2019 Mar-May'))
}
US_2019_boxplot("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif")

US_2020_boxplot <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('2020 Jan-Mar', '2020 Mar-May'))
}
US_2020_boxplot("US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif")

US_2021_boxplot <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="United States", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="United States", ])
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2: 2021 Seasonal Change', 
          ylab='Date',
          names = c('2021 Jan-Mar', '2021 Mar-May'))
}
US_2021_boxplot("US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")
```


#### China time analysis plots. 
```{r, eval = TRUE}
#Converting before lockdown and after lockdown rasters for China to data frames.
China.NO2.change.fxn <- function(file) {
  r <- raster(paste0('./China_NO2_comparison/', file)) %>%
  flip(direction='y') 
  df <- r %>% crop(., extent(wrld_simpl[wrld_simpl@data$NAME=="China", ])) %>% 
  mask(., wrld_simpl[wrld_simpl@data$NAME=="China", ]) %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() %>%
  select(NO2_Concentration = 1, Longitude = 2, Latitude = 3) 
  df
}

files <- c("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif", "China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif", "China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")

China.NO2.list <- purrr::map(files, China.NO2.change.fxn)

#Plotting before and after maps. 
China.NO2.change.map.fxn <- function(x, y, t1, t2) {
p1 <- ggplot() +
 geom_raster(data = x, aes(x = Longitude, y = Latitude, fill = NO2_Concentration)) + 
 geom_polygon(data = wrld_simpl[wrld_simpl@data$NAME=="China", ], aes(x = long, y = lat, group = group), colour = "black", size = 0.5, fill = NA) +
  my_theme() + 
  ggtitle(paste("China NO2 Concentrations (Sentinel Satellite)", t1)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(mol/m^2)", colours = myPalette(100), limits=c(0, 5.5E-4)) +
    north(x.min = 73, y.min = 18, x.max = 135, y.max = 54, anchor = c(x=84, y=28), symbol=12) +
    scalebar(x.min = 73, y.min = 18, x.max = 135, y.max = 54, dist = 250, dist_unit = 'km', transform = TRUE, anchor = c(x=84, y=22.5), st.size = 1.5, height = 0.02, model = 'WGS84') +
  xlim(73, 135) +
  ylim(18, 54) +
  coord_quickmap()
p2 <- ggplot() +
 geom_raster(data = y, aes(x = Longitude, y = Latitude, fill = NO2_Concentration)) + 
 geom_polygon(data = wrld_simpl[wrld_simpl@data$NAME=="China", ], aes(x = long, y = lat, group = group), colour = "black", size = 0.5, fill = NA) +
  my_theme() + 
  ggtitle(paste("China NO2 Concentrations (Sentinel Satellite)", t2)) +
  scale_fill_gradientn(name = "NO2 Concentration \n(ppb)", colours = myPalette(100), limits=c(0, 5.5E-4)) +
    north(x.min = 73, y.min = 18, x.max = 135, y.max = 54, anchor = c(x=84, y=28), symbol=12) +
    scalebar(x.min = 73, y.min = 18, x.max = 135, y.max = 54, dist = 250, dist_unit = 'km', transform = TRUE, anchor = c(x=84, y=22.5), st.size = 1.5, height = 0.02, model = 'WGS84') +
  xlim(73, 135) +
  ylim(18, 54) +
  coord_quickmap()
plot_grid(p1, p2, labels = "AUTO", ncol = 1)
}

China.NO2.change.map.fxn(data.frame(China.NO2.list[1]), data.frame(China.NO2.list[2]), "Nov-Jan 2019", "Jan-March 2019")
China.NO2.change.map.fxn(data.frame(China.NO2.list[3]), data.frame(China.NO2.list[4]), "Nov-Jan 2020", "Jan-March 2020")
China.NO2.change.map.fxn(data.frame(China.NO2.list[5]), data.frame(China.NO2.list[6]), "Nov-Jan 2021", "Jan-March 2021")
```

#### China time analysis (violin).
```{r, eval = TRUE}
#Function for finding medians over each time period. 
China_NO2_median <- function(x) {
  r <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  lapply(r.vals, FUN=median, na.rm = TRUE)
}
China_NO2_median("China_NO2_2019-11-23_start.tif")
China_NO2_median("China_NO2_2020-01-23_start.tif")

#Function for finding averages over each time period. 
China_NO2_average <- function(x) {
  r <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  lapply(r.vals, FUN=mean, na.rm = TRUE)
}
China_NO2_average("China_NO2_2019-11-23_start.tif")
China_NO2_average("China_NO2_2020-01-23_start.tif") 

#2019 violin plot
China_2019_violin <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2018-Jan2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    scale_x_discrete(limits=c("Nov2018-Jan2019", "Jan-March 2019")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_2019_violin("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif")

#2020 violin plot
China_2020_violin <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2019-Jan2020", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2 Before and After COVID-19') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    scale_x_discrete(limits=c("Nov2019-Jan2020", "Jan-March 2020")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_2020_violin("China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif")

#2021 violin plot
China_2021_violin <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2020-Jan2021", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2: 2021 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    scale_x_discrete(limits=c("Nov2020-Jan2021", "Jan-March 2021")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_2021_violin("China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")

#All violin plots in 1 graph: 
China_violin <- function(a, b, c, d, e, f) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (a))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2018-Jan2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (b))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  r3 <- raster(paste0("./China_NO2_Comparison/", (c))) %>% flip(direction='y')
  r3 <- crop(r3, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r3, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r3 <- r3 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2019-Jan2020", length.out = nrow(r3)) %>% as.data.frame()
  r3 <- cbind(vec, r3)
  names(r3)[1] <- "Timeframe"
  names(r3)[4] <- "NO2_Concentration"
  r4 <- raster(paste0("./China_NO2_Comparison/", (d))) %>% flip(direction='y')
  r4 <- crop(r4, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r4, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r4 <- r4 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r4)) %>% as.data.frame()
  r4 <- cbind(vec, r4)
  names(r4)[1] <- "Timeframe"
  names(r4)[4] <- "NO2_Concentration"
  r5 <- raster(paste0("./China_NO2_Comparison/", (e))) %>% flip(direction='y')
  r5 <- crop(r5, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r5, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r5 <- r5 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2020-Jan2021", length.out = nrow(r5)) %>% as.data.frame()
  r5 <- cbind(vec, r5)
  names(r5)[1] <- "Timeframe"
  names(r5)[4] <- "NO2_Concentration"
  r6 <- raster(paste0("./China_NO2_Comparison/", (f))) %>% flip(direction='y')
  r6 <- crop(r6, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r6, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r6 <- r6 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r6)) %>% as.data.frame()
  r6 <- cbind(vec, r6)
  names(r6)[1] <- "Timeframe"
  names(r6)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2, r3, r4, r5, r6)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    theme(axis.text.x = element_text(angle = 45)) +
    scale_x_discrete(limits=c("Nov2018-Jan2019", "Jan-March 2019", "Nov2019-Jan2020", "Jan-March 2020", "Nov2020-Jan2021", "Jan-March 2021")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_violin("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif", "China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif", "China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")
```


#### China time analysis (boxplots).
```{r, eval = TRUE}
China_2019_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2: 2019 Seasonal Change', 
          ylab='Date',
          names = c('Nov2018-Jan2019', 'Jan-March 2019'))
}
China_2019_change("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif")

China_2020_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('Nov2019-Jan2020', 'Jan-March 2020'))
}
China_2020_change("China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif")

China_2021_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r1, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(wrld_simpl[wrld_simpl@data$NAME=="China", ]))
  mask(r2, wrld_simpl[wrld_simpl@data$NAME=="China", ])
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2: 2021 Seasonal Change', 
          ylab='Date',
          names = c('Nov2020-Jan2021', 'jan-March 2021'))
}
China_2021_change("China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")
```

***
