---
title: "NO2 and COVID-19"
author: "Alana Schreibman"
date: "5/27/2021"
output: 
  html_document:
    toc: true
    toc_float: 
        collapsed: true
        smooth_scroll: true
    depth: 3 
    theme: cosmo
    highlight: pygments
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r, eval = TRUE}
#Load libraries needed. 
library(easypackages)
libraries("rgdal", "gdalUtils", "raster", "maptools", "ggplot2", "cowplot", "dplyr", "sp", "sf", "rgdal", "stringr", "RColorBrewer")
```

###Merging NO2 data with COVID data for analysis.  
####United States data. (delete later, code generalized below)
```{r, eval = TRUE}
#Reading in US data from Earth Engine. 
continental.US.NO2.r <- raster('continental_us.tif') %>%
  flip(direction='y')
plot(continental.US.NO2.r)

#Reading in shapefile and filtering for US only.
data(wrld_simpl)
wrld_simpl@data[["NAME"]]
plot(wrld_simpl) 
us.shp <- wrld_simpl[wrld_simpl$NAME=="United States", ]
plot(us.shp)

wrld_simpl[wrld_simpl$NAME=="Israel", ]

#More exploration on raster NO2 file. 
head(continental.US.NO2.r)
dim(continental.US.NO2.r)
plot(continental.US.NO2.r)
plot(wrld_simpl[wrld_simpl$NAME=="United States", ], add = TRUE)
str(continental.US.NO2.r)

#Extracting mean NO2 values for US and adding to coordinates data to make final data frame.
r.vals <- raster::extract(continental.US.NO2.r, us.shp)
r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
final.df <- data.frame(us.shp@data, r.mean)  
rm(r.mean, r.vals)
names(final.df)[12] <- "NO2_Concentration"
names(final.df)[5] <- "location"
head(final.df)

#Merged geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
covid.NO2 <- merge(owid.filtered, final.df, by = "location")
```

####Formatting data for selected 10 countries. (delete later, code generalized below)
```{r, eval = TRUE}
#Reading in US data from Earth Engine. 
UnitedStates.NO2.r <- raster('./COVID_comparison/United States_NO2.tif') %>%
  flip(direction='y')
China.NO2.r <- raster('./COVID_comparison/China_NO2.tif') %>%
  flip(direction='y')
India.NO2.r <- raster('./COVID_comparison/India_NO2.tif') %>%
  flip(direction='y')
Italy.NO2.r <- raster('./COVID_comparison/Italy_NO2.tif') %>%
  flip(direction='y')
Brazil.NO2.r <- raster('./COVID_comparison/Brazil_NO2.tif') %>%
  flip(direction='y')
Peru.NO2.r <- raster('./COVID_comparison/Peru_NO2.tif') %>%
  flip(direction='y')
Israel.NO2.r <- raster('./COVID_comparison/Israel_NO2.tif') %>%
  flip(direction='y')
Argentina.NO2.r <- raster('./COVID_comparison/Argentina_NO2.tif') %>%
  flip(direction='y')
Russia.NO2.r <- raster('./COVID_comparison/Russia_NO2.tif') %>%
  flip(direction='y')
UnitedKingdom.NO2.r <- raster('./COVID_comparison/United Kingdom_NO2.tif') %>%
  flip(direction='y')
plot(Russia.NO2.r)
plot(Russia.shp, add = TRUE)
head(Russia.NO2.r)

#Shapefiles for 10 countries with high COVID cases. 
countries.shp.fxn <- function(x) {
  wrld_simpl[wrld_simpl$NAME==x, ]
}
for(i in c("United States", "China", "India", "Italy", "Brazil", "Peru", "Israel", "Argentina", "Russia", "United Kingdom")) {  
  assign(paste0(i, ".shp"), countries.shp.fxn(i)) 
}

#Extracting mean NO2 values and adding to coordinates data to make final data frame. Then, merge geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
mean.NO2.fxn <- function(raster, shp, country) {
  r.vals <- raster::extract(raster, shp)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(shp@data, r.mean)  
  names(final.df)[12] <- "NO2_Concentration" #Average NO2 concentration in mol/m^2 from July 10 2018 to July 10 2019. 
  names(final.df)[5] <- "location"
  final.df <- merge(owid.filtered, final.df, by = "location")
  assign(paste0(country, ".df"), final.df, .GlobalEnv)
}
mean.NO2.fxn(UnitedStates.NO2.r, `United States.shp`, "UnitedStates")
mean.NO2.fxn(China.NO2.r, `China.shp`, "China")
mean.NO2.fxn(India.NO2.r, `India.shp`, "India")
mean.NO2.fxn(Italy.NO2.r, `Italy.shp`, "Italy")
mean.NO2.fxn(Brazil.NO2.r, `Brazil.shp`, "Brazil")
mean.NO2.fxn(Peru.NO2.r, `Peru.shp`, "Peru")
mean.NO2.fxn(Israel.NO2.r, `Israel.shp`, "Israel")
mean.NO2.fxn(Argentina.NO2.r, `Argentina.shp`, "Argentina")
mean.NO2.fxn(Russia.NO2.r, `Russia.shp`, "Russia")
mean.NO2.fxn(UnitedKingdom.NO2.r, `United Kingdom.shp`, "UnitedKingdom")

COVID_NO2.df <- Reduce(function(...) merge(..., all=TRUE), list(UnitedStates.df, China.df, India.df, Italy.df, Brazil.df, Peru.df, Israel.df, Argentina.df, Russia.df, UnitedKingdom.df)) #Joins rows into one data frame. 

#Fix for loop later. 
for(i in c("UnitedStates.NO2.r", "China.NO2.r", "India.NO2.r", "Italy.NO2.r", "Brazil.NO2.r", "Peru.NO2.r", "Israel.NO2.r", "Argentina.NO2.r", "Russia.NO2.r", "UnitedKingdom.NO2.r")) { 
  for(j in c("United States.shp", "China.shp", "India.shp", "Italy.shp", "Brazil.shp", "Peru.shp", "Israel.shp", "Argentina.shp", "Russia.shp", "United Kingdom.shp")) {
    for (k in c("UnitedStates", "China", "India", "Italy", "Brazil", "Peru", "Israel", "Argentina", "Russia", "UnitedKingdom")) {
    print(mean.NO2.fxn(i, j, k))
    }
  }
}
```

####Analysis for selected 10 countries. (delete later, code generalized below)
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = COVID_NO2.df, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. NO2 Concentration") 
cor(COVID_NO2.df$totcases.mil, COVID_NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age, data = COVID_NO2.df)
summary.lm(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = COVID_NO2.df, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. NO2 Concentration") 
cor(COVID_NO2.df$totdeaths.mil, COVID_NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age, data = COVID_NO2.df)
summary.lm(NO2.lm.cases) #Summary statistics for linear fit. 

#look at correlations w other country characteristics 
```

###Creating mosaic of half-world raster files and reading in world satellite data. 
```{r, eval = TRUE}
setwd("./World_Rasters")
left <- raster('Left_Half_World_NO2.tif') %>%
  flip(direction='y') 
right <- raster('Right_Half_World_NO2.tif') %>%
  flip(direction='y') 
x <- list(left, right)
names(x)[1:2] <- c('x', 'y')
x$fun <- mean
x$na.rm <- TRUE

world.NO2.r <- do.call(mosaic, x)
plot(world.NO2.r)
plot(wrld_simpl, add = TRUE)
rm(left, right, x)
```

####Preparing data for world analysis. 
```{r, eval = TRUE}
country.list <- as.character(wrld_simpl@data$NAME)
 
countries.shp.fxn <- function(x) {
  wrld_simpl[wrld_simpl$NAME==x, ]
}
#Makes shapefile for each country from world shapefile. 
for(i in country.list){
  assign(paste0(i, ".shp"), countries.shp.fxn(i)) 
}

#Function to extract mean NO2 values by country shapefile. 
extraction.fxn <- function(x) {
  r.vals <- raster::extract(world.NO2.r, x)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(x@data, r.mean)  
  rm(r.mean, r.vals)
  names(final.df)[5] <- "location" 
  names(final.df)[6] <- "Area" 
  names(final.df)[8] <- "Region" 
  names(final.df)[9] <- "Subregion" 
  names(final.df)[10] <- "Longitude" 
  names(final.df)[11] <- "Latitude" 
  names(final.df)[12] <- "NO2_Concentration"
  final.df <- final.df %>% select(location, Area, Region, Subregion, Longitude, Latitude, NO2_Concentration)
}

#Changing shapefile names to match COVID dataset:
Brunei.shp <- `Brunei Darussalam.shp`
  rm(`Brunei Darussalam.shp`)
Czechia.shp <- `Czech Republic.shp`
  rm(`Czech Republic.shp`)
`Democratic Republic of Congo.shp` <- `Democratic Republic of the Congo.shp`
  rm(`Democratic Republic of the Congo.shp`)
Iran.shp <- `Iran (Islamic Republic of).shp`
  rm(`Iran (Islamic Republic of).shp`)
Laos.shp <-  `Lao People's Democratic Republic.shp`
  rm(`Lao People's Democratic Republic.shp`)
Libya.shp <- `Libyan Arab Jamahiriya.shp`
  rm(`Libyan Arab Jamahiriya.shp`)
Moldova.shp <- `Republic of Moldova.shp`
  rm(`Republic of Moldova.shp`)
Myanmar.shp <- Burma.shp
  rm(Burma.shp)
`South Korea.shp` <- `Korea, Republic of.shp`
  rm(`Korea, Republic of.shp`)
`North Korea.shp` <- `Korea, Democratic People's Republic of.shp`
  rm(`Korea, Democratic People's Republic of.shp`)
`South Sudan.shp` <- `Sudan.shp`
  rm(Sudan.shp)
`Syria.shp` <- `Syrian Arab Republic.shp`
  rm(`Syrian Arab Republic.shp`)
`North Macedonia.shp` <- `The former Yugoslav Republic of Macedonia.shp`
  rm(`The Former Yugoslav Republic of Macedonia.shp`)
Timor.shp <- `Timor-Leste.shp`
  rm(`Timor-Leste.shp`)
Vatican.shp <- `Holy See (Vatican City).shp`
 rm(`Holy See (Vatican City).shp`)
Vietnam.shp <- `Viet Nam.shp`
  rm(`Viet Nam.shp`)

#Extracting mean NO2 values and adding to coordinates data to make final data frame.
  #Missing from shapefiles: Kosovo, Tanzania, Eswatini, Tanzania
total.df = data.frame()
for (i in c(Afghanistan.shp, Albania.shp, Algeria.shp, Andorra.shp, Angola.shp, `Antigua and Barbuda.shp`, Argentina.shp, Armenia.shp, Australia.shp, Austria.shp, Azerbaijan.shp, Bahamas.shp, Bahrain.shp, Bangladesh.shp, Barbados.shp, Belarus.shp, Belgium.shp, Belize.shp, Benin.shp, Bhutan.shp, Bolivia.shp, `Bosnia and Herzegovina.shp`, Botswana.shp, Brazil.shp, Brunei.shp, Bulgaria.shp, `Burkina Faso.shp`, Burundi.shp, Cambodia.shp, Cameroon.shp, Canada.shp, `Cape Verde.shp`, `Central African Republic.shp`, Chad.shp, Chile.shp, China.shp, Colombia.shp, Comoros.shp, Congo.shp, `Costa Rica.shp`, `Cote d'Ivoire.shp`, Croatia.shp, Cuba.shp, Cyprus.shp, Czechia.shp, `Democratic Republic of Congo.shp`, Denmark.shp, Djibouti.shp, Dominica.shp, `Dominican Republic.shp`, Ecuador.shp, Egypt.shp, `El Salvador.shp`, `Equatorial Guinea.shp`, Eritrea.shp, Estonia.shp, Ethiopia.shp, Fiji.shp, Finland.shp, France.shp, Gabon.shp, Gambia.shp, Georgia.shp, Germany.shp, Ghana.shp, Greece.shp, Grenada.shp, Guatemala.shp, Guinea.shp, `Guinea-Bissau.shp`, Guyana.shp, Haiti.shp, Honduras.shp, `Hong Kong.shp`, Hungary.shp, Iceland.shp, India.shp, Indonesia.shp, Iran.shp, Ireland.shp, Israel.shp, Italy.shp, Jamaica.shp, Japan.shp, Jordan.shp, Kazakhstan.shp, Kenya.shp, Kuwait.shp, Kyrgyzstan.shp, Laos.shp, Latvia.shp, Lebanon.shp, Lesotho.shp, Liberia.shp, Libya.shp, Liechtenstein.shp, Lithuania.shp, Luxembourg.shp, Madagascar.shp, Malawi.shp, Malaysia.shp, Maldives.shp, Mali.shp, Malta.shp, Mauritania.shp, Mauritius.shp, Mexico.shp, Moldova.shp, Monaco.shp, Mongolia.shp, Montenegro.shp, Morocco.shp, Mozambique.shp, Myanmar.shp, Namibia.shp, Nepal.shp, Netherlands.shp, `New Zealand.shp`, Nicaragua.shp, Niger.shp, Nigeria.shp, `North Macedonia.shp`, Norway.shp, Oman.shp, Pakistan.shp, Palestine.shp, Panama.shp, `Papua New Guinea.shp`, Paraguay.shp, Peru.shp, Philippines.shp, Poland.shp, Portugal.shp, Qatar.shp, Romania.shp, Russia.shp, Rwanda.shp, `Saint Kitts and Nevis.shp`, `Saint Lucia.shp`, `Saint Vincent and the Grenadines.shp`, `San Marino.shp`, `Sao Tome and Principe.shp`, `Saudi Arabia.shp`, Senegal.shp, Serbia.shp, Seychelles.shp, `Sierra Leone.shp`, Singapore.shp, Slovakia.shp, Slovenia.shp, Somalia.shp, `South Africa.shp`, `South Korea.shp`, `South Sudan.shp`, Spain.shp, `Sri Lanka.shp`, `South Sudan.shp`, Suriname.shp, Sweden.shp, Switzerland.shp, Syria.shp, Taiwan.shp, Tajikistan.shp, Thailand.shp, Timor.shp, Togo.shp, `Trinidad and Tobago.shp`, Tunisia.shp, Turkey.shp, Uganda.shp, Ukraine.shp, `United Arab Emirates.shp`, `United Kingdom.shp`, `United States.shp`, Uruguay.shp, Uzbekistan.shp, Vatican.shp, Venezuela.shp, Vietnam.shp, Yemen.shp, Zambia.shp, Zimbabwe.shp)){
    # vector output
    country.df <- extraction.fxn(i) 
    # add vector to premade dataframe
    df <- data.frame(country.df)
    total.df <- rbind(total.df,df)
}

#Merged geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
covid.NO2.df <- merge(owid.countries, total.df, by = "location")
```

####World Analysis with COVID outcomes. 
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totcases.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age, data = covid.NO2.df)
summary.lm(NO2.lm.cases)
confint(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = covid.NO2.df, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. NO2 Concentration") 
cor(covid.NO2.df$totdeaths.mil, covid.NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.deaths <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age, data = covid.NO2.df,)
summary.lm(NO2.lm.deaths)
confint(NO2.lm.deaths) #Summary statistics for linear fit.
```

####Continent Analysis with COVID outcomes. 
```{r, eval = TRUE}
cases.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = NO2_Concentration, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (continent = x), " vs. NO2 Concentration"))
} 
NO2.lm.cases.cont <- function(x) {
                        covid.NO2.df %>%
                        filter(continent == x) %>%
                        lm(totcases.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age,.) %>%
                        summary.lm()  
} #Function for linear regression statistics to be included in for loop below. 

for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
   print(cases.NO2(i)) 
   print(NO2.lm.cases.cont(i)) 
} #Loops function for continents of interest. 

deaths.NO2 <- function(x) { 
                    covid.NO2.df %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = NO2_Concentration, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (continent = x), " vs. NO2 Concentration"))
} 
NO2.lm.deaths.cont <- function(x) {
                        covid.NO2.df %>%
                        filter(continent == x) %>%
                        lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
   print(deaths.NO2(i)) 
   print(NO2.lm.deaths.cont(i)) 
} #Loops function for continents of interest. 
```

###Correlation analysis: United States, satellite vs. ground EPA. 
####Formatting sattelite and ground data. 
```{r, eval = TRUE}
#Getting satellite data specifically for this time frame. 
July_Oct2018.sat.r <- raster('US_ground_NO2/US_NO2_2018-07-01_start.tif') %>%
  flip(direction='y')
July_Oct2018.sat.r <- crop(July_Oct2018.sat.r, extent(us.shp))
July_Oct2018.sat.r <- mask(July_Oct2018.sat.r, us.shp)

#Direct conversion from NO2 raster to data frame while filtering by shapefile. 
continental.US.fxn <- function(x) {
  r1 <- raster(x) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  r1 <- mask(r1, `United States.shp`)
  r1 <- rasterToPoints(r1, spatial = TRUE) 
  July_Oct2018.sat <- data.frame(r1) %>% 
      select(!("optional")) %>%
      select( "y", "x", "US_NO2_2018.07.01_start")
  July_Oct2018.sat <- rename(July_Oct2018.sat, Latitude = y, Longitude = x, NO2_concentration = US_NO2_2018.07.01_start)
  assign("July_Oct2018.sat", July_Oct2018.sat, .GlobalEnv)
  July_Oct2018.sat
}  #Final satellite data to use for comparison to EPA data. 
continental.US.fxn("US_ground_NO2/US_NO2_2018-07-01_start.tif")

#Selecting just latitude and longitude from data frame just made to use with Pargasite retrieval. 
US.lat.lon <- July_Oct2018.sat %>% select(c(Latitude, Longitude))
# write.csv(US.lat.lon, file.path("US_ground_NO2", "US_lat_lon.csv"), row.names = FALSE) #Used to gather EPA data from Pargasite. 

#Reading in EPA data
#Problem w Pargasite: only overlapping time frame is July 2018 - October 2018 (Pargasite stops working in November 2018)
July_Oct2018.ground <- read.csv(file = './US_ground_NO2/July_Oct2018NO2.csv') %>% select(c("Latitude", "Longitude", "no2_estimate")) %>% rename(NO2_concentration = no2_estimate)
July_Oct2018.ground <- data.frame(July_Oct2018.ground)
July_Oct2018.ground #Final EPA data to use in comparison to satellite data. 

#EPA data frame changed to raster format.
July_Oct2018.ground.r <- July_Oct2018.ground %>% select(c("Longitude", "Latitude", "NO2_concentration")) %>% rasterFromXYZ() 
```

####Checking for satellite data correlation to ground data.
```{r, eval = TRUE}
#Resampling raster data to be same size for comparisons. 
July_Oct2018.sat.r.re <- July_Oct2018.sat.r %>% resample(July_Oct2018.ground.r)
plot(July_Oct2018.sat.r.re)

#Perform correlation test between satellite and ground rasters. 
cor(values(July_Oct2018.sat.r.re),
    values(July_Oct2018.ground.r),
    use = "na.or.complete")

#Linear model estimation. 
lm1 <- lm(values(July_Oct2018.sat.r.re) ~ values(July_Oct2018.ground.r))
summary(lm1)

#Local correlation estimates--shows where locally on map specific regions are positively or negatively correlated. (Getting an error: code from this website https://statnmap.com/2018-01-27-spatial-correlation-between-rasters/)
values(July_Oct2018.sat.r.re) <- 1:ncell(July_Oct2018.sat.r.re)

matrix_ground <- values(July_Oct2018.ground.r)

focal_cor <- focal(
  x = July_Oct2018.sat.r.re,
  w = matrix(1, 5, 5),
  # fun = function(x, y = temp_chl_s){ # Original
    # cor(values(y)[x, 1], values(y)[x, 2], # Original
        # use = "na.or.complete")
  # },
  fun = function(x, y = matrix_ground){ # [MW]
    cor(y[x, 1], y[x, 2], # [MW]
        use = "na.or.complete")
  },
  filename = file.path("focal_cor.tif"),
  overwrite = TRUE
)
```

####Plotting satellite vs ground data. 
```{r, eval = TRUE}
ggplot() +
    geom_raster(data = July_Oct2018.sat, aes(x = Longitude, y = Latitude, fill = NO2_concentration)) +
    scale_fill_viridis_c() +
    ggtitle("NO2 US Satellite Data, July-Oct 2018") + 
    labs(fill = "NO2 Concentration \n(mol/m^2)") +
    coord_quickmap()

ggplot() +
    geom_raster(data = July_Oct2018.ground, aes(x = Longitude, y = Latitude, fill = NO2_concentration)) +
    scale_fill_viridis_c() +
    ggtitle("NO2 US EPA Ground Data, July-Oct 2018") + 
    labs(fill = "NO2 Concentration \n(ppb)") +
    coord_quickmap()
```

###Correlation analysis: China, satellite vs. ground data. 
####Formatting sattelite and ground data to be used for correlation analysis (China only). 
```{r, eval = TRUE}
#No success in retrieving data so far. 

#Getting satellite data specifically for this time frame. 
July_Oct2018.sat.r <- raster('July2018-Oct2018.tif') %>%
  flip(direction='y')
July_Oct2018.sat.r <- crop(July_Oct2018.sat.r, extent(`United States.shp`))
July_Oct2018.sat.r <- mask(July_Oct2018.sat.r, `United States.shp`)
plot(July_Oct2018.sat.r)
plot(us.shp, add = TRUE)
```

###Time-analysis: NO2 changes during the COVID-19 pandemic.
####World time analysis: interrupted series time analysis data preparation. 
```{r, eval = TRUE}
#US first to create code; others later. 
#Use function in other NO2_Exploratory Analysis file to filter out each week from Jan-Dec 2019 and Jan-Dec 2020 for comparison.

#Used code:
`gsutil -m cp \`
` >   "file names" \`
` >   COVID-19_NO2/time_analysis_2020`

# in terminal to copy all files from google cloud storage into folders in working directory. 

#2019 data. 
#Creates list of raster files from folder to call in function. 
rastlist.2019 <- list.files(path = "time_analysis_2019", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2019 <- seq(as.Date("2018-12-31"), as.Date("2019-12-29"), by=7) #List of dates starting Dec 31 2018. 

#Function to make data frame for weekly average NO2 concentration. 
read.fxn <- function(x, y) {
  r <- raster(paste0("time_analysis_2019/", x))
  r.vals <- raster::extract(r, `United States.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(`United States.shp`@data, r.mean)  
  Date <- as.Date(dates.2019[[y]])
  Week <- paste0(as.character(as.Date(dates.2019[[y]])), " to ", as.character(as.Date(dates.2019[[y]]) + 6)) 
  Period <- rep(2019, length.out = nrow(final.df)) 
  US.2019.weekly <- cbind(final.df, Date, Week, Period) 
  US.2019.weekly <- US.2019.weekly %>% dplyr::mutate(Date = as.factor(strftime(as.Date(Date, format="%Y-%m-%d"), format="%m-%d")))
  rm(r.mean, r.vals)
  names(US.2019.weekly)[12] <- "NO2_Concentration"
  US.2019.weekly <- US.2019.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- rastlist.2019
y <- 1:length(dates.2019)
US.2019.weekly.df <- purrr::map2_dfr(x, y, read.fxn) 
US.2019.weekly.df$Date <- paste0("2020-", US.2019.weekly.df$Date)

#2020 data.  
#Creates list of raster files from folder to call in function. 
rastlist.2020 <- list.files(path = "time_analysis_2020", pattern='.tif$', 
all.files=TRUE, full.names=FALSE)

#Creates list of dates to call in function. 
dates.2020 <- seq(as.Date("2019-12-30"), as.Date("2021-01-03"), by=7) #List of dates starting Dec 30th 2019. 

#Function to make data frame for weekly average NO2 concentration. 
read.fxn <- function(x, y) {
  r <- raster(paste0("time_analysis_2020/", x))
  r.vals <- raster::extract(r, `United States.shp`)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(`United States.shp`@data, r.mean)   
  Date <- as.factor(as.Date(dates.2020[[y]]))
  Week <- paste0(as.character(as.Date(dates.2020[[y]])), " to ", as.character(as.Date(dates.2020[[y]]) + 6)) 
  Period <- rep(2020, length.out = nrow(final.df)) 
  US.2020.weekly <- cbind(final.df, Date, Week, Period)     # Add new column to data
  rm(r.mean, r.vals)
  names(US.2020.weekly)[12] <- "NO2_Concentration"
  US.2020.weekly <- US.2020.weekly %>% select(Period, Date, Week, NO2_Concentration)
}

x <- rastlist.2020
y <- 1:length(dates.2020)
US.2020.weekly.df <- purrr::map2_dfr(x, y, read.fxn) 
US.weekly.df <- rbind(US.2019.weekly.df, US.2020.weekly.df) 
US.weekly.df$Date <- as.Date(US.weekly.df$Date)
US.weekly.df$Period <- as.factor(US.weekly.df$Period)
```

####World time analysis: interrupted series time analysis plots.
```{r, fig.width=20, fig.height=4, eval = TRUE}
ggplot(US.weekly.df, aes(x = Date, y = NO2_Concentration, group = Period, color = Period)) +
  geom_line(size = 0.75) + 
  theme(legend.key.size = unit(1, 'cm'),
        legend.title = element_text(size=14),
        legend.text = element_text(size=10),
        axis.title=element_text(size = 20),
        axis.text.y=element_text(size=24),
        axis.text.x=element_text(size=30,angle=90, hjust=1)) +
  labs(fill = "Year of Measured Pollution") +
  ggtitle("US NO2 in 2019 vs 2020") +
  ylab("NO2 Concentration (mol/m^2)") +
  scale_x_date(date_labels = "%b",date_breaks = "1 month",expand=c(0,0),limits=c(as.Date("2019-12-25",format="%Y-%m-%d"),as.Date("2020-12-31",format="%Y-%m-%d"))) +
ylim(0, 3E-5) +
  
    #Pre-lockdown
  geom_rect(data=US.weekly.df,aes(xmin=as.Date("2019-12-25",format="%Y-%m-%d"),xmax=as.Date("2020-03-19",format="%Y-%m-%d"),ymin=2.9E-5,ymax=3E-5),fill = "#c0c0c0",color = NA, alpha=0.02) +
  geom_text(data=US.weekly.df,aes(x=as.Date("2020-02-07"),y=2.95E-5),label="Pre-Lockdown",color = "black", size = 2) +
  geom_vline(data=US.weekly.df,xintercept = as.Date("2020-03-19",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 1
  geom_rect(data=US.weekly.df,aes(xmin=as.Date("2020-03-19",format="%Y-%m-%d"),xmax=as.Date("2020-06-05",format="%Y-%m-%d"),ymin=2.9E-5,ymax=3E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=US.weekly.df,aes(x=as.Date("2020-05-01"),y=2.95E-5),label="Lockdown 1", color = "black", size = 2) +
  geom_vline(data=US.weekly.df,xintercept=as.Date("2020-06-05",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Re-opening Green PHASE
  geom_rect(data=US.weekly.df,aes(xmin=as.Date("2020-06-05",format="%Y-%m-%d"),xmax=as.Date("2020-11-16",format="%Y-%m-%d"), ymin=2.9E-5,ymax=3E-5),fill = "#b5dea5",color = NA,alpha=0.02) +
  geom_text(data=US.weekly.df,aes(x=as.Date("2020-08-15"),y=2.95E-5),label="Re-Opening", color = "black", size = 2) +
  geom_vline(data=US.weekly.df,xintercept=as.Date("2020-11-16",format="%Y-%m-%d"),linetype="dashed",colour="black",size=0.75,alpha=0.8) + 
  #Lockdown 2
  geom_rect(data=US.weekly.df,aes(xmin=as.Date("2020-11-16",format="%Y-%m-%d"),xmax=as.Date("2020-12-31",format="%Y-%m-%d"), ymin=2.9E-5,ymax=3E-5),fill = "#fa9796",color = NA,alpha=0.02) +
  geom_text(data=US.weekly.df,aes(x=as.Date("2020-12-10"),y=2.95E-5),label="Lockdown 2", color = "black", size = 2) +
  theme_bw() + 
  scale_alpha_manual(values = c(0.4, 1.1)) + 
  scale_color_manual(values = c("gray", "blue", "black")) +
  ggsave("time_series.pdf")
```

####US time analysis plots. 
```{r, eval = TRUE}
#Converting before lockdown and after lockdown rasters for US to data frames.  
before.lockdown <- raster('./US_NO2_comparison/US_NO2_2020-01-19_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
before.lockdown <- before.lockdown %>%
  rename(c(NO2_concentration = US_NO2_2020.01.19_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

after.lockdown <- raster('./US_NO2_comparison/US_NO2_2020-03-19_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
after.lockdown <- after.lockdown %>%
  rename(c(NO2_concentration = US_NO2_2020.03.19_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

#Plotting before and after maps. 
p1 <- ggplot() +
  geom_raster(data = before.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = `United States.shp`, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap(
    xlim = c(-123, -65),
    ylim = c(23, 49)
  ) + 
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.00015)) +
  ggtitle("US NO2 Concentrations (Sentinel Satellite) Before COVID-19 Lockdown")
  
p2 <- ggplot() +
  geom_raster(data = after.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = `United States.shp`, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap(
    xlim = c(-123, -65),
    ylim = c(23, 49)
  ) + 
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.00015)) +
  ggtitle("US NO2 Concentrations (Sentinel Satellite) After COVID-19 Lockdown")

plot_grid(p1, p2, labels = "AUTO", ncol = 1)
rm(p1, p2)
```

####US time analysis (violin plots).
```{r, eval = TRUE}
#Function for finding medians over each time period. 
US_NO2_median <- function(x) {
  r <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, `United States.shp`)
  lapply(r.vals, FUN=median, na.rm = TRUE)
}
US_NO2_median("US_NO2_2020-01-19_start.tif")
US_NO2_median("US_NO2_2020-03-19_start.tif")

#Function for finding averages over each time period. 
US_NO2_average <- function(x) {
  r <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, `United States.shp`)
  lapply(r.vals, FUN=mean, na.rm = TRUE)
}
US_NO2_average("US_NO2_2020-01-19_start.tif")
US_NO2_average("US_NO2_2020-03-19_start.tif")

#2019 violin plot
US_2019_violin <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_2019_violin("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif")

#2020 violin plot
US_2020_violin <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2020", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2 Before and After COVID-19') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_2020_violin("US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif")

#2021 violin plot
US_2021_violin <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(us.shp))
  mask(r2, us.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2021", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2: 2021 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_2021_violin("US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")

#All violin plots in 1 graph:
US_violin <- function(a, b, c, d, e, f) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (a))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./US_NO2_Comparison/", (b))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  r3 <- raster(paste0("./US_NO2_Comparison/", (c))) %>% flip(direction='y')
  r3 <- crop(r3, extent(`United States.shp`))
  mask(r3, `United States.shp`)
  r3 <- r3 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r3)) %>% as.data.frame()
  r3 <- cbind(vec, r3)
  names(r3)[1] <- "Timeframe"
  names(r3)[4] <- "NO2_Concentration"
  r4 <- raster(paste0("./US_NO2_Comparison/", (d))) %>% flip(direction='y')
  r4 <- crop(r4, extent(`United States.shp`))
  mask(r4, `United States.shp`)
  r4 <- r4 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2020", length.out = nrow(r4)) %>% as.data.frame()
  r4 <- cbind(vec, r4)
  names(r4)[1] <- "Timeframe"
  names(r4)[4] <- "NO2_Concentration"
  r5 <- raster(paste0("./US_NO2_Comparison/", (e))) %>% flip(direction='y')
  r5 <- crop(r5, extent(`United States.shp`))
  mask(r5, `United States.shp`)
  r5 <- r5 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r5)) %>% as.data.frame()
  r5 <- cbind(vec, r5)
  names(r5)[1] <- "Timeframe"
  names(r5)[4] <- "NO2_Concentration"
  r6 <- raster(paste0("./US_NO2_Comparison/", (f))) %>% flip(direction='y')
  r6 <- crop(r6, extent(`United States.shp`))
  mask(r6, `United States.shp`)
  r6 <- r6 %>% rasterToPoints() %>% data.frame()
  vec <- rep("March-May 2021", length.out = nrow(r6)) %>% as.data.frame()
  r6 <- cbind(vec, r6)
  names(r6)[1] <- "Timeframe"
  names(r6)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2, r3, r4, r5, r6)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('US NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    theme(axis.text.x = element_text(angle = 45)) +
    scale_x_discrete(limits=c("Jan-March 2019", "March-May 2019", "Jan-March 2020", "March-May 2020", "Jan-March 2021", "March-May 2021")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
US_violin("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif", "US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif", "US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")
```

####US time analysis (box plots).
```{r, eval = TRUE}
US_2019_boxplot <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2: 2019 Seasonal Change', 
          ylab='Date',
          names = c('2019 Jan-Mar', '2019 Mar-May'))
}
US_2019_boxplot("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif")

US_2020_boxplot <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('2020 Jan-Mar', '2020 Mar-May'))
}
US_2020_boxplot("US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif")

US_2021_boxplot <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(`United States.shp`))
  mask(r1, `United States.shp`)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(`United States.shp`))
  mask(r2, `United States.shp`)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2: 2021 Seasonal Change', 
          ylab='Date',
          names = c('2021 Jan-Mar', '2021 Mar-May'))
}
US_2021_boxplot("US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")
```

####China time analysis plots. 
```{r, eval = TRUE}
China.shp <- wrld_simpl[wrld_simpl$NAME=="China", ]

#Converting before lockdown and after lockdown rasters for US to data frames.  
before.lockdown <- raster('./China_NO2_comparison/China_NO2_2019-11-23_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
before.lockdown <- before.lockdown %>%
  rename(c(NO2_concentration = China_NO2_2019.11.23_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

after.lockdown <- raster('./China_NO2_comparison/China_NO2_2020-01-23_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
after.lockdown <- after.lockdown %>%
  rename(c(NO2_concentration = China_NO2_2020.01.23_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

#Plotting before and after maps. 
p1 <- ggplot() +
  geom_raster(data = before.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = China.shp, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap() +
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.0005)) +
  ggtitle("China NO2 Concentrations (Sentinel Satellite) Before COVID-19 Lockdown")
  
p2 <- ggplot() +
  geom_raster(data = after.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = China.shp, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap() +
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.0005)) +
  ggtitle("China NO2 Concentrations (Sentinel Satellite) After COVID-19 Lockdown")

plot_grid(p1, p2, labels = "AUTO", ncol = 1)
rm(p1, p2)
```

####China time analysis (violin).
```{r, eval = TRUE}
#Function for finding medians over each time period. 
China_NO2_median <- function(x) {
  r <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, China.shp)
  lapply(r.vals, FUN=median, na.rm = TRUE)
}
China_NO2_median("China_NO2_2019-11-23_start.tif")
China_NO2_median("China_NO2_2020-01-23_start.tif")

#Function for finding averages over each time period. 
China_NO2_average <- function(x) {
  r <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, China.shp)
  lapply(r.vals, FUN=mean, na.rm = TRUE)
}
China_NO2_average("China_NO2_2019-11-23_start.tif")
China_NO2_average("China_NO2_2020-01-23_start.tif") 

#2019 violin plot
China_2019_violin <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, China.shp)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2018-Jan2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, China.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    scale_x_discrete(limits=c("Nov2018-Jan2019", "Jan-March 2019")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_2019_violin("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif")

#2020 violin plot
China_2020_violin <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, China.shp)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2019-Jan2020", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, China.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2 Before and After COVID-19') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    scale_x_discrete(limits=c("Nov2019-Jan2020", "Jan-March 2020")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_2020_violin("China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif")

#2021 violin plot
China_2021_violin <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, China.shp)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2020-Jan2021", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, China.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2: 2021 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    scale_x_discrete(limits=c("Nov2020-Jan2021", "Jan-March 2021")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_2021_violin("China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")

#All violin plots in 1 graph: 
China_violin <- function(a, b, c, d, e, f) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (a))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, China.shp)
  r1 <- r1 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2018-Jan2019", length.out = nrow(r1)) %>% as.data.frame()
  r1 <- cbind(vec, r1)
  names(r1)[1] <- "Timeframe"
  names(r1)[4] <- "NO2_Concentration"
  r2 <- raster(paste0("./China_NO2_Comparison/", (b))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, China.shp)
  r2 <- r2 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2019", length.out = nrow(r2)) %>% as.data.frame()
  r2 <- cbind(vec, r2)
  names(r2)[1] <- "Timeframe"
  names(r2)[4] <- "NO2_Concentration"
  r3 <- raster(paste0("./China_NO2_Comparison/", (c))) %>% flip(direction='y')
  r3 <- crop(r3, extent(China.shp))
  mask(r3, China.shp)
  r3 <- r3 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2019-Jan2020", length.out = nrow(r3)) %>% as.data.frame()
  r3 <- cbind(vec, r3)
  names(r3)[1] <- "Timeframe"
  names(r3)[4] <- "NO2_Concentration"
  r4 <- raster(paste0("./China_NO2_Comparison/", (d))) %>% flip(direction='y')
  r4 <- crop(r4, extent(China.shp))
  mask(r4, China.shp)
  r4 <- r4 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2020", length.out = nrow(r4)) %>% as.data.frame()
  r4 <- cbind(vec, r4)
  names(r4)[1] <- "Timeframe"
  names(r4)[4] <- "NO2_Concentration"
  r5 <- raster(paste0("./China_NO2_Comparison/", (e))) %>% flip(direction='y')
  r5 <- crop(r5, extent(China.shp))
  mask(r5, China.shp)
  r5 <- r5 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Nov2020-Jan2021", length.out = nrow(r5)) %>% as.data.frame()
  r5 <- cbind(vec, r5)
  names(r5)[1] <- "Timeframe"
  names(r5)[4] <- "NO2_Concentration"
  r6 <- raster(paste0("./China_NO2_Comparison/", (f))) %>% flip(direction='y')
  r6 <- crop(r6, extent(China.shp))
  mask(r6, China.shp)
  r6 <- r6 %>% rasterToPoints() %>% data.frame()
  vec <- rep("Jan-March 2021", length.out = nrow(r6)) %>% as.data.frame()
  r6 <- cbind(vec, r6)
  names(r6)[1] <- "Timeframe"
  names(r6)[4] <- "NO2_Concentration"
  df <- rbind(r1, r2, r3, r4, r5, r6)
  ggplot(data = df, aes(x=Timeframe, y=NO2_Concentration, fill=Timeframe)) + 
    geom_violin(fill="gray") +
    ggtitle('China NO2: 2019 Seasonal Change') +
    ylab('NO2 Concentration (mol/m^2)') + xlab('Timeframe') +
    theme(axis.text.x = element_text(angle = 45)) +
    scale_x_discrete(limits=c("Nov2018-Jan2019", "Jan-March 2019", "Nov2019-Jan2020", "Jan-March 2020", "Nov2020-Jan2021", "Jan-March 2021")) +
    stat_summary(fun.data=mean_sdl, fun.args = list(mult = 2), geom="pointrange", color="red")
}
China_violin("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif", "China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif", "China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")
```

####China time analysis (boxplots).
```{r, eval = TRUE}
China_2019_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2: 2019 Seasonal Change', 
          ylab='Date',
          names = c('Nov2018-Jan2019', 'Jan-March 2019'))
}
China_2019_change("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif")

China_2020_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('Nov2019-Jan2020', 'Jan-March 2020'))
}
China_2020_change("China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif")

China_2021_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2: 2021 Seasonal Change', 
          ylab='Date',
          names = c('Nov2020-Jan2021', 'jan-March 2021'))
}
China_2021_change("China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")
```
