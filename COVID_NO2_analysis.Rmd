---
title: "NO2 and COVID-19"
author: "Alana Schreibman"
date: "5/27/2021"
output: 
  html_document:
    toc: true
    toc_float: 
        collapsed: true
        smooth_scroll: true
    depth: 3 
    theme: cosmo
    highlight: pygments
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r, eval = TRUE}
library(raster)
library(maptools)
library(dplyr)
library(sp)
library(sf)
library(rgdal)
#Reading in US data from Earth Engine. 
test <- raster('download.NO2_column_number_density.tif')
rectangle <- rasterToPoints(test) %>%
  as.data.frame() 
names(rectangle)[3] <- "NO2_Concentration"
rectangle

#Reading in shapefile and filtering for US only.
data(wrld_simpl)
plot(wrld_simpl) 
us.shp <- wrld_simpl[wrld_simpl$NAME=="United States", ]
us.shp
plot(us.shp)

class(test)
head(test)
dim(test)
plot(test)
plot(wrld_simpl[wrld_simpl$NAME=="United States", ], add = TRUE)
str(test)

#Extracting mean NO2 values for US and adding 
r.vals <- raster::extract(test, us.shp)
r.mean <- lapply(r.vals, FUN=mean)
us.shp@data <- data.frame(us.shp@data, "meanNO2" = r.mean) %>%
  rename(meanNO2 = X6.6934885908035e.05, location = NAME) 
head(us.shp)

#trying w second shapefile
r.vals <- raster::extract(test, continental.us)
r.mean <- lapply(r.vals, FUN=mean)
us.shp@data <- data.frame(us.shp@data, "meanNO2" = r.mean) %>%
  rename(meanNO2 = X6.6934885908035e.05, location = NAME) 
head(us.shp)

#Converting US raster data to data frame.
US.area <- as.data.frame(r.vals, col.names = "NO2_Concentration")
inner_join(rectangle, US.area, by = "NO2_Concentration") %>%
  arrange(x)
test.df <- test.df %>% select(c(x, y))
write.csv(test.df,"C:\\Users\\alanaschreibman\\US_lon_lat.csv", row.names = FALSE)

#Merged geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
covid.NO2 <- merge(owid.filtered, us.shp, by = "location")

#next: look at EPA data to compare (posibly average over counties?)
#get lat/lon w NO2 and perform correlation test (that way no need to convert)
  #need to get EPA data w longitude and latitude points

```

```{r, eval = TRUE}
#Reading in US data from Earth Engine: attemtping version from cloud storage. 
test2 <- raster('NO2_world.tif')
str(test2)
vals.df <- rasterToPoints(test2) %>%
  as.data.frame()
vals.df
class(test)
head(test)
tail(test)
dim(test)
plot(test2)
plot(wrld_simpl, add = TRUE)
ggplot() +
  geom_raster(data = test2, aes(fill = NO2_column_density))
plot(wrld_simpl[wrld_simpl$NAME=="United States", ], add = TRUE)
str(test)


install.packages("curl")
library(curl)
cd~
touch
echo "machine urs.earthdata.nasa.gov login <uid> password <password>" >> .netrc
```

