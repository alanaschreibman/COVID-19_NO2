---
title: "NO2 and COVID-19"
author: "Alana Schreibman"
date: "5/27/2021"
output: 
  html_document:
    toc: true
    toc_float: 
        collapsed: true
        smooth_scroll: true
    depth: 3 
    theme: cosmo
    highlight: pygments
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r, eval = TRUE}
#Load libraries needed. 
library(easypackages)
libraries("rgdal", "gdalUtils", "raster", "maptools", "ggplot2", "cowplot", "dplyr", "sp", "sf", "rgdal", "stringr")
install.packages(c("rgeos", "sf", "sp"), type = "source")
install.packages("rgdal", type = "source",
                 configure.args = c("--with-proj-include=/usr/local/include",
                                    "--with-proj-lib=/usr/local/lib"))
library(rgdal) ## confirm the GDAL version being used
```

###Merging NO2 data with COVID data for analysis.  
####United States data.  
```{r, eval = TRUE}
#Reading in US data from Earth Engine. 
continental.US.NO2.r <- raster('continental_us.tif') %>%
  flip(direction='y')
plot(continental.US.NO2.r)

#Reading in shapefile and filtering for US only.
data(wrld_simpl)
wrld_simpl@data[["NAME"]]
plot(wrld_simpl) 
us.shp <- wrld_simpl[wrld_simpl$NAME=="United States", ]
plot(us.shp)

wrld_simpl[wrld_simpl$NAME=="Israel", ]

#More exploration on raster NO2 file. 
head(continental.US.NO2.r)
dim(continental.US.NO2.r)
plot(continental.US.NO2.r)
plot(wrld_simpl[wrld_simpl$NAME=="United States", ], add = TRUE)
str(continental.US.NO2.r)

#Extracting mean NO2 values for US and adding to coordinates data to make final data frame.
r.vals <- raster::extract(continental.US.NO2.r, us.shp)
r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
final.df <- data.frame(us.shp@data, r.mean)  
rm(r.mean, r.vals)
names(final.df)[12] <- "NO2_Concentration"
names(final.df)[5] <- "location"
head(final.df)

#Merged geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
covid.NO2 <- merge(owid.filtered, final.df, by = "location")
```

####Formatting data for selected 10 countries. 
```{r, eval = TRUE}
#Reading in US data from Earth Engine. 
UnitedStates.NO2.r <- raster('./COVID_comparison/United States_NO2.tif') %>%
  flip(direction='y')
China.NO2.r <- raster('./COVID_comparison/China_NO2.tif') %>%
  flip(direction='y')
India.NO2.r <- raster('./COVID_comparison/India_NO2.tif') %>%
  flip(direction='y')
Italy.NO2.r <- raster('./COVID_comparison/Italy_NO2.tif') %>%
  flip(direction='y')
Brazil.NO2.r <- raster('./COVID_comparison/Brazil_NO2.tif') %>%
  flip(direction='y')
Peru.NO2.r <- raster('./COVID_comparison/Peru_NO2.tif') %>%
  flip(direction='y')
Israel.NO2.r <- raster('./COVID_comparison/Israel_NO2.tif') %>%
  flip(direction='y')
Argentina.NO2.r <- raster('./COVID_comparison/Argentina_NO2.tif') %>%
  flip(direction='y')
Russia.NO2.r <- raster('./COVID_comparison/Russia_NO2.tif') %>%
  flip(direction='y')
UnitedKingdom.NO2.r <- raster('./COVID_comparison/United Kingdom_NO2.tif') %>%
  flip(direction='y')
plot(Russia.NO2.r)
plot(Russia.shp, add = TRUE)
head(Russia.NO2.r)

#Shapefiles for 10 countries with high COVID cases. 
countries.shp.fxn <- function(x) {
  wrld_simpl[wrld_simpl$NAME==x, ]
}
for(i in c("United States", "China", "India", "Italy", "Brazil", "Peru", "Israel", "Argentina", "Russia", "United Kingdom")) {  
  assign(paste0(i, ".shp"), countries.shp.fxn(i)) 
}

#Extracting mean NO2 values and adding to coordinates data to make final data frame. Then, merge geospatial data set with COVID data (variables come from COVID exploratory analysis RMD file). 
mean.NO2.fxn <- function(raster, shp, country) {
  r.vals <- raster::extract(raster, shp)
  r.mean <- lapply(r.vals, FUN=mean, na.rm = TRUE)
  final.df <- data.frame(shp@data, r.mean)  
  names(final.df)[12] <- "NO2_Concentration" #Average NO2 concentration in mol/m^2 from July 10 2018 to July 10 2019. 
  names(final.df)[5] <- "location"
  final.df <- merge(owid.filtered, final.df, by = "location")
  assign(paste0(country, ".df"), final.df, .GlobalEnv)
}
mean.NO2.fxn(UnitedStates.NO2.r, `United States.shp`, "UnitedStates")
mean.NO2.fxn(China.NO2.r, `China.shp`, "China")
mean.NO2.fxn(India.NO2.r, `India.shp`, "India")
mean.NO2.fxn(Italy.NO2.r, `Italy.shp`, "Italy")
mean.NO2.fxn(Brazil.NO2.r, `Brazil.shp`, "Brazil")
mean.NO2.fxn(Peru.NO2.r, `Peru.shp`, "Peru")
mean.NO2.fxn(Israel.NO2.r, `Israel.shp`, "Israel")
mean.NO2.fxn(Argentina.NO2.r, `Argentina.shp`, "Argentina")
mean.NO2.fxn(Russia.NO2.r, `Russia.shp`, "Russia")
mean.NO2.fxn(UnitedKingdom.NO2.r, `United Kingdom.shp`, "UnitedKingdom")

COVID_NO2.df <- Reduce(function(...) merge(..., all=TRUE), list(UnitedStates.df, China.df, India.df, Italy.df, Brazil.df, Peru.df, Israel.df, Argentina.df, Russia.df, UnitedKingdom.df)) #Joins rows into one data frame. 

#Fix for loop later. 
for(i in c("UnitedStates.NO2.r", "China.NO2.r", "India.NO2.r", "Italy.NO2.r", "Brazil.NO2.r", "Peru.NO2.r", "Israel.NO2.r", "Argentina.NO2.r", "Russia.NO2.r", "UnitedKingdom.NO2.r")) { 
  for(j in c("United States.shp", "China.shp", "India.shp", "Italy.shp", "Brazil.shp", "Peru.shp", "Israel.shp", "Argentina.shp", "Russia.shp", "United Kingdom.shp")) {
    for (k in c("UnitedStates", "China", "India", "Italy", "Brazil", "Peru", "Israel", "Argentina", "Russia", "UnitedKingdom")) {
    print(mean.NO2.fxn(i, j, k))
    }
  }
}
```

####Analysis for selected 10 countries. 
```{r, eval = TRUE}
#NO2 concentration vs COVID cases. 
ggplot(data = COVID_NO2.df, aes(x = NO2_Concentration, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. NO2 Concentration") 
cor(COVID_NO2.df$totcases.mil, COVID_NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totcases.mil ~ NO2_Concentration + gdp.cap + pop.density + med.age, data = COVID_NO2.df)
summary.lm(NO2.lm.cases) #Summary statistics for linear fit. 

#NO2 concentration vs COVID deaths. 
ggplot(data = COVID_NO2.df, aes(x = NO2_Concentration, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "NO2 Concentration (mol/m^2)", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. NO2 Concentration") 
cor(COVID_NO2.df$totdeaths.mil, COVID_NO2.df$NO2_Concentration, use = "complete.obs") 
NO2.lm.cases <- lm(totdeaths.mil ~ NO2_Concentration + gdp.cap  + pop.density + med.age, data = COVID_NO2.df)
summary.lm(NO2.lm.cases) #Summary statistics for linear fit. 

#look at correlations w other country characteristics 
```

###Creating mosaic of half-world raster files. 
```{r, eval = TRUE}
setwd("./World_Rasters")
a <- c('Left_Half_World_NO2_2021_06_21_15_47_59.tif', 'Right_Half_World_NO2_2021_06_21_15_55_57.tif')
e <- extent(-180, 180, -90, 90)
template <- raster(e)
proj4string(template) <- CRS("+init=epsg:4269")
writeRaster(template, file="World_NO2.tif", format="GTiff")
mosaic_rasters(gdalfile=a,dst_dataset="World_NO2.tif",of="GTiff")
gdalinfo("World_NO2.tif")
gdal_setInstallation(ignore.full_scan=FALSE)
```

```{r, eval = TRUE}
setwd("./World_Rasters")
left <- raster('Left_Half_World_NO2_2021_06_21_15_47_59.tif') %>%
  flip(direction='y') 
right <- raster('Right_Half_World_NO2_2021_06_21_15_55_57.tif') %>%
  flip(direction='y') 
x <- list(left, right)
names(x)[1:2] <- c('x', 'y')
x$fun <- mean
x$na.rm <- TRUE

world.NO2.r <- do.call(mosaic, x)
plot(world.NO2.r)
plot(wrld_simpl, add = TRUE)
rm(left, right)
```

###Reading in world satellite data. 
```{r, eval = TRUE}
#Reading in US data from Earth Engine: attempt at world file unsuccessful (too large?). 
world.NO2.r <- raster('./World_Rasters/World_NO2.tif') %>%
  flip(direction='y')
str(world.NO2.r)
world.NO2.df <- rasterToPoints(world.NO2) %>%
  as.data.frame()
world.NO2.df
wrld_simpl

#Direct conversion from NO2 raster to data frame while filtering by shapefile. 
world.fxn <- function(x) {
  r1 <- raster(x) %>% flip(dilection='y')
  r1 <- crop(r1, extent(wrld_simpl))
  r1 <- mask(r1, wrld_simpl)
  r1 <- rasterToPoints(r1, spatial = TRUE) 
  world.sat <- data.frame(r1) %>% 
      select(!("optional")) 
  assign("world.sat", world.sat, .GlobalEnv)
  world.sat
}  #Final satellite data to use for comparison to EPA data. 
world.fxn("NO2_world_earthengine_2021_06_18_13_30_49.tif")

names(world.NO2.r)
class(world.NO2.r)
head(world.NO2.r)
tail(world.NO2.r)
dim(world.NO2.r)
plot(world.NO2.r) #not showing all data points expected
plot(wrld_simpl, add = TRUE)
```

###Reading in continent satellite data. 
```{r, eval = TRUE}
#Reading in North America data from Earth Engine.
NorthAmerica.NO2.r <- raster('NO2_NorthAmerica.tif') %>%
  flip(direction='y')
str(world.NO2.r)
NorthAmerica.NO2.df <- rasterToPoints(NorthAmerica.NO2.r) %>%
  as.data.frame()
NorthAmerica.NO2.df

#Direct conversion from NO2 raster to data frame while filtering by shapefile. 
NAmerica.fxn <- function(x) {
  r1 <- raster(x) %>% flip(dilection='y')
  r1 <- crop(r1, extent(wrld_simpl))
  r1 <- mask(r1, wrld_simpl)
  r1 <- rasterToPoints(r1, spatial = TRUE) 
  world.sat <- data.frame(r1) %>% 
      select(!("optional")) 
  assign("world.sat", world.sat, .GlobalEnv)
  world.sat
}  #Final satellite data to use for comparison to EPA data. 
world.fxn("NO2_world_earthengine_2021_06_18_13_30_49.tif")

head(NorthAmerica.NO2.r)
tail(NorthAmerica.NO2.r)
dim(NorthAmerica.NO2.r)
plot(NorthAmerica.NO2.r) #not showing all data points expected
plot(wrld_simpl, add = TRUE)
```

###Correlation analysis: United States, satellite vs. ground EPA. 
####Formatting sattelite and ground data. 
```{r, eval = TRUE}
#Getting satellite data specifically for this time frame. 
July_Oct2018.sat.r <- raster('US_NO2_2018-07-01_start.tif') %>%
  flip(direction='y')
July_Oct2018.sat.r <- crop(July_Oct2018.sat.r, extent(us.shp))
July_Oct2018.sat.r <- mask(July_Oct2018.sat.r, us.shp)

#Direct conversion from NO2 raster to data frame while filtering by shapefile. 
continental.US.fxn <- function(x) {
  r1 <- raster(x) %>% flip(direction='y')
  r1 <- crop(r1, extent(us.shp))
  r1 <- mask(r1, us.shp)
  r1 <- rasterToPoints(r1, spatial = TRUE) 
  July_Oct2018.sat <- data.frame(r1) %>% 
      select(!("optional")) %>%
      select( "y", "x", "US_NO2_2018.07.01_start")
  July_Oct2018.sat <- rename(July_Oct2018.sat, Latitude = y, Longitude = x, NO2_concentration = US_NO2_2018.07.01_start)
  assign("July_Oct2018.sat", July_Oct2018.sat, .GlobalEnv)
  July_Oct2018.sat
}  #Final satellite data to use for comparison to EPA data. 
continental.US.fxn("US_NO2_2018-07-01_start.tif")

#Selecting just latitude and longitude from data frame just made to use with Pargasite retrieval. 
US.lat.lon <- July_Oct2018.sat %>% select(c(Latitude, Longitude))
write.csv(US.lat.lon, file.path("US_ground_NO2", "US_lat_lon.csv"), row.names = FALSE) #Used to gather EPA data from Pargasite. 

#Reading in EPA data
#Problem w Pargasite: only overlapping time frame is July 2018 - October 2018 (Pargasite stops working in November 2018)
July_Oct2018.ground <- read.csv(file = './US_ground_NO2/July_Oct2018NO2.csv') %>% select(c("Latitude", "Longitude", "no2_estimate")) %>% rename(NO2_concentration = no2_estimate)
July_Oct2018.ground <- data.frame(July_Oct2018.ground)
July_Oct2018.ground #Final EPA data to use in comparison to satellite data. 

#EPA data frame changed to raster format.
July_Oct2018.ground.r <- July_Oct2018.ground %>% select(c("Longitude", "Latitude", "NO2_concentration")) %>% rasterFromXYZ() 
```

####Checking for satellite data correlation to ground data.
```{r, eval = TRUE}
#Resampling raster data to be same size for comparisons. 
July_Oct2018.sat.r.re <- July_Oct2018.sat.r %>% resample(July_Oct2018.ground.r)
plot(July_Oct2018.sat.r.re)

#Perform correlation test between satellite and ground rasters. 
cor(values(July_Oct2018.sat.r.re),
    values(July_Oct2018.ground.r),
    use = "na.or.complete")

#Linear model estimation. 
lm1 <- lm(values(July_Oct2018.sat.r.re) ~ values(July_Oct2018.ground.r))
summary(lm1)

#Local correlation estimates--shows where locally on map specific regions are positively or negatively correlated. (Getting an error: code from this website https://statnmap.com/2018-01-27-spatial-correlation-between-rasters/)
values(July_Oct2018.sat.r.re) <- 1:ncell(July_Oct2018.sat.r.re)

matrix_ground <- values(July_Oct2018.ground.r)

focal_cor <- focal(
  x = July_Oct2018.sat.r.re,
  w = matrix(1, 5, 5),
  # fun = function(x, y = temp_chl_s){ # Original
    # cor(values(y)[x, 1], values(y)[x, 2], # Original
        # use = "na.or.complete")
  # },
  fun = function(x, y = matrix_ground){ # [MW]
    cor(y[x, 1], y[x, 2], # [MW]
        use = "na.or.complete")
  },
  filename = file.path("focal_cor.tif"),
  overwrite = TRUE
)
```

####Plotting satellite vs ground data. 
```{r, eval = TRUE}
ggplot() +
    geom_raster(data = July_Oct2018.sat, aes(x = Longitude, y = Latitude, fill = NO2_concentration)) +
    scale_fill_viridis_c() +
    ggtitle("NO2 US Satellite Data, July-Oct 2018") + 
    labs(fill = "NO2 Concentration \n(mol/m^2)") +
    coord_quickmap()

ggplot() +
    geom_raster(data = July_Oct2018.ground, aes(x = Longitude, y = Latitude, fill = NO2_concentration)) +
    scale_fill_viridis_c() +
    ggtitle("NO2 US EPA Ground Data, July-Oct 2018") + 
    labs(fill = "NO2 Concentration \n(ppb)") +
    coord_quickmap()
```

###Correlation analysis: China, satellite vs. ground data. 
####Formatting sattelite and ground data to be used for correlation analysis (China only). 
```{r, eval = TRUE}
#No success in retrieving data so far. 

#Getting satellite data specifically for this time frame. 
July_Oct2018.sat.r <- raster('July2018-Oct2018.tif') %>%
  flip(direction='y')
July_Oct2018.sat.r <- crop(July_Oct2018.sat.r, extent(us.shp))
July_Oct2018.sat.r <- mask(July_Oct2018.sat.r, us.shp)
plot(July_Oct2018.sat.r)
plot(us.shp, add = TRUE)
```

###Time-analysis: NO2 changes during the COVID-19 pandemic.
####US time analysis plots. 
```{r, eval = TRUE}
#Converting before lockdown and after lockdown rasters for US to data frames.  
before.lockdown <- raster('./US_NO2_comparison/US_NO2_2020-01-19_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
before.lockdown <- before.lockdown %>%
  rename(c(NO2_concentration = US_NO2_2020.01.19_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

after.lockdown <- raster('./US_NO2_comparison/US_NO2_2020-03-19_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
after.lockdown <- after.lockdown %>%
  rename(c(NO2_concentration = US_NO2_2020.03.19_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

#Plotting before and after maps. 
p1 <- ggplot() +
  geom_raster(data = before.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = us.shp, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap(
    xlim = c(-123, -65),
    ylim = c(23, 49)
  ) + 
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.00015)) +
  ggtitle("US NO2 Concentrations (Sentinel Satellite) Before COVID-19 Lockdown")
  
p2 <- ggplot() +
  geom_raster(data = after.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = us.shp, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap(
    xlim = c(-123, -65),
    ylim = c(23, 49)
  ) + 
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.00015)) +
  ggtitle("US NO2 Concentrations (Sentinel Satellite) After COVID-19 Lockdown")

plot_grid(p1, p2, labels = "AUTO", ncol = 1)
rm(p1, p2)
```

###US time analysis.
```{r, eval = TRUE}
#Function for finding medians over each time period. 
US_NO2_median <- function(x) {
  r <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, us.shp)
  lapply(r.vals, FUN=median, na.rm = TRUE)
}
US_NO2_median("US_NO2_2020-01-19_start.tif")
US_NO2_median("US_NO2_2020-03-19_start.tif")

#Function for finding averages over each time period. 
US_NO2_average <- function(x) {
  r <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, us.shp)
  lapply(r.vals, FUN=mean, na.rm = TRUE)
}
US_NO2_average("US_NO2_2020-01-19_start.tif")
US_NO2_average("US_NO2_2020-03-19_start.tif")

#Boxplots: not sure why post-COVID is higher median in each case. Need to adjust for degrees of urbanization? 
US_2019_change <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(us.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(us.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2: 2019 Seasonal Change', 
          ylab='Date',
          names = c('2019 Jan-Mar', '2019 Mar-May'))
}
US_2019_change("US_NO2_2019-01-19_start.tif", "US_NO2_2019-03-19_start.tif")

US_2020_change <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(us.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(us.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('2020 Jan-Mar', '2020 Mar-May'))
}
US_2020_change("US_NO2_2020-01-19_start.tif", "US_NO2_2020-03-19_start.tif")

US_2021_change <- function(x, y) {
  r1 <- raster(paste0("./US_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(us.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./US_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(us.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='US NO2: 2021 Seasonal Change', 
          ylab='Date',
          names = c('2021 Jan-Mar', '2021 Mar-May'))
}
US_2021_change("US_NO2_2021-01-19_start.tif", "US_NO2_2021-03-19_start.tif")
```

####China time analysis plots. 
```{r, eval = TRUE}
China.shp <- wrld_simpl[wrld_simpl$NAME=="China", ]

#Converting before lockdown and after lockdown rasters for US to data frames.  
before.lockdown <- raster('./China_NO2_comparison/China_NO2_2019-11-23_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
before.lockdown <- before.lockdown %>%
  rename(c(NO2_concentration = China_NO2_2019.11.23_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

after.lockdown <- raster('./China_NO2_comparison/China_NO2_2020-01-23_start.tif') %>%
  flip(direction='y') %>%
  rasterToPoints(spatial = TRUE) %>%
  data.frame() 
after.lockdown <- after.lockdown %>%
  rename(c(NO2_concentration = China_NO2_2020.01.23_start, Longitude = x, Latitude = y)) %>%
  select(c("Latitude", "Longitude", "NO2_concentration"))

#Plotting before and after maps. 
p1 <- ggplot() +
  geom_raster(data = before.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = China.shp, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap() +
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.0005)) +
  ggtitle("China NO2 Concentrations (Sentinel Satellite) Before COVID-19 Lockdown")
  
p2 <- ggplot() +
  geom_raster(data = after.lockdown , aes(x = Longitude, y = Latitude, fill = NO2_concentration)) + 
  geom_polygon(data = China.shp, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  coord_quickmap() +
  labs(fill = "NO2 Concentration \n(mol/m^2)") +
  scale_fill_viridis_c(limits = c(0, 0.0005)) +
  ggtitle("China NO2 Concentrations (Sentinel Satellite) After COVID-19 Lockdown")

plot_grid(p1, p2, labels = "AUTO", ncol = 1)
rm(p1, p2)
```

###China time analysis.
```{r, eval = TRUE}
#Function for finding medians over each time period. 
China_NO2_median <- function(x) {
  r <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, China.shp)
  lapply(r.vals, FUN=median, na.rm = TRUE)
}
China_NO2_median("China_NO2_2019-11-23_start.tif")
China_NO2_median("China_NO2_2020-01-23_start.tif")

#Function for finding averages over each time period. 
China_NO2_average <- function(x) {
  r <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r.vals <- raster::extract(r, China.shp)
  lapply(r.vals, FUN=mean, na.rm = TRUE)
}
China_NO2_average("China_NO2_2019-11-23_start.tif")
China_NO2_average("China_NO2_2020-01-23_start.tif") 

#Boxplots: not sure why post-COVID is higher median in each case. Need to adjust for degrees of urbanization? 
China_2019_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2: 2019 Seasonal Change', 
          ylab='Date',
          names = c('Nov2018-Jan2019', 'Jan-March 2019'))
}
China_2019_change("China_NO2_2018-11-23_start.tif", "China_NO2_2019-01-23_start.tif")

China_2020_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2 Before and After COVID-19', 
          ylab='Date',
          names = c('Nov2019-Jan2020', 'Jan-March 2020'))
}
China_2020_change("China_NO2_2019-11-23_start.tif", "China_NO2_2020-01-23_start.tif")

China_2021_change <- function(x, y) {
  r1 <- raster(paste0("./China_NO2_Comparison/", (x))) %>% flip(direction='y')
  r1 <- crop(r1, extent(China.shp))
  mask(r1, us.shp)
  r2 <- raster(paste0("./China_NO2_Comparison/", (y))) %>% flip(direction='y')
  r2 <- crop(r2, extent(China.shp))
  mask(r2, us.shp)
  s <- stack(r1, r2)
  boxplot(s, col=c('red', 'blue'), 
          main='China NO2: 2021 Seasonal Change', 
          ylab='Date',
          names = c('Nov2020-Jan2021', 'jan-March 2021'))
}
China_2021_change("China_NO2_2020-11-23_start.tif", "China_NO2_2021-01-23_start.tif")
```
